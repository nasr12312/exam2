<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منشئ الامتحانات الذكي المتطور</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Advanced PDF and Image Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/0.2.6/dom-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- Print.js for advanced printing -->
    <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://printjs-4de6.kxcdn.com/print.min.css">
    
    <!-- Puppeteer alternative - html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700&family=Almarai:wght@300;400;700&display=swap');
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .preview-container {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .page-preview {
            background: white;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px auto;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            min-height: 600px;
            position: relative;
        }

        /* Page break indicators - only for screen preview */
        .page-break-indicator {
            position: relative;
            margin: 30px 0;
            border-top: 2px dashed #ef4444;
            text-align: center;
            display: block;
        }

        .page-break-indicator::before {
            content: "فاصل الصفحة - الصفحة التالية تبدأ من هنا";
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #fef2f2;
            color: #dc2626;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            border: 1px solid #fecaca;
            white-space: nowrap;
            z-index: 10;
        }

        /* Hide page break indicators completely when capturing images */
        .capturing-images .page-break-indicator {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
        }

        .capturing-images .page-break-indicator::before {
            display: none !important;
            content: none !important;
        }

        @media print {
            .page-break-indicator {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
            }
            
            .page-break-indicator::before {
                display: none !important;
                content: none !important;
            }
        }

        /* Page height simulation */
        .page-section {
            min-height: 800px;
            position: relative;
        }

        .page-section:not(:last-child)::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: -30px;
            right: -30px;
            height: 2px;
            background: linear-gradient(to right, transparent, #ef4444, transparent);
        }
        
        .question-container {
            margin-bottom: 20px;
            padding: 0;
            border-radius: 0;
            background: transparent;
            page-break-inside: avoid;
        }
        
        .question-with-frame {
            border: 2px solid #e5e7eb;
            padding: 15px;
            border-radius: 8px;
            background: white;
        }
        
        .mcq-options .option-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            padding: 2px 0;
            border-radius: 0;
            background: transparent;
        }
        
        .answer-line {
            height: 30px;
            border-bottom: 1px solid #9ca3af;
            margin-bottom: 6px;
        }
        
        .question-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: #f9fafb;
            transition: all 0.3s ease;
        }
        
        .question-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .options-horizontal {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .options-vertical {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .options-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .options-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        /* Compact header styles */
        .exam-header {
            padding: 15px;
            margin-bottom: 20px;
        }

        .exam-header h1 {
            font-size: 20px !important;
            margin-bottom: 10px !important;
        }

        .exam-header .header-info {
            font-size: 12px !important;
            padding: 10px;
        }

        .exam-header .student-info {
            font-size: 11px !important;
            margin-top: 10px;
        }

        .exam-header .logo-container img {
            max-height: 50px !important;
            max-width: 80px !important;
        }

        /* Question section headers */
        .section-header {
            background: #f3f4f6;
            padding: 8px 15px;
            margin: 20px 0 15px 0;
            border-right: 4px solid #3b82f6;
            font-weight: bold;
            font-size: 16px;
            color: #1f2937;
        }

        /* Answer marking styles */
        .answer-mark {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #374151;
            margin-left: 8px;
            text-align: center;
            line-height: 16px;
            font-weight: bold;
            font-size: 12px;
        }

        .answer-mark.circle {
            border-radius: 50%;
        }

        .answer-mark.square {
            border-radius: 2px;
        }

        @media print {
            .page-preview {
                box-shadow: none;
                margin: 0;
                padding: 15px;
            }
            
            .question-container {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .no-print {
                display: none !important;
            }

            .exam-header {
                padding: 10px;
            }

            .section-header {
                margin: 15px 0 10px 0;
                padding: 6px 12px;
            }
        }

        .logo-preview {
            max-width: 80px;
            max-height: 60px;
            object-fit: contain;
            border: 2px dashed #d1d5db;
            padding: 4px;
            border-radius: 4px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .status-connected {
            background-color: #10b981;
        }

        .status-disconnected {
            background-color: #ef4444;
        }

        .status-connecting {
            background-color: #f59e0b;
            animation: pulse 2s infinite;
        }

        /* Drag and Drop Styles */
        .draggable {
            transition: all 0.3s ease;
            cursor: move;
        }

        .draggable:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .draggable.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .drag-handle {
            transition: color 0.2s ease;
        }

        .drag-handle:hover {
            color: #3b82f6 !important;
        }

        /* Editable Elements */
        .editable-text {
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 2px 4px;
        }

        .editable-text:hover {
            background-color: #f3f4f6 !important;
            border: 1px dashed #9ca3af;
        }

        .editable-marks {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .editable-marks:hover {
            background-color: #dcfce7 !important;
            transform: scale(1.05);
        }

        .editable-section-title {
            transition: all 0.2s ease;
            position: relative;
            padding: 8px 15px;
            border-radius: 8px;
        }

        .editable-section-title:hover {
            background-color: #f8fafc !important;
            border: 2px dashed #3b82f6;
        }

        .editable-section-title:hover::after {
            content: "انقر للتعديل";
            position: absolute;
            top: -25px;
            right: 10px;
            background: #1f2937;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 1000;
        }

        /* Question Item Enhancements */
        .question-item {
            position: relative;
            overflow: hidden;
        }

        .question-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .question-item:hover::before {
            opacity: 1;
        }

        /* Button Enhancements */
        .question-item button {
            transition: all 0.2s ease;
            border-radius: 6px;
            padding: 6px;
        }

        .question-item button:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Animation for new questions */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .question-item.new-question {
            animation: slideInRight 0.5s ease-out;
        }

        /* Improved hover effects */
        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="bg-white bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-brain text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">منشئ الامتحانات الذكي المتطور</h1>
                        <p class="text-blue-100">أنشئ امتحانات احترافية بتنسيق متقدم</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 space-x-reverse">
                    <div id="aiStatus" class="flex items-center bg-white bg-opacity-20 px-3 py-2 rounded-full">
                        <div id="statusIndicator" class="w-3 h-3 rounded-full status-disconnected ml-2"></div>
                        <span id="statusText" class="text-sm">غير متصل</span>
                    </div>
                    <button onclick="testAIConnection()" class="bg-white bg-opacity-20 p-2 rounded-full hover:bg-opacity-30 transition-all" title="اختبار الاتصال">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <!-- Developer Info Dropdown -->
                    <div class="relative">
                        <button onclick="toggleDeveloperMenu()" class="bg-white bg-opacity-20 p-2 rounded-full hover:bg-opacity-30 transition-all" title="معلومات المطور">
                            <i class="fas fa-user-circle"></i>
                        </button>
                        <div id="developerMenu" class="hidden absolute left-0 mt-2 w-64 bg-white rounded-lg shadow-lg border z-50">
                            <div class="p-4">
                                <div class="text-center mb-3">
                                    <h3 class="font-bold text-gray-800">المطور</h3>
                                    <p class="text-sm text-gray-600">أ. عبد الرحمن نصر الله</p>
                                </div>
                                <div class="space-y-2">
                                    <a href="https://www.instagram.com/nasrallah_2002/" target="_blank" class="flex items-center p-2 rounded hover:bg-gray-100 transition-colors">
                                        <i class="fab fa-instagram text-pink-500 ml-2"></i>
                                        <span class="text-sm text-gray-700">حساب الإنستغرام</span>
                                    </a>
                                    <a href="https://www.youtube.com/@tnasrallah" target="_blank" class="flex items-center p-2 rounded hover:bg-gray-100 transition-colors">
                                        <i class="fab fa-youtube text-red-500 ml-2"></i>
                                        <span class="text-sm text-gray-700">قناة اليوتيوب</span>
                                    </a>
                                </div>
                                <div class="mt-3 pt-3 border-t text-center">
                                    <p class="text-xs text-gray-500">منشئ الامتحانات الذكي المتطور</p>
                                    <p class="text-xs text-gray-400">جميع الحقوق محفوظة © 2024</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Control Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <!-- Tabs -->
                    <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                        <button onclick="switchTab('basic')" id="tab-basic" class="flex-1 py-2 px-1 rounded-md text-xs font-medium transition-all tab-active">
                            <i class="fas fa-cog ml-1"></i>الأساسية
                        </button>
                        <button onclick="switchTab('questions')" id="tab-questions" class="flex-1 py-2 px-1 rounded-md text-xs font-medium transition-all">
                            <i class="fas fa-question ml-1"></i>الأسئلة
                        </button>
                        <button onclick="switchTab('format')" id="tab-format" class="flex-1 py-2 px-1 rounded-md text-xs font-medium transition-all">
                            <i class="fas fa-palette ml-1"></i>التنسيق
                        </button>
                        <button onclick="switchTab('ai')" id="tab-ai" class="flex-1 py-2 px-1 rounded-md text-xs font-medium transition-all">
                            <i class="fas fa-robot ml-1"></i>الذكاء الاصطناعي
                        </button>
                    </div>

                    <!-- Basic Settings Tab -->
                    <div id="basic-tab" class="space-y-6">
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">معلومات الامتحان</h3>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">عنوان الامتحان</label>
                                <input type="text" id="examTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="امتحان الرياضيات - الفصل الأول" value="امتحان الرياضيات - الفصل الأول">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المادة</label>
                                    <select id="subject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">اختر المادة</option>
                                        <option value="math" selected>الرياضيات</option>
                                        <option value="arabic">اللغة العربية</option>
                                        <option value="english">اللغة الإنجليزية</option>
                                        <option value="science">العلوم</option>
                                        <option value="history">التاريخ</option>
                                        <option value="physics">الفيزياء</option>
                                        <option value="chemistry">الكيمياء</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الصف</label>
                                    <select id="grade" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">اختر الصف</option>
                                        <option value="9" selected>التاسع</option>
                                        <option value="10">العاشر</option>
                                        <option value="11">الحادي عشر</option>
                                        <option value="12">الثاني عشر</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المدة (دقيقة)</label>
                                    <input type="number" id="duration" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="90" value="90">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الدرجة الكلية</label>
                                    <input type="number" id="totalMarks" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="100" value="100">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">اسم المعلم</label>
                                <input type="text" id="teacherName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="أ. محمد أحمد" value="أ. محمد أحمد">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">اسم المدرسة</label>
                                <input type="text" id="schoolName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="مدرسة النور الثانوية" value="مدرسة النور الثانوية">
                            </div>

                            <!-- School Logo Upload -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">شعار المدرسة</label>
                                <div class="space-y-3">
                                    <input type="file" id="schoolLogoFile" accept="image/*" onchange="handleLogoUpload()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <div id="logoPreview" class="hidden">
                                        <img id="logoImage" class="logo-preview mx-auto" alt="معاينة الشعار">
                                        <button onclick="removeLogo()" class="mt-2 text-red-600 text-sm hover:text-red-800">
                                            <i class="fas fa-trash ml-1"></i>إزالة الشعار
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">التاريخ</label>
                                <input type="date" id="examDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <div class="mt-2">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">تنسيق التاريخ</label>
                                    <select id="dateFormat" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                        <option value="arabic" selected>عربي (١٥ رمضان ١٤٤٥)</option>
                                        <option value="hijri">هجري (15/09/1445)</option>
                                        <option value="gregorian">ميلادي (15/04/2024)</option>
                                        <option value="both">كلاهما (15/04/2024 - 15/09/1445)</option>
                                        <option value="text">نصي (الخامس عشر من أبريل)</option>
                                    </select>
                                </div>
                            </div>

                            <button onclick="updatePreview()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                                <i class="fas fa-refresh ml-2"></i>تحديث المعاينة
                            </button>
                        </div>
                    </div>

                    <!-- Questions Tab -->
                    <div id="questions-tab" class="space-y-6 hidden">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">إنشاء سؤال جديد</h3>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">نوع السؤال</label>
                            <select id="questionType" onchange="toggleQuestionOptions()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="mcq">اختيار من متعدد</option>
                                <option value="true-false">صح أم خطأ</option>
                                <option value="short">إجابة قصيرة</option>
                                <option value="essay">مقالي</option>
                                <option value="fill">أكمل الفراغ</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">نص السؤال</label>
                            <textarea id="questionText" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="اكتب السؤال هنا..."></textarea>
                        </div>

                        <!-- Question Details -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-800 mb-3">تفاصيل إضافية للسؤال</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">مستوى الصعوبة</label>
                                    <select id="questionDifficulty" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="easy">سهل</option>
                                        <option value="medium" selected>متوسط</option>
                                        <option value="hard">صعب</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الموضوع/الوحدة</label>
                                    <input type="text" id="questionTopic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="مثال: الجبر، النحو، الخلايا...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الهدف التعليمي</label>
                                    <input type="text" id="questionObjective" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ما يجب أن يحققه الطالب من هذا السؤال">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الوقت المقترح (دقائق)</label>
                                    <input type="number" id="questionTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="5" min="1" max="60">
                                </div>
                            </div>
                        </div>

                        <!-- MCQ Options -->
                        <div id="mcqOptions" class="space-y-4">
                            <label class="block text-sm font-medium text-gray-700">الخيارات:</label>
                            <div id="mcqOptionsList" class="space-y-2">
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <input type="radio" name="correctMCQ" value="1" class="text-blue-600">
                                    <input type="text" id="option1" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="الخيار الأول">
                                </div>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <input type="radio" name="correctMCQ" value="2" class="text-blue-600">
                                    <input type="text" id="option2" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="الخيار الثاني">
                                </div>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <input type="radio" name="correctMCQ" value="3" class="text-blue-600">
                                    <input type="text" id="option3" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="الخيار الثالث">
                                </div>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <input type="radio" name="correctMCQ" value="4" class="text-blue-600">
                                    <input type="text" id="option4" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="الخيار الرابع">
                                </div>
                            </div>
                        </div>

                        <!-- True/False Options -->
                        <div id="trueFalseOptions" class="space-y-2 hidden">
                            <label class="block text-sm font-medium text-gray-700">الإجابة الصحيحة:</label>
                            <div class="flex items-center space-x-4 space-x-reverse">
                                <label class="flex items-center">
                                    <input type="radio" name="trueFalseAnswer" value="true" class="ml-2 text-blue-600">
                                    <span>صح</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="trueFalseAnswer" value="false" class="ml-2 text-blue-600">
                                    <span>خطأ</span>
                                </label>
                            </div>
                        </div>

                        <!-- Fill Options -->
                        <div id="fillOptions" class="space-y-2 hidden">
                            <label class="block text-sm font-medium text-gray-700">الإجابات المقبولة:</label>
                            <input type="text" id="fillAnswers" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="الإجابة الأولى، الإجابة الثانية">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الدرجة</label>
                            <input type="number" id="questionMarks" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="5" value="5">
                        </div>

                        <button onclick="addQuestion()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-4 rounded-md hover:from-blue-700 hover:to-indigo-700 transition-all">
                            <i class="fas fa-plus ml-2"></i>إضافة السؤال
                        </button>
                    </div>

                    <!-- Format Tab -->
                    <div id="format-tab" class="space-y-6 hidden">
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg border">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">تنسيق الامتحان المتقدم</h3>
                        </div>

                        <!-- Font and Layout -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">الخط والتخطيط</h4>
                            
                            <!-- Header Font Settings -->
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <h5 class="font-medium text-blue-800 mb-3">خط الترويسة</h5>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">نوع الخط</label>
                                        <select id="headerFontFamily" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                            <option value="Cairo">Cairo</option>
                                            <option value="Amiri">Amiri</option>
                                            <option value="Tajawal">Tajawal</option>
                                            <option value="Almarai">Almarai</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">حجم الخط: <span id="headerFontSizeLabel">كبير</span></label>
                                        <input type="range" id="headerFontSize" min="16" max="28" value="24" onchange="updateHeaderFontSize()" class="w-full">
                                    </div>
                                </div>
                            </div>

                            <!-- Question Font Settings -->
                            <div class="bg-green-50 p-3 rounded-lg">
                                <h5 class="font-medium text-green-800 mb-3">خط الأسئلة</h5>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">نوع الخط</label>
                                        <select id="questionFontFamily" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500">
                                            <option value="Cairo" selected>Cairo</option>
                                            <option value="Amiri">Amiri</option>
                                            <option value="Tajawal">Tajawal</option>
                                            <option value="Almarai">Almarai</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">حجم الخط: <span id="questionFontSizeLabel">متوسط</span></label>
                                        <input type="range" id="questionFontSize" min="14" max="22" value="18" onchange="updateQuestionFontSize()" class="w-full">
                                    </div>
                                </div>
                            </div>

                            <!-- Options Font Settings -->
                            <div class="bg-orange-50 p-3 rounded-lg">
                                <h5 class="font-medium text-orange-800 mb-3">خط الخيارات</h5>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">نوع الخط</label>
                                        <select id="optionFontFamily" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-orange-500">
                                            <option value="Cairo" selected>Cairo</option>
                                            <option value="Amiri">Amiri</option>
                                            <option value="Tajawal">Tajawal</option>
                                            <option value="Almarai">Almarai</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">حجم الخط: <span id="optionFontSizeLabel">متوسط</span></label>
                                        <input type="range" id="optionFontSize" min="12" max="20" value="16" onchange="updateOptionFontSize()" class="w-full">
                                    </div>
                                </div>
                            </div>

                            <!-- Section Headers Font Settings -->
                            <div class="bg-purple-50 p-3 rounded-lg">
                                <h5 class="font-medium text-purple-800 mb-3">خط عناوين الأقسام</h5>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">نوع الخط</label>
                                        <select id="sectionFontFamily" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-purple-500">
                                            <option value="Cairo" selected>Cairo</option>
                                            <option value="Amiri">Amiri</option>
                                            <option value="Tajawal">Tajawal</option>
                                            <option value="Almarai">Almarai</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">حجم الخط: <span id="sectionFontSizeLabel">متوسط</span></label>
                                        <input type="range" id="sectionFontSize" min="14" max="24" value="18" onchange="updateSectionFontSize()" class="w-full">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">لون الخلفية</label>
                                        <input type="color" id="sectionBgColor" value="#f3f4f6" onchange="updatePreview()" class="w-full h-8 rounded border">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">لون الحدود</label>
                                        <input type="color" id="sectionBorderColor" value="#3b82f6" onchange="updatePreview()" class="w-full h-8 rounded border">
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">نمط العنوان</label>
                                    <select id="sectionStyle" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                        <option value="modern" selected>عصري</option>
                                        <option value="classic">كلاسيكي</option>
                                        <option value="minimal">بسيط</option>
                                        <option value="bold">عريض</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Header Options -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">تنسيق الترويسة المتقدم</h4>
                            
                            <!-- Header Layout -->
                            <div class="bg-purple-50 p-3 rounded-lg">
                                <h5 class="font-medium text-purple-800 mb-3">تخطيط الترويسة</h5>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">نمط الترويسة</label>
                                        <select id="headerStyle" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                            <option value="classic">كلاسيكي</option>
                                            <option value="modern" selected>عصري</option>
                                            <option value="minimal">بسيط</option>
                                            <option value="formal">رسمي</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">لون الخلفية</label>
                                            <input type="color" id="headerBgColor" value="#f8fafc" onchange="updatePreview()" class="w-full h-8 rounded border">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">لون الحدود</label>
                                            <input type="color" id="headerBorderColor" value="#e5e7eb" onchange="updatePreview()" class="w-full h-8 rounded border">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Header Elements -->
                            <div class="bg-indigo-50 p-3 rounded-lg">
                                <h5 class="font-medium text-indigo-800 mb-3">عناصر الترويسة</h5>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showSubject" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">المادة</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showGrade" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">الصف</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showDuration" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">المدة</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showTotalMarks" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">الدرجة الكلية</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showTeacher" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">المعلم</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showSchool" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">المدرسة</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showDate" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">التاريخ</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showLogo" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">الشعار</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Logo Settings -->
                            <div class="bg-pink-50 p-3 rounded-lg">
                                <h5 class="font-medium text-pink-800 mb-3">إعدادات الشعار</h5>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">موضع الشعار</label>
                                        <select id="logoPosition" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                            <option value="center" selected>وسط</option>
                                            <option value="right">يمين</option>
                                            <option value="left">يسار</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">حجم الشعار: <span id="logoSizeLabel">متوسط</span></label>
                                            <input type="range" id="logoSize" min="40" max="120" value="80" onchange="updateLogoSize()" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">شكل الشعار</label>
                                            <select id="logoShape" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                                <option value="normal" selected>طبيعي</option>
                                                <option value="circle">دائري</option>
                                                <option value="rounded">زوايا مدورة</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer Settings -->
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <h5 class="font-medium text-gray-800 mb-3">إعدادات نهاية الامتحان</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showTeacherSignature" checked onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">توقيع المعلم</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showGoodLuck" checked onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">رسالة التوفيق</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Student Info Settings -->
                            <div class="bg-teal-50 p-3 rounded-lg">
                                <h5 class="font-medium text-teal-800 mb-3">معلومات الطالب</h5>
                                <div class="space-y-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="showStudentName" checked onchange="updatePreview()" class="ml-2 text-teal-600">
                                            <span class="text-sm">اسم الطالب</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="showStudentId" checked onchange="updatePreview()" class="ml-2 text-teal-600">
                                            <span class="text-sm">الرقم الجامعي</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="showStudentClass" onchange="updatePreview()" class="ml-2 text-teal-600">
                                            <span class="text-sm">الشعبة</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="showStudentSeat" onchange="updatePreview()" class="ml-2 text-teal-600">
                                            <span class="text-sm">رقم المقعد</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Question Formatting -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">تنسيق الأسئلة</h4>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ترقيم الأسئلة</label>
                                    <select id="questionNumbering" onchange="updatePreview()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="arabic">أرقام عربية (1، 2، 3)</option>
                                        <option value="letters">حروف (أ، ب، ج)</option>
                                        <option value="roman">أرقام رومانية (I، II، III)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">رموز الخيارات</label>
                                    <select id="optionSymbols" onchange="updatePreview()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="letters">حروف (أ، ب، ج، د)</option>
                                        <option value="numbers">أرقام (1، 2، 3، 4)</option>
                                        <option value="circles">دوائر (○)</option>
                                        <option value="empty">بدون رموز</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Question Styling -->
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <h5 class="font-medium text-gray-800 mb-3">تنسيق الأسئلة</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showQuestionFrames" onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">إطار حول الأسئلة</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showMarks" checked onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">إظهار درجات الأسئلة</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showInstructions" onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">تعليمات الامتحان</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="questionBold" checked onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">نص الأسئلة عريض</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Options Styling -->
                            <div class="bg-yellow-50 p-3 rounded-lg">
                                <h5 class="font-medium text-yellow-800 mb-3">تنسيق الخيارات</h5>
                                <div class="space-y-2">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">نمط الخيارات</label>
                                        <select id="optionStyle" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                            <option value="vertical" selected>عمودي</option>
                                            <option value="horizontal">أفقي</option>
                                            <option value="grid-2">شبكة (2 في كل سطر)</option>
                                            <option value="grid-4">شبكة (4 في كل سطر)</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">شكل الخانة</label>
                                            <select id="optionBoxStyle" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                                <option value="circle">دائرة</option>
                                                <option value="square">مربع</option>
                                                <option value="none">بدون خانة</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">حجم الخانة</label>
                                            <select id="optionBoxSize" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                                <option value="small">صغير</option>
                                                <option value="medium" selected>متوسط</option>
                                                <option value="large">كبير</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">نوع التمريز</label>
                                        <select id="answerMarkType" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                            <option value="numbers">أرقام فقط (1، 2، 3، 4)</option>
                                            <option value="arabic-letters" selected>حروف عربية فقط (أ، ب، ج، د)</option>
                                            <option value="english-letters">حروف إنجليزية فقط (A، B، C، D)</option>
                                            <option value="empty">فارغة للتمريز</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Question Organization -->
                            <div class="bg-indigo-50 p-3 rounded-lg">
                                <h5 class="font-medium text-indigo-800 mb-3">تنظيم الأسئلة</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="groupByType" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">تجميع الأسئلة حسب النوع</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showSectionHeaders" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">عناوين الأقسام</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showSectionInstructions" onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">تعليمات كل قسم</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Answer Spaces -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">مساحات الإجابة</h4>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الإجابة القصيرة</label>
                                    <select id="shortAnswerSpace" onchange="updatePreview()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="small">صغير (خط واحد)</option>
                                        <option value="medium" selected>متوسط (خطين)</option>
                                        <option value="large">كبير (ثلاثة خطوط)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المقالي: <span id="essayLinesLabel">5 خطوط</span></label>
                                    <input type="range" id="essayLines" min="3" max="15" value="5" onchange="updateEssayLines()" class="w-full">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Tab -->
                    <div id="ai-tab" class="space-y-6 hidden">
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">مولد الأسئلة بالذكاء الاصطناعي</h3>
                            <p class="text-sm text-gray-600">أنشئ أسئلة تلقائياً أو استخدم الذكاء الاصطناعي الخارجي</p>
                        </div>

                        <!-- Gemini AI Generator -->
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="font-bold text-purple-800 mb-3">
                                <i class="fas fa-brain ml-2"></i>مولد الأسئلة الذكي - Gemini AI
                            </h4>
                            <div class="bg-green-100 border border-green-300 rounded p-2 mb-3">
                                <p class="text-xs text-green-800">
                                    <i class="fas fa-check-circle ml-1"></i>
                                    متصل بـ Google Gemini AI لإنشاء أسئلة احترافية ومتنوعة
                                </p>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">موضوع الأسئلة</label>
                                        <input type="text" id="aiTopic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="مثال: الجبر، النحو، الخلايا...">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">عدد الأسئلة</label>
                                        <input type="number" id="aiQuestionCount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="5" min="1" max="20" value="5">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">مستوى الصعوبة</label>
                                    <select id="difficultyLevel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="easy">سهل</option>
                                        <option value="medium" selected>متوسط</option>
                                        <option value="hard">صعب</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">أنواع الأسئلة</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="aiMcq" checked class="ml-2 text-purple-600">
                                            <span class="text-sm">اختيار من متعدد</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="aiTrueFalse" class="ml-2 text-purple-600">
                                            <span class="text-sm">صح أم خطأ</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="aiShort" class="ml-2 text-purple-600">
                                            <span class="text-sm">إجابة قصيرة</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="aiFill" class="ml-2 text-purple-600">
                                            <span class="text-sm">أكمل الفراغ</span>
                                        </label>
                                    </div>
                                </div>

                                <button onclick="generateGeminiAI()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 px-4 rounded-md hover:from-purple-700 hover:to-indigo-700 transition-all">
                                    <i class="fas fa-magic ml-2"></i>إنشاء أسئلة بالذكاء الاصطناعي
                                </button>
                            </div>
                        </div>

                        <!-- External AI Generator (Offline) -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-bold text-blue-800 mb-3">
                                <i class="fas fa-robot ml-2"></i>مولد الأسئلة بالذكاء الخارجي
                            </h4>
                            <p class="text-sm text-blue-600 mb-4">استخدم ChatGPT أو Claude أو أي ذكاء اصطناعي آخر</p>
                            
                            <div class="space-y-4">
                                <!-- Step 1: Generate Prompt -->
                                <div class="bg-white p-3 rounded border">
                                    <h5 class="font-semibold text-blue-800 mb-3">الخطوة 1: إعداد الطلب</h5>
                                    
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">الموضوع</label>
                                            <input type="text" id="externalTopic" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md" placeholder="مثال: الجبر، النحو...">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">عدد الأسئلة</label>
                                            <input type="number" id="externalCount" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md" value="5" min="1" max="20">
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">المستوى</label>
                                            <select id="externalDifficulty" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                                <option value="easy">سهل</option>
                                                <option value="medium" selected>متوسط</option>
                                                <option value="hard">صعب</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">الصف</label>
                                            <select id="externalGrade" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                                <option value="">اختر الصف</option>
                                                <option value="9">التاسع</option>
                                                <option value="10">العاشر</option>
                                                <option value="11">الحادي عشر</option>
                                                <option value="12">الثاني عشر</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="block text-xs font-medium text-gray-700 mb-1">أنواع الأسئلة المطلوبة</label>
                                        <div class="grid grid-cols-2 gap-1">
                                            <label class="flex items-center text-xs">
                                                <input type="checkbox" id="externalMcq" checked class="ml-1">
                                                <span>اختيار من متعدد</span>
                                            </label>
                                            <label class="flex items-center text-xs">
                                                <input type="checkbox" id="externalTrueFalse" class="ml-1">
                                                <span>صح أم خطأ</span>
                                            </label>
                                            <label class="flex items-center text-xs">
                                                <input type="checkbox" id="externalShort" class="ml-1">
                                                <span>إجابة قصيرة</span>
                                            </label>
                                            <label class="flex items-center text-xs">
                                                <input type="checkbox" id="externalFill" class="ml-1">
                                                <span>أكمل الفراغ</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button onclick="generateExternalPrompt()" class="w-full bg-blue-600 text-white py-2 px-3 rounded-md hover:bg-blue-700 transition-all text-sm">
                                        <i class="fas fa-magic ml-1"></i>إنشاء النص للذكاء الاصطناعي
                                    </button>
                                </div>
                                
                                <!-- Generated Prompt Display -->
                                <div id="generatedPrompt" class="hidden bg-green-50 border border-green-200 rounded p-3">
                                    <h5 class="font-semibold text-green-800 mb-2">النص المُولد - انسخه واستخدمه:</h5>
                                    <div class="bg-white p-3 rounded border text-sm" style="direction: ltr; text-align: left;">
                                        <pre id="promptText" class="whitespace-pre-wrap text-xs"></pre>
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="copyPromptToClipboard()" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                            <i class="fas fa-copy ml-1"></i>نسخ النص
                                        </button>
                                        <button onclick="openChatGPT()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                            <i class="fas fa-external-link-alt ml-1"></i>فتح ChatGPT
                                        </button>
                                        <button onclick="openClaude()" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700">
                                            <i class="fas fa-external-link-alt ml-1"></i>فتح Claude
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Step 2: Paste AI Response -->
                                <div class="bg-white p-3 rounded border">
                                    <h5 class="font-semibold text-blue-800 mb-3">الخطوة 2: لصق رد الذكاء الاصطناعي</h5>
                                    <textarea id="aiResponseText" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="الصق هنا رد الذكاء الاصطناعي الذي يحتوي على الأسئلة..."></textarea>
                                    <button onclick="parseExternalAIResponse()" class="w-full mt-2 bg-green-600 text-white py-2 px-3 rounded-md hover:bg-green-700 transition-all text-sm">
                                        <i class="fas fa-cogs ml-1"></i>تحويل الأسئلة إلى امتحان
                                    </button>
                                </div>
                                
                                <!-- Instructions -->
                                <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                                    <h5 class="font-semibold text-yellow-800 mb-2">كيفية الاستخدام:</h5>
                                    <ol class="text-xs text-yellow-700 space-y-1">
                                        <li>1. املأ التفاصيل واضغط "إنشاء النص"</li>
                                        <li>2. انسخ النص المُولد</li>
                                        <li>3. اذهب إلى ChatGPT أو Claude والصق النص</li>
                                        <li>4. انسخ رد الذكاء الاصطناعي والصقه في الخانة أعلاه</li>
                                        <li>5. اضغط "تحويل الأسئلة إلى امتحان"</li>
                                    </ol>
                                </div>
                            </div>
                        </div>



                        <!-- Status Messages -->
                        <div id="aiSuccess" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 ml-2"></i>
                                <div>
                                    <p class="text-green-800 font-medium">تم بنجاح!</p>
                                    <p class="text-green-600 text-sm" id="aiSuccessMessage"></p>
                                </div>
                            </div>
                        </div>

                        <div id="aiError" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-600 ml-2"></i>
                                <div>
                                    <p class="text-red-800 font-medium">حدث خطأ</p>
                                    <p class="text-red-600 text-sm" id="aiErrorMessage"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Marks Control -->
                    <div class="mt-6 pt-4 border-t">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">التحكم في الدرجات</h3>
                        <div class="grid grid-cols-1 gap-2">
                            <button onclick="bulkEditMarks()" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition-colors text-sm">
                                <i class="fas fa-edit ml-1"></i>تعديل جماعي للدرجات
                            </button>
                            <button onclick="toggleAllMarks()" class="bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 transition-colors text-sm">
                                <i class="fas fa-eye-slash ml-1"></i>إخفاء/إظهار جميع الدرجات
                            </button>
                            <button onclick="calculateTotalMarks()" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 transition-colors text-sm">
                                <i class="fas fa-calculator ml-1"></i>حساب المجموع الكلي
                            </button>
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="mt-6 pt-4 border-t">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">تصدير الامتحان</h3>
                        <div class="grid grid-cols-1 gap-3">
                            <!-- PDF Options -->
                            <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                <h4 class="font-medium text-red-800 mb-2">تصدير PDF</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <button onclick="saveToPDF()" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors text-sm">
                                        <i class="fas fa-file-pdf ml-1"></i>PDF عادي
                                    </button>
                                    <button onclick="saveToAdvancedPDF()" class="bg-red-700 text-white py-2 px-4 rounded-md hover:bg-red-800 transition-colors text-sm">
                                        <i class="fas fa-file-pdf ml-1"></i>PDF متقدم (html2pdf)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Image Options -->
                            <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                                <h4 class="font-medium text-green-800 mb-2">تصدير الصور</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <button onclick="downloadAsImages()" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors text-sm">
                                        <i class="fas fa-images ml-1"></i>صور PNG (html2canvas)
                                    </button>
                                    <button onclick="downloadAsImagesAdvanced()" class="bg-green-700 text-white py-2 px-4 rounded-md hover:bg-green-800 transition-colors text-sm">
                                        <i class="fas fa-images ml-1"></i>صور متقدمة (dom-to-image)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Print Options -->
                            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                <h4 class="font-medium text-blue-800 mb-2">خيارات الطباعة</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <button onclick="printExam()" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors text-sm">
                                        <i class="fas fa-print ml-1"></i>طباعة عادية
                                    </button>
                                    <button onclick="printExamAdvanced()" class="bg-blue-700 text-white py-2 px-4 rounded-md hover:bg-blue-800 transition-colors text-sm">
                                        <i class="fas fa-print ml-1"></i>طباعة متقدمة (Print.js)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Other Options -->
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <h4 class="font-medium text-gray-800 mb-2">خيارات أخرى</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <button onclick="copyToClipboard()" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors text-sm">
                                        <i class="fas fa-copy ml-1"></i>نسخ النص
                                    </button>
                                    <button onclick="saveAsHTML()" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition-colors text-sm">
                                        <i class="fas fa-code ml-1"></i>حفظ HTML
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Questions List -->
                <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">قائمة الأسئلة</h3>
                        <span id="questionCount" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">0 سؤال</span>
                    </div>
                    <div id="questionsList" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-question-circle text-4xl mb-3 opacity-50"></i>
                            <p>لم يتم إضافة أي أسئلة بعد</p>
                            <p class="text-sm">استخدم النموذج أعلاه لإضافة أسئلة</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">معاينة الامتحان</h3>
                        <button onclick="updatePreview()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-md text-sm hover:bg-blue-200 transition-colors">
                            <i class="fas fa-refresh ml-1"></i>تحديث
                        </button>
                    </div>

                    <div class="preview-container" id="previewContainer">
                        <div class="page-preview">
                            <div id="examPreview">
                                <!-- سيتم إنشاء المعاينة هنا -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let questions = [];
        const GEMINI_API_KEY = 'AIzaSyDGmTdGeKUJBRgzuJQGrLgD4us2JEmV2vc'; // مفتاح API الحقيقي
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';
        let isAIConnected = false;
        let schoolLogoData = null;
        let librariesLoaded = false;

        // Check if required libraries are loaded
        function checkLibraries() {
            const checks = {
                tailwind: typeof window.tailwind !== 'undefined' || document.querySelector('script[src*="tailwindcss"]'),
                html2canvas: typeof html2canvas !== 'undefined',
                jsPDF: typeof window.jspdf !== 'undefined',
                domtoimage: typeof domtoimage !== 'undefined',
                fabric: typeof fabric !== 'undefined',
                printjs: typeof printJS !== 'undefined',
                html2pdf: typeof html2pdf !== 'undefined',
                saveAs: typeof saveAs !== 'undefined'
            };
            
            const missing = Object.keys(checks).filter(lib => !checks[lib]);
            
            if (missing.length > 0) {
                console.warn('مكتبات مفقودة:', missing);
                showNotification(`مكتبات مفقودة: ${missing.join(', ')}. بعض الوظائف قد لا تعمل بشكل مثالي`, 'warning');
            }
            
            // Check if at least basic libraries are loaded
            const basicLibsLoaded = checks.html2canvas && checks.jsPDF;
            if (basicLibsLoaded) {
                librariesLoaded = true;
                console.log('تم تحميل المكتبات الأساسية بنجاح ✅');
                if (missing.length === 0) {
                    console.log('تم تحميل جميع المكتبات المتقدمة بنجاح 🚀');
                }
                return true;
            }
            
            return false;
        }

        // Wait for libraries to load
        function waitForLibraries() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 20;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (checkLibraries() || attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        resolve(librariesLoaded);
                    }
                }, 500);
            });
        }
        
        // Initialize the application with error handling
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('بدء تحميل الموقع...');
                
                // Check if all required elements exist
                const requiredElements = ['examTitle', 'examPreview', 'questionsList'];
                const missingElements = requiredElements.filter(id => !document.getElementById(id));
                
                if (missingElements.length > 0) {
                    console.error('عناصر مفقودة:', missingElements);
                    showNotification('خطأ في تحميل الصفحة - عناصر مفقودة', 'error');
                    return;
                }
                
                // Set current date
                const today = new Date().toISOString().split('T')[0];
                const examDateElement = document.getElementById('examDate');
                if (examDateElement) {
                    examDateElement.value = today;
                }
                
                // Initialize functions with error handling after libraries load
                waitForLibraries().then(() => {
                    setTimeout(() => {
                        try {
                            updatePreview();
                            toggleQuestionOptions();
                            testAIConnection();
                            console.log('تم تحميل الموقع بنجاح ✅');
                            showNotification('تم تحميل الموقع بنجاح! 🎉', 'success');
                        } catch (initError) {
                            console.error('خطأ في التهيئة:', initError);
                            showNotification('خطأ في تهيئة الموقع', 'error');
                        }
                    }, 500);
                });
                
                // Add event listeners for real-time updates with error handling
                const inputs = ['examTitle', 'subject', 'grade', 'duration', 'totalMarks', 'teacherName', 'schoolName', 'examDate'];
                inputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', safeUpdatePreview);
                        element.addEventListener('change', safeUpdatePreview);
                    }
                });

                // Add event listeners for formatting controls with error handling
                const formatControls = [
                    'headerFontFamily', 'headerFontSize', 'questionFontFamily', 'questionFontSize',
                    'optionFontFamily', 'optionFontSize', 'sectionFontFamily', 'sectionFontSize',
                    'headerStyle', 'headerBgColor', 'headerBorderColor', 'showQuestionFrames',
                    'showMarks', 'showInstructions', 'questionBold', 'questionNumbering',
                    'optionSymbols', 'optionStyle', 'optionBoxStyle', 'optionBoxSize',
                    'answerMarkType', 'shortAnswerSpace', 'essayLines', 'groupByType',
                    'showSectionHeaders', 'showSectionInstructions', 'showSubject', 'showGrade',
                    'showDuration', 'showTotalMarks', 'showTeacher', 'showSchool', 'showDate',
                    'showLogo', 'showStudentName', 'showStudentId', 'showStudentClass', 'showStudentSeat',
                    'logoPosition', 'logoSize', 'logoShape', 'showTeacherSignature', 'showGoodLuck',
                    'dateFormat', 'sectionBgColor', 'sectionBorderColor', 'sectionStyle'
                ];
                
                formatControls.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', safeUpdatePreview);
                        element.addEventListener('change', safeUpdatePreview);
                    }
                });
                
            } catch (error) {
                console.error('خطأ في تحميل الصفحة:', error);
                showNotification('خطأ في تحميل الصفحة', 'error');
            }
        });

        // Safe update preview function with error handling
        function safeUpdatePreview() {
            try {
                updatePreview();
            } catch (error) {
                console.error('خطأ في تحديث المعاينة:', error);
                showNotification('خطأ في تحديث المعاينة', 'warning');
            }
        }

        // Logo handling functions
        function handleLogoUpload() {
            const fileInput = document.getElementById('schoolLogoFile');
            const file = fileInput.files[0];
            
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('حجم الملف كبير جداً. يرجى اختيار صورة أصغر من 5 ميجابايت.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    schoolLogoData = e.target.result;
                    document.getElementById('logoImage').src = schoolLogoData;
                    document.getElementById('logoPreview').classList.remove('hidden');
                    updatePreview();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() {
            schoolLogoData = null;
            document.getElementById('schoolLogoFile').value = '';
            document.getElementById('logoPreview').classList.add('hidden');
            updatePreview();
        }

        // AI Connection Functions
        async function testAIConnection() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const testButton = document.querySelector('button[onclick="testAIConnection()"]');
            
            // Show loading state
            statusIndicator.className = 'w-3 h-3 rounded-full status-connecting ml-2';
            statusText.textContent = 'جاري الاختبار...';
            testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: 'اختبار الاتصال - رد بكلمة "متصل" فقط'
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 10,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Gemini Response:', data);
                    
                    if (data.candidates && data.candidates[0]) {
                        if (data.candidates[0].content && data.candidates[0].content.parts) {
                            isAIConnected = true;
                            statusIndicator.className = 'w-3 h-3 rounded-full status-connected ml-2';
                            statusText.textContent = 'متصل';
                            console.log('تم الاتصال بـ Gemini AI بنجاح');
                            showNotification('تم الاتصال بـ Gemini AI بنجاح! 🤖✨', 'success');
                            return;
                        } else if (data.candidates[0].finishReason === 'SAFETY') {
                            throw new Error('تم حظر المحتوى لأسباب أمنية');
                        }
                    }
                    
                    if (data.error) {
                        throw new Error(data.error.message || 'خطأ من API');
                    }
                }
                
                const errorData = await response.json().catch(() => ({}));
                if (errorData.error) {
                    if (errorData.error.code === 400) {
                        throw new Error('مفتاح API غير صالح أو منتهي الصلاحية');
                    } else if (errorData.error.code === 429) {
                        throw new Error('تم تجاوز حد الاستخدام. حاول مرة أخرى لاحقاً');
                    } else {
                        throw new Error(errorData.error.message || 'خطأ في الاتصال');
                    }
                }
                
                throw new Error(`HTTP ${response.status}: فشل في الاتصال بـ API`);
                
            } catch (error) {
                console.error('خطأ في الاتصال بـ Gemini AI:', error);
                isAIConnected = false;
                statusIndicator.className = 'w-3 h-3 rounded-full status-disconnected ml-2';
                statusText.textContent = 'غير متصل';
                showNotification(`فشل في الاتصال: ${error.message}`, 'error');
            } finally {
                testButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
            }
        }

        // Gemini AI Generation
        async function generateGeminiAI() {
            const topic = document.getElementById('aiTopic').value.trim();
            const count = parseInt(document.getElementById('aiQuestionCount').value) || 5;
            const difficulty = document.getElementById('difficultyLevel').value;
            
            if (!topic) {
                showAIError('يرجى إدخال موضوع الأسئلة');
                return;
            }

            const button = document.querySelector('button[onclick="generateGeminiAI()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>جاري التوليد...';
            button.disabled = true;

            try {
                const questionTypes = [];
                if (document.getElementById('aiMcq').checked) questionTypes.push('اختيار من متعدد');
                if (document.getElementById('aiTrueFalse').checked) questionTypes.push('صح أم خطأ');
                if (document.getElementById('aiShort').checked) questionTypes.push('إجابة قصيرة');
                if (document.getElementById('aiFill').checked) questionTypes.push('أكمل الفراغ');

                if (questionTypes.length === 0) {
                    showAIError('يرجى اختيار نوع واحد على الأقل من الأسئلة');
                    return;
                }

                const difficultyText = {
                    'easy': 'سهل',
                    'medium': 'متوسط',
                    'hard': 'صعب'
                }[difficulty];

                const prompt = `أنشئ ${count} أسئلة تعليمية حول موضوع "${topic}" بمستوى صعوبة ${difficultyText}.

أنواع الأسئلة المطلوبة: ${questionTypes.join('، ')}

يرجى إنشاء الأسئلة بالتنسيق التالي بالضبط:

[السؤال 1]
النوع: اختيار من متعدد
النص: [نص السؤال]
الخيارات: أ) [الخيار الأول] | ب) [الخيار الثاني] | ج) [الخيار الثالث] | د) [الخيار الرابع]
الإجابة الصحيحة: أ
الدرجة: 5
الموضوع: ${topic}
الهدف: [الهدف التعليمي]
الوقت المقترح: 3

تأكد من أن الأسئلة واضحة ومفهومة وصحيحة علمياً وباللغة العربية الفصحى.`;

                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 4096,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.error) {
                        if (errorData.error.code === 400) {
                            throw new Error('مفتاح API غير صالح أو منتهي الصلاحية');
                        } else if (errorData.error.code === 429) {
                            throw new Error('تم تجاوز حد الاستخدام. حاول مرة أخرى لاحقاً');
                        } else {
                            throw new Error(errorData.error.message || 'خطأ في الاتصال');
                        }
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Gemini Full Response:', data);
                
                if (!data.candidates || !data.candidates[0]) {
                    throw new Error('لم يتم الحصول على رد من الذكاء الاصطناعي');
                }

                const candidate = data.candidates[0];
                
                if (candidate.finishReason === 'SAFETY') {
                    throw new Error('تم حظر المحتوى لأسباب أمنية. جرب موضوعاً آخر');
                }
                
                if (!candidate.content || !candidate.content.parts || !candidate.content.parts[0]) {
                    throw new Error('الرد من الذكاء الاصطناعي فارغ أو غير صالح');
                }

                const aiText = candidate.content.parts[0].text;
                console.log('Gemini Response Text:', aiText);
                
                const generatedQuestions = parseAIResponseText(aiText);
                
                if (generatedQuestions.length === 0) {
                    showAIError('لم يتم إنشاء أي أسئلة صالحة. جرب موضوعاً مختلفاً أو قلل عدد الأسئلة');
                    return;
                }

                questions.push(...generatedQuestions);
                
                updateQuestionsList();
                updatePreview();
                showAISuccess(`تم إنشاء ${generatedQuestions.length} سؤال بنجاح! 🎯✨`);
                
                // Clear form
                document.getElementById('aiTopic').value = '';
                
            } catch (error) {
                console.error('خطأ في توليد الأسئلة:', error);
                showAIError(`حدث خطأ في توليد الأسئلة: ${error.message}`);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }





        // Tab switching with error handling
        function switchTab(tabName) {
            try {
                console.log('تبديل التبويب إلى:', tabName);
                
                const tabs = ['basic', 'questions', 'format', 'ai'];
                tabs.forEach(tab => {
                    const tabElement = document.getElementById(tab + '-tab');
                    const buttonElement = document.getElementById('tab-' + tab);
                    if (tabElement) tabElement.classList.add('hidden');
                    if (buttonElement) buttonElement.classList.remove('tab-active');
                });
                
                const selectedTab = document.getElementById(tabName + '-tab');
                const selectedButton = document.getElementById('tab-' + tabName);
                if (selectedTab) selectedTab.classList.remove('hidden');
                if (selectedButton) selectedButton.classList.add('tab-active');
                
                console.log('تم تبديل التبويب بنجاح');
            } catch (error) {
                console.error('خطأ في تبديل التبويب:', error);
                showNotification('خطأ في تبديل التبويب', 'error');
            }
        }

        // Toggle question options based on type
        function toggleQuestionOptions() {
            const questionType = document.getElementById('questionType').value;
            console.log('نوع السؤال المحدد:', questionType);
            
            const containers = ['mcqOptions', 'trueFalseOptions', 'fillOptions'];
            containers.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
            
            switch(questionType) {
                case 'mcq':
                    document.getElementById('mcqOptions').classList.remove('hidden');
                    break;
                case 'true-false':
                    document.getElementById('trueFalseOptions').classList.remove('hidden');
                    break;
                case 'fill':
                    document.getElementById('fillOptions').classList.remove('hidden');
                    break;
            }
        }

        // Add question function with enhanced details and error handling
        function addQuestion() {
            try {
                const questionText = document.getElementById('questionText')?.value?.trim();
                const questionType = document.getElementById('questionType')?.value;
                const questionMarks = parseInt(document.getElementById('questionMarks')?.value) || 5;
                const questionDifficulty = document.getElementById('questionDifficulty')?.value || 'medium';
                const questionTopic = document.getElementById('questionTopic')?.value?.trim() || '';
                const questionObjective = document.getElementById('questionObjective')?.value?.trim() || '';
                const questionTime = parseInt(document.getElementById('questionTime')?.value) || 5;
                
                if (!questionText) {
                    showNotification('يرجى إدخال نص السؤال', 'error');
                    return;
                }
                
                const question = {
                    id: Date.now(),
                    text: questionText,
                    type: questionType,
                    marks: questionMarks,
                    difficulty: questionDifficulty,
                    topic: questionTopic,
                    objective: questionObjective,
                    estimatedTime: questionTime,
                    options: [],
                    correctAnswer: null,
                    acceptedAnswers: []
                };
                
                if (questionType === 'mcq') {
                    const options = [];
                    const correctAnswerRadio = document.querySelector('input[name="correctMCQ"]:checked');
                    
                    for (let i = 1; i <= 4; i++) {
                        const optionElement = document.getElementById(`option${i}`);
                        if (optionElement && optionElement.value.trim()) {
                            options.push(optionElement.value.trim());
                        }
                    }
                    
                    if (options.length < 2) {
                        showNotification('يرجى إدخال خيارين على الأقل', 'error');
                        return;
                    }
                    
                    if (!correctAnswerRadio) {
                        showNotification('يرجى تحديد الإجابة الصحيحة', 'error');
                        return;
                    }
                    
                    question.options = options;
                    question.correctAnswer = parseInt(correctAnswerRadio.value);
                    
                } else if (questionType === 'true-false') {
                    const correctAnswerRadio = document.querySelector('input[name="trueFalseAnswer"]:checked');
                    question.options = ['صح', 'خطأ'];
                    question.correctAnswer = correctAnswerRadio ? (correctAnswerRadio.value === 'true' ? 1 : 2) : 1;
                    
                } else if (questionType === 'fill') {
                    const fillAnswersElement = document.getElementById('fillAnswers');
                    const fillAnswers = fillAnswersElement ? fillAnswersElement.value.trim() : '';
                    question.acceptedAnswers = fillAnswers ? fillAnswers.split('،').map(ans => ans.trim()).filter(ans => ans) : [];
                }
                
                questions.push(question);
                console.log('تم إضافة السؤال:', question);
                
                updateQuestionsList();
                safeUpdatePreview();
                clearQuestionForm();
                
                showNotification('تم إضافة السؤال بنجاح!', 'success');
                
                // Scroll to the new question
                setTimeout(() => {
                    try {
                        const questionsList = document.getElementById('questionsList');
                        if (questionsList) {
                            questionsList.scrollTop = questionsList.scrollHeight;
                        }
                    } catch (scrollError) {
                        console.warn('خطأ في التمرير:', scrollError);
                    }
                }, 100);
                
            } catch (error) {
                console.error('خطأ في إضافة السؤال:', error);
                showNotification('حدث خطأ في إضافة السؤال', 'error');
            }
        }

        // Enhanced notification system with error handling
        function showNotification(message, type = 'info') {
            try {
                // Remove existing notifications
                const existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(n => {
                    try {
                        n.remove();
                    } catch (e) {
                        console.warn('خطأ في إزالة الإشعار:', e);
                    }
                });
                
                const notification = document.createElement('div');
                notification.className = `notification fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300`;
                
                const colors = {
                    'success': 'bg-green-500 text-white',
                    'error': 'bg-red-500 text-white',
                    'warning': 'bg-yellow-500 text-white',
                    'info': 'bg-blue-500 text-white'
                };
                
                const icons = {
                    'success': 'fas fa-check-circle',
                    'error': 'fas fa-exclamation-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'info': 'fas fa-info-circle'
                };
                
                notification.className += ` ${colors[type] || colors.info}`;
                notification.innerHTML = `
                    <div class="flex items-center">
                        <i class="${icons[type] || icons.info} ml-2"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    try {
                        notification.style.transform = 'translateX(-50%) translateY(0)';
                        notification.style.opacity = '1';
                    } catch (e) {
                        console.warn('خطأ في تحريك الإشعار:', e);
                    }
                }, 10);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    try {
                        notification.style.transform = 'translateX(-50%) translateY(-100%)';
                        notification.style.opacity = '0';
                        setTimeout(() => {
                            try {
                                if (notification.parentNode) {
                                    notification.remove();
                                }
                            } catch (e) {
                                console.warn('خطأ في إزالة الإشعار المتأخر:', e);
                            }
                        }, 300);
                    } catch (e) {
                        console.warn('خطأ في إخفاء الإشعار:', e);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('خطأ في إظهار الإشعار:', error);
                // Fallback to alert
                alert(message);
            }
        }

        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('خطأ عام في الصفحة:', event.error);
            showNotification('حدث خطأ في الصفحة. يرجى إعادة تحميل الصفحة', 'error');
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('خطأ في Promise:', event.reason);
            showNotification('حدث خطأ في العملية. يرجى المحاولة مرة أخرى', 'warning');
        });

        // Clear question form
        function clearQuestionForm() {
            document.getElementById('questionText').value = '';
            document.getElementById('questionMarks').value = '5';
            document.getElementById('questionTopic').value = '';
            document.getElementById('questionObjective').value = '';
            document.getElementById('questionTime').value = '';
            
            for (let i = 1; i <= 4; i++) {
                const optionElement = document.getElementById(`option${i}`);
                if (optionElement) optionElement.value = '';
            }
            
            const radioButtons = document.querySelectorAll('input[name="correctMCQ"]');
            radioButtons.forEach(radio => radio.checked = false);
            
            const trueFalseRadios = document.querySelectorAll('input[name="trueFalseAnswer"]');
            trueFalseRadios.forEach(radio => radio.checked = false);
            
            const fillAnswers = document.getElementById('fillAnswers');
            if (fillAnswers) fillAnswers.value = '';
        }

        // Delete question
        function deleteQuestion(questionId) {
            if (confirm('هل أنت متأكد من حذف هذا السؤال؟')) {
                questions = questions.filter(q => q.id !== questionId);
                updateQuestionsList();
                updatePreview();
                alert('تم حذف السؤال بنجاح');
            }
        }

        // Update questions list with enhanced details and drag-drop
        function updateQuestionsList() {
            const questionsList = document.getElementById('questionsList');
            const questionCount = document.getElementById('questionCount');
            
            questionCount.textContent = `${questions.length} سؤال`;
            
            if (questions.length === 0) {
                questionsList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-question-circle text-4xl mb-3 opacity-50"></i>
                        <p>لم يتم إضافة أي أسئلة بعد</p>
                        <p class="text-sm">استخدم النموذج أعلاه لإضافة أسئلة</p>
                    </div>
                `;
                return;
            }
            
            questionsList.innerHTML = questions.map((question, index) => `
                <div class="question-item draggable" draggable="true" data-question-id="${question.id}" data-index="${index}">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center ml-2">
                            <i class="fas fa-grip-vertical text-gray-400 cursor-move drag-handle" title="اسحب لإعادة الترتيب"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center mb-2 flex-wrap gap-2">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">
                                    ${getQuestionTypeText(question.type)}
                                </span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium editable-marks" 
                                      onclick="editMarks(${question.id}, ${question.marks})" title="انقر للتعديل">
                                    ${question.marks} درجة
                                </span>
                                <button onclick="toggleQuestionMarks(${question.id})" 
                                        class="px-2 py-1 rounded text-xs font-medium ${question.hideMarks ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}" 
                                        title="${question.hideMarks ? 'إظهار الدرجة' : 'إخفاء الدرجة'}">
                                    ${question.hideMarks ? 'مخفية' : 'ظاهرة'}
                                </button>
                                <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-medium">
                                    #${index + 1}
                                </span>
                                ${question.difficulty ? `
                                    <span class="bg-${getDifficultyColor(question.difficulty)}-100 text-${getDifficultyColor(question.difficulty)}-800 px-2 py-1 rounded text-xs font-medium">
                                        ${getDifficultyText(question.difficulty)}
                                    </span>
                                ` : ''}
                                ${question.estimatedTime ? `
                                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-medium">
                                        ${question.estimatedTime} د
                                    </span>
                                ` : ''}
                            </div>
                            <p class="text-gray-800 font-medium mb-2 editable-text cursor-pointer hover:bg-gray-50 p-1 rounded" 
                               onclick="editQuestionText(${question.id})" title="انقر للتعديل">${question.text}</p>
                            ${question.topic ? `<p class="text-sm text-gray-600 mb-1"><strong>الموضوع:</strong> <span class="editable-text cursor-pointer hover:bg-gray-50 p-1 rounded" onclick="editQuestionTopic(${question.id})" title="انقر للتعديل">${question.topic}</span></p>` : ''}
                            ${question.objective ? `<p class="text-sm text-gray-600 mb-2"><strong>الهدف:</strong> <span class="editable-text cursor-pointer hover:bg-gray-50 p-1 rounded" onclick="editQuestionObjective(${question.id})" title="انقر للتعديل">${question.objective}</span></p>` : ''}
                            ${question.options.length > 0 ? `
                                <div class="text-sm text-gray-600">
                                    ${question.options.map((option, i) => `
                                        <div class="flex items-center mb-1">
                                            <span class="w-6 h-6 border-2 border-gray-400 rounded-full flex items-center justify-center text-xs font-bold ml-2">${String.fromCharCode(65 + i)}</span>
                                            <span class="editable-text cursor-pointer hover:bg-gray-50 p-1 rounded flex-1" 
                                                  onclick="editOption(${question.id}, ${i})" title="انقر للتعديل">${option}</span>
                                            ${question.correctAnswer === (i + 1) ? '<i class="fas fa-check text-green-600 mr-2"></i>' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex flex-col space-y-1">
                            <button onclick="editQuestion(${question.id})" class="text-blue-600 hover:text-blue-800 p-1" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="duplicateQuestion(${question.id})" class="text-green-600 hover:text-green-800 p-1" title="نسخ">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="deleteQuestion(${question.id})" class="text-red-600 hover:text-red-800 p-1" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Initialize drag and drop
            initializeDragAndDrop();
        }

        // Initialize drag and drop functionality
        function initializeDragAndDrop() {
            const draggableItems = document.querySelectorAll('.draggable');
            
            draggableItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const draggedIndex = parseInt(draggedElement.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // Reorder questions array
                const draggedQuestion = questions[draggedIndex];
                questions.splice(draggedIndex, 1);
                questions.splice(targetIndex, 0, draggedQuestion);
                
                updateQuestionsList();
                updatePreview();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            draggedElement = null;
        }

        // Edit functions
        function editMarks(questionId, currentMarks) {
            const newMarks = prompt('أدخل الدرجة الجديدة:', currentMarks);
            if (newMarks !== null && !isNaN(newMarks) && newMarks > 0) {
                const question = questions.find(q => q.id === questionId);
                if (question) {
                    question.marks = parseInt(newMarks);
                    updateQuestionsList();
                    updatePreview();
                    showNotification('تم تحديث الدرجة بنجاح!', 'success');
                }
            }
        }

        // Toggle marks visibility for individual questions
        function toggleQuestionMarks(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                question.hideMarks = !question.hideMarks;
                updateQuestionsList();
                updatePreview();
                const status = question.hideMarks ? 'مخفية' : 'ظاهرة';
                showNotification(`الدرجات الآن ${status} لهذا السؤال`, 'info');
            }
        }

        // Bulk edit marks
        function bulkEditMarks() {
            const selectedType = prompt('اختر نوع الأسئلة لتعديل درجاتها:\n1 - اختيار من متعدد\n2 - صح أم خطأ\n3 - إجابة قصيرة\n4 - مقالي\n5 - أكمل الفراغ\n6 - جميع الأسئلة', '6');
            
            if (!selectedType) return;
            
            const typeMap = {
                '1': 'mcq',
                '2': 'true-false', 
                '3': 'short',
                '4': 'essay',
                '5': 'fill',
                '6': 'all'
            };
            
            const targetType = typeMap[selectedType];
            if (!targetType) return;
            
            const newMarks = prompt('أدخل الدرجة الجديدة:', '5');
            if (newMarks === null || isNaN(newMarks) || newMarks <= 0) return;
            
            let updatedCount = 0;
            questions.forEach(question => {
                if (targetType === 'all' || question.type === targetType) {
                    question.marks = parseInt(newMarks);
                    updatedCount++;
                }
            });
            
            updateQuestionsList();
            updatePreview();
            showNotification(`تم تحديث درجات ${updatedCount} سؤال بنجاح!`, 'success');
        }

        function editQuestionText(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                const newText = prompt('أدخل نص السؤال الجديد:', question.text);
                if (newText !== null && newText.trim()) {
                    question.text = newText.trim();
                    updateQuestionsList();
                    updatePreview();
                }
            }
        }

        function editQuestionTopic(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                const newTopic = prompt('أدخل الموضوع الجديد:', question.topic || '');
                if (newTopic !== null) {
                    question.topic = newTopic.trim();
                    updateQuestionsList();
                    updatePreview();
                }
            }
        }

        function editQuestionObjective(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                const newObjective = prompt('أدخل الهدف التعليمي الجديد:', question.objective || '');
                if (newObjective !== null) {
                    question.objective = newObjective.trim();
                    updateQuestionsList();
                    updatePreview();
                }
            }
        }

        function editOption(questionId, optionIndex) {
            const question = questions.find(q => q.id === questionId);
            if (question && question.options[optionIndex]) {
                const newOption = prompt('أدخل نص الخيار الجديد:', question.options[optionIndex]);
                if (newOption !== null && newOption.trim()) {
                    question.options[optionIndex] = newOption.trim();
                    updateQuestionsList();
                    updatePreview();
                }
            }
        }

        function editQuestion(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                // Switch to questions tab and populate form
                switchTab('questions');
                
                // Populate form with question data
                document.getElementById('questionText').value = question.text;
                document.getElementById('questionType').value = question.type;
                document.getElementById('questionMarks').value = question.marks;
                document.getElementById('questionDifficulty').value = question.difficulty || 'medium';
                document.getElementById('questionTopic').value = question.topic || '';
                document.getElementById('questionObjective').value = question.objective || '';
                document.getElementById('questionTime').value = question.estimatedTime || 5;
                
                // Handle options based on question type
                if (question.type === 'mcq') {
                    for (let i = 0; i < 4; i++) {
                        const optionElement = document.getElementById(`option${i + 1}`);
                        if (optionElement) {
                            optionElement.value = question.options[i] || '';
                        }
                    }
                    
                    // Set correct answer
                    if (question.correctAnswer) {
                        const correctRadio = document.querySelector(`input[name="correctMCQ"][value="${question.correctAnswer}"]`);
                        if (correctRadio) correctRadio.checked = true;
                    }
                } else if (question.type === 'true-false') {
                    const correctValue = question.correctAnswer === 1 ? 'true' : 'false';
                    const correctRadio = document.querySelector(`input[name="trueFalseAnswer"][value="${correctValue}"]`);
                    if (correctRadio) correctRadio.checked = true;
                } else if (question.type === 'fill') {
                    const fillAnswers = document.getElementById('fillAnswers');
                    if (fillAnswers) fillAnswers.value = question.acceptedAnswers.join('، ');
                }
                
                toggleQuestionOptions();
                
                // Remove the question from array (will be re-added when form is submitted)
                questions = questions.filter(q => q.id !== questionId);
                updateQuestionsList();
                updatePreview();
                
                alert('تم تحميل السؤال في النموذج للتعديل. قم بالتعديل ثم اضغط "إضافة السؤال"');
            }
        }

        function duplicateQuestion(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                const duplicatedQuestion = {
                    ...question,
                    id: Date.now(),
                    text: question.text + ' (نسخة)'
                };
                questions.push(duplicatedQuestion);
                updateQuestionsList();
                updatePreview();
                alert('تم نسخ السؤال بنجاح');
            }
        }

        // Helper functions for question details
        function getQuestionTypeText(type) {
            const types = {
                'mcq': 'اختيار من متعدد',
                'true-false': 'صح أم خطأ',
                'short': 'إجابة قصيرة',
                'essay': 'مقالي',
                'fill': 'أكمل الفراغ'
            };
            return types[type] || type;
        }

        // Format date based on selected format
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const dateFormat = document.getElementById('dateFormat')?.value || 'arabic';
            
            switch (dateFormat) {
                case 'arabic':
                    return formatArabicDate(date);
                case 'hijri':
                    return formatHijriDate(date);
                case 'gregorian':
                    return date.toLocaleDateString('ar-SA');
                case 'both':
                    return `${date.toLocaleDateString('ar-SA')} - ${formatHijriDate(date)}`;
                case 'text':
                    return formatTextDate(date);
                default:
                    return date.toLocaleDateString('ar-SA');
            }
        }

        function formatArabicDate(date) {
            const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                           'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            
            const day = date.getDate().toString().replace(/\d/g, d => arabicNumerals[d]);
            const month = months[date.getMonth()];
            const year = date.getFullYear().toString().replace(/\d/g, d => arabicNumerals[d]);
            
            return `${day} ${month} ${year}`;
        }

        function formatHijriDate(date) {
            // Simplified Hijri conversion (approximate)
            const hijriYear = Math.floor((date.getFullYear() - 622) * 1.030684) + 1;
            const hijriMonth = Math.floor(Math.random() * 12) + 1; // Simplified
            const hijriDay = date.getDate();
            
            return `${hijriDay.toString().padStart(2, '0')}/${hijriMonth.toString().padStart(2, '0')}/${hijriYear}`;
        }

        function formatTextDate(date) {
            const days = ['الأول', 'الثاني', 'الثالث', 'الرابع', 'الخامس', 'السادس', 'السابع', 'الثامن', 'التاسع', 'العاشر',
                         'الحادي عشر', 'الثاني عشر', 'الثالث عشر', 'الرابع عشر', 'الخامس عشر', 'السادس عشر', 'السابع عشر', 'الثامن عشر', 'التاسع عشر', 'العشرون',
                         'الحادي والعشرون', 'الثاني والعشرون', 'الثالث والعشرون', 'الرابع والعشرون', 'الخامس والعشرون', 'السادس والعشرون', 'السابع والعشرون', 'الثامن والعشرون', 'التاسع والعشرون', 'الثلاثون', 'الحادي والثلاثون'];
            const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                           'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            
            const day = days[date.getDate() - 1];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            
            return `${day} من ${month} ${year}`;
        }

        // Get section style classes
        function getSectionStyleClasses(style, bgColor, borderColor) {
            switch (style) {
                case 'modern':
                    return `background-color: ${bgColor}; border-right: 4px solid ${borderColor}; padding: 12px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);`;
                case 'classic':
                    return `background-color: ${bgColor}; border: 2px solid ${borderColor}; padding: 10px 15px; border-radius: 0;`;
                case 'minimal':
                    return `background-color: transparent; border-bottom: 2px solid ${borderColor}; padding: 8px 0; border-radius: 0;`;
                case 'bold':
                    return `background-color: ${borderColor}; color: white; padding: 12px 20px; border-radius: 6px; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.15);`;
                default:
                    return `background-color: ${bgColor}; border-right: 4px solid ${borderColor}; padding: 12px 20px;`;
            }
        }

        function getDifficultyColor(difficulty) {
            const colors = {
                'easy': 'green',
                'medium': 'yellow',
                'hard': 'red'
            };
            return colors[difficulty] || 'gray';
        }

        function getDifficultyText(difficulty) {
            const texts = {
                'easy': 'سهل',
                'medium': 'متوسط',
                'hard': 'صعب'
            };
            return texts[difficulty] || difficulty;
        }

        function getSubjectText(subject) {
            const subjects = {
                'math': 'الرياضيات',
                'arabic': 'اللغة العربية',
                'english': 'اللغة الإنجليزية',
                'science': 'العلوم',
                'history': 'التاريخ',
                'physics': 'الفيزياء',
                'chemistry': 'الكيمياء'
            };
            return subjects[subject] || subject || 'المادة';
        }

        function getGradeText(grade) {
            const grades = {
                '9': 'التاسع',
                '10': 'العاشر',
                '11': 'الحادي عشر',
                '12': 'الثاني عشر'
            };
            return grades[grade] || grade || 'الصف';
        }

        // Font size and spacing controls
        function updateHeaderFontSize() {
            const fontSize = document.getElementById('headerFontSize').value;
            const labels = {16: 'صغير', 20: 'متوسط', 24: 'كبير', 28: 'كبير جداً'};
            document.getElementById('headerFontSizeLabel').textContent = labels[fontSize] || 'كبير';
            updatePreview();
        }

        function updateQuestionFontSize() {
            const fontSize = document.getElementById('questionFontSize').value;
            const labels = {14: 'صغير', 16: 'متوسط', 18: 'كبير', 20: 'كبير جداً', 22: 'ضخم'};
            document.getElementById('questionFontSizeLabel').textContent = labels[fontSize] || 'متوسط';
            updatePreview();
        }

        function updateOptionFontSize() {
            const fontSize = document.getElementById('optionFontSize').value;
            const labels = {12: 'صغير جداً', 14: 'صغير', 16: 'متوسط', 18: 'كبير', 20: 'كبير جداً'};
            document.getElementById('optionFontSizeLabel').textContent = labels[fontSize] || 'متوسط';
            updatePreview();
        }

        function updateEssayLines() {
            const lines = document.getElementById('essayLines').value;
            document.getElementById('essayLinesLabel').textContent = lines + ' خطوط';
            updatePreview();
        }

        function updateSectionFontSize() {
            const fontSize = document.getElementById('sectionFontSize').value;
            const labels = {14: 'صغير', 16: 'متوسط', 18: 'كبير', 20: 'كبير جداً', 22: 'ضخم', 24: 'ضخم جداً'};
            document.getElementById('sectionFontSizeLabel').textContent = labels[fontSize] || 'متوسط';
            updatePreview();
        }

        function updateLogoSize() {
            const size = document.getElementById('logoSize').value;
            const labels = {40: 'صغير جداً', 60: 'صغير', 80: 'متوسط', 100: 'كبير', 120: 'كبير جداً'};
            document.getElementById('logoSizeLabel').textContent = labels[size] || 'متوسط';
            updatePreview();
        }



        function parseAIResponseText(aiResponse) {
            const questions = [];
            const questionBlocks = aiResponse.split(/\[السؤال \d+\]/).filter(block => block.trim());
            
            questionBlocks.forEach((block, index) => {
                try {
                    const lines = block.trim().split('\n').filter(line => line.trim());
                    const question = {
                        id: Date.now() + index,
                        options: [],
                        correctAnswer: null,
                        acceptedAnswers: [],
                        difficulty: 'medium',
                        topic: '',
                        objective: '',
                        estimatedTime: 5
                    };
                    
                    lines.forEach(line => {
                        const trimmedLine = line.trim();
                        
                        if (trimmedLine.startsWith('النوع:')) {
                            const type = trimmedLine.replace('النوع:', '').trim();
                            if (type.includes('اختيار من متعدد')) question.type = 'mcq';
                            else if (type.includes('صح أم خطأ')) question.type = 'true-false';
                            else if (type.includes('إجابة قصيرة')) question.type = 'short';
                            else if (type.includes('أكمل الفراغ')) question.type = 'fill';
                            else if (type.includes('مقالي')) question.type = 'essay';
                            else question.type = 'short';
                        }
                        else if (trimmedLine.startsWith('النص:')) {
                            question.text = trimmedLine.replace('النص:', '').trim();
                        }
                        else if (trimmedLine.startsWith('الخيارات:')) {
                            const optionsText = trimmedLine.replace('الخيارات:', '').trim();
                            const options = optionsText.split('|').map(opt => 
                                opt.trim().replace(/^[أ-د]\)\s*/, '')
                            );
                            question.options = options;
                        }
                        else if (trimmedLine.startsWith('الإجابة الصحيحة:')) {
                            const answer = trimmedLine.replace('الإجابة الصحيحة:', '').trim();
                            if (question.type === 'mcq') {
                                const letterMap = {'أ': 1, 'ب': 2, 'ج': 3, 'د': 4};
                                question.correctAnswer = letterMap[answer] || 1;
                            } else if (question.type === 'true-false') {
                                question.options = ['صح', 'خطأ'];
                                question.correctAnswer = answer === 'صح' ? 1 : 2;
                            }
                        }
                        else if (trimmedLine.startsWith('الإجابات المقبولة:')) {
                            const answers = trimmedLine.replace('الإجابات المقبولة:', '').trim();
                            question.acceptedAnswers = answers.split('،').map(ans => ans.trim()).filter(ans => ans);
                        }
                        else if (trimmedLine.startsWith('الدرجة:')) {
                            question.marks = parseInt(trimmedLine.replace('الدرجة:', '').trim()) || 5;
                        }
                        else if (trimmedLine.startsWith('الموضوع:')) {
                            question.topic = trimmedLine.replace('الموضوع:', '').trim();
                        }
                        else if (trimmedLine.startsWith('الهدف:')) {
                            question.objective = trimmedLine.replace('الهدف:', '').trim();
                        }
                        else if (trimmedLine.startsWith('الوقت المقترح:')) {
                            question.estimatedTime = parseInt(trimmedLine.replace('الوقت المقترح:', '').trim()) || 5;
                        }
                    });
                    
                    if (question.text && question.type) {
                        questions.push(question);
                    }
                } catch (error) {
                    console.error('Error parsing question block:', error);
                }
            });
            
            return questions;
        }

        function showAISuccess(message) {
            document.getElementById('aiError').classList.add('hidden');
            document.getElementById('aiSuccess').classList.remove('hidden');
            document.getElementById('aiSuccessMessage').textContent = message;
            
            setTimeout(() => {
                document.getElementById('aiSuccess').classList.add('hidden');
            }, 5000);
        }

        function showAIError(message) {
            document.getElementById('aiSuccess').classList.add('hidden');
            document.getElementById('aiError').classList.remove('hidden');
            document.getElementById('aiErrorMessage').textContent = message;
            
            setTimeout(() => {
                document.getElementById('aiError').classList.add('hidden');
            }, 5000);
        }

        // External AI Functions
        function generateExternalPrompt() {
            const topic = document.getElementById('externalTopic').value.trim();
            const count = document.getElementById('externalCount').value || '5';
            const difficulty = document.getElementById('externalDifficulty').value;
            const grade = document.getElementById('externalGrade').value;
            
            if (!topic) {
                showNotification('يرجى إدخال موضوع الأسئلة', 'error');
                return;
            }
            
            // Get selected question types
            const questionTypes = [];
            if (document.getElementById('externalMcq').checked) questionTypes.push('اختيار من متعدد');
            if (document.getElementById('externalTrueFalse').checked) questionTypes.push('صح أم خطأ');
            if (document.getElementById('externalShort').checked) questionTypes.push('إجابة قصيرة');
            if (document.getElementById('externalFill').checked) questionTypes.push('أكمل الفراغ');
            
            if (questionTypes.length === 0) {
                showNotification('يرجى اختيار نوع واحد على الأقل من الأسئلة', 'error');
                return;
            }
            
            const difficultyText = {
                'easy': 'سهل',
                'medium': 'متوسط', 
                'hard': 'صعب'
            }[difficulty];
            
            const gradeText = grade ? ` للصف ${getGradeText(grade)}` : '';
            
            // Generate comprehensive prompt
            const prompt = `أنشئ ${count} أسئلة تعليمية حول موضوع "${topic}"${gradeText} بمستوى صعوبة ${difficultyText}.

أنواع الأسئلة المطلوبة: ${questionTypes.join('، ')}

يرجى إنشاء الأسئلة بالتنسيق التالي بالضبط:

[السؤال 1]
النوع: اختيار من متعدد
النص: [نص السؤال]
الخيارات: أ) [الخيار الأول] | ب) [الخيار الثاني] | ج) [الخيار الثالث] | د) [الخيار الرابع]
الإجابة الصحيحة: أ
الدرجة: 5
الموضوع: ${topic}
الهدف: [الهدف التعليمي]
الوقت المقترح: 3

[السؤال 2]
النوع: صح أم خطأ
النص: [نص السؤال]
الإجابة الصحيحة: صح
الدرجة: 3
الموضوع: ${topic}
الهدف: [الهدف التعليمي]
الوقت المقترح: 2

[السؤال 3]
النوع: إجابة قصيرة
النص: [نص السؤال]
الدرجة: 4
الموضوع: ${topic}
الهدف: [الهدف التعليمي]
الوقت المقترح: 5

[السؤال 4]
النوع: أكمل الفراغ
النص: [نص السؤال مع _____ للفراغات]
الإجابات المقبولة: [الإجابة الأولى، الإجابة الثانية]
الدرجة: 3
الموضوع: ${topic}
الهدف: [الهدف التعليمي]
الوقت المقترح: 3

متطلبات مهمة:
- استخدم اللغة العربية الفصحى
- تأكد من أن الأسئلة واضحة ومفهومة
- اجعل الأسئلة صحيحة علمياً ومناسبة للمستوى
- في أسئلة الاختيار من متعدد، اجعل جميع الخيارات معقولة
- في أسئلة صح أم خطأ، تأكد من وضوح الإجابة
- في أسئلة أكمل الفراغ، استخدم _____ للفراغات
- حدد الأهداف التعليمية بوضوح

يرجى الالتزام بالتنسيق المحدد أعلاه بدقة لضمان التحويل الصحيح للأسئلة.`;
            
            // Display the generated prompt
            document.getElementById('promptText').textContent = prompt;
            document.getElementById('generatedPrompt').classList.remove('hidden');
            
            showNotification('تم إنشاء النص بنجاح! انسخه واستخدمه في الذكاء الاصطناعي', 'success');
        }

        function copyPromptToClipboard() {
            const promptText = document.getElementById('promptText').textContent;
            navigator.clipboard.writeText(promptText).then(() => {
                showNotification('تم نسخ النص إلى الحافظة بنجاح! 📋', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = promptText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('تم نسخ النص إلى الحافظة', 'success');
            });
        }

        function openChatGPT() {
            window.open('https://chat.openai.com/', '_blank');
        }

        function openClaude() {
            window.open('https://claude.ai/', '_blank');
        }

        function parseExternalAIResponse() {
            const responseText = document.getElementById('aiResponseText').value.trim();
            
            if (!responseText) {
                showNotification('يرجى لصق رد الذكاء الاصطناعي أولاً', 'error');
                return;
            }
            
            try {
                // Parse the AI response using the same parsing function
                const parsedQuestions = parseAIResponseText(responseText);
                
                if (parsedQuestions.length === 0) {
                    showNotification('لم يتم العثور على أسئلة صالحة في النص. تأكد من التنسيق الصحيح', 'error');
                    return;
                }
                
                // Add questions to the main questions array
                questions.push(...parsedQuestions);
                
                // Update UI
                updateQuestionsList();
                updatePreview();
                
                // Clear the response text area
                document.getElementById('aiResponseText').value = '';
                
                showNotification(`تم إضافة ${parsedQuestions.length} سؤال بنجاح من الذكاء الخارجي! 🎉`, 'success');
                
                // Switch to questions tab to show the results
                switchTab('questions');
                
            } catch (error) {
                console.error('خطأ في تحليل رد الذكاء الاصطناعي:', error);
                showNotification('حدث خطأ في تحليل النص. تأكد من التنسيق الصحيح', 'error');
            }
        }

        // Update preview with enhanced formatting
        function updatePreview() {
            console.log('تحديث المعاينة...');
            
            try {
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    console.error('عنصر المعاينة غير موجود');
                    return;
                }
                
                const examTitle = document.getElementById('examTitle').value || 'عنوان الامتحان';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const duration = document.getElementById('duration').value || '90';
                const totalMarks = document.getElementById('totalMarks').value || '100';
                const teacherName = document.getElementById('teacherName').value || 'اسم المعلم';
                const schoolName = document.getElementById('schoolName').value || 'اسم المدرسة';
                const examDate = document.getElementById('examDate')?.value || '';
                
                // Get advanced formatting options
                const headerFontFamily = document.getElementById('headerFontFamily')?.value || 'Cairo';
                const headerFontSize = parseInt(document.getElementById('headerFontSize')?.value || '24');
                const questionFontFamily = document.getElementById('questionFontFamily')?.value || 'Cairo';
                const questionFontSize = parseInt(document.getElementById('questionFontSize')?.value || '18');
                const optionFontFamily = document.getElementById('optionFontFamily')?.value || 'Cairo';
                const optionFontSize = parseInt(document.getElementById('optionFontSize')?.value || '16');
                const sectionFontFamily = document.getElementById('sectionFontFamily')?.value || 'Cairo';
                const sectionFontSize = parseInt(document.getElementById('sectionFontSize')?.value || '18');
                
                const headerStyle = document.getElementById('headerStyle')?.value || 'modern';
                const headerBgColor = document.getElementById('headerBgColor')?.value || '#f8fafc';
                const headerBorderColor = document.getElementById('headerBorderColor')?.value || '#e5e7eb';
                
                const showQuestionFrames = document.getElementById('showQuestionFrames')?.checked || false;
                const showMarks = document.getElementById('showMarks')?.checked || true;
                const showInstructions = document.getElementById('showInstructions')?.checked || false;
                const questionBold = document.getElementById('questionBold')?.checked || true;
                
                const questionNumbering = document.getElementById('questionNumbering')?.value || 'arabic';
                const optionSymbols = document.getElementById('optionSymbols')?.value || 'letters';
                const optionStyle = document.getElementById('optionStyle')?.value || 'vertical';
                const optionBoxStyle = document.getElementById('optionBoxStyle')?.value || 'circle';
                const optionBoxSize = document.getElementById('optionBoxSize')?.value || 'medium';
                const answerMarkType = document.getElementById('answerMarkType')?.value || 'arabic-letters';
                
                const shortAnswerSpace = document.getElementById('shortAnswerSpace')?.value || 'medium';
                const essayLines = document.getElementById('essayLines')?.value || '5';
                
                // Get organization options
                const groupByType = document.getElementById('groupByType')?.checked !== false;
                const showSectionHeaders = document.getElementById('showSectionHeaders')?.checked !== false;
                const showSectionInstructions = document.getElementById('showSectionInstructions')?.checked || false;
                
                // Get header options
                const showSubject = document.getElementById('showSubject')?.checked !== false;
                const showGrade = document.getElementById('showGrade')?.checked !== false;
                const showDuration = document.getElementById('showDuration')?.checked !== false;
                const showTotalMarks = document.getElementById('showTotalMarks')?.checked !== false;
                const showTeacher = document.getElementById('showTeacher')?.checked !== false;
                const showSchool = document.getElementById('showSchool')?.checked !== false;
                const showDate = document.getElementById('showDate')?.checked !== false;
                const showLogo = document.getElementById('showLogo')?.checked !== false;
                
                const showStudentName = document.getElementById('showStudentName')?.checked !== false;
                const showStudentId = document.getElementById('showStudentId')?.checked !== false;
                const showStudentClass = document.getElementById('showStudentClass')?.checked || false;
                const showStudentSeat = document.getElementById('showStudentSeat')?.checked || false;

                // Get logo and footer options
                const logoPosition = document.getElementById('logoPosition')?.value || 'center';
                const logoSize = parseInt(document.getElementById('logoSize')?.value || '80');
                const logoShape = document.getElementById('logoShape')?.value || 'normal';
                const showTeacherSignature = document.getElementById('showTeacherSignature')?.checked !== false;
                const showGoodLuck = document.getElementById('showGoodLuck')?.checked !== false;
                
                // Build header info
                const leftItems = [];
                const rightItems = [];
                
                if (showSubject) leftItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>المادة:</strong> ${subject}</p>`);
                if (showGrade) leftItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>الصف:</strong> ${grade}</p>`);
                if (showDuration) leftItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>المدة:</strong> ${duration} دقيقة</p>`);
                if (showDate && examDate) leftItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>التاريخ:</strong> ${formatDate(examDate)}</p>`);
                
                if (showTeacher) rightItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>المعلم:</strong> ${teacherName}</p>`);
                if (showSchool) rightItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>المدرسة:</strong> ${schoolName}</p>`);
                if (showTotalMarks) rightItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>الدرجة الكلية:</strong> ${totalMarks}</p>`);
                
                // Header style classes
                const headerStyleClasses = {
                    'classic': 'border-4 border-double',
                    'modern': 'border-2 rounded-lg shadow-sm',
                    'minimal': 'border-b-2',
                    'formal': 'border-2 border-black'
                };
                
                let previewHTML = `
                    <!-- Enhanced Header -->
                    <div class="exam-header ${headerStyleClasses[headerStyle] || 'border-2 rounded-lg'}" 
                         style="background-color: ${headerBgColor}; border-color: ${headerBorderColor}; font-family: ${headerFontFamily}; padding: 20px; margin-bottom: 25px;">
                        
                        <!-- Title and Logo Section -->
                        <div class="text-center mb-4">
                            <h1 style="font-family: ${headerFontFamily}; font-size: ${headerFontSize}px; font-weight: bold; color: #1f2937; margin-bottom: 12px; line-height: 1.2;">${examTitle}</h1>
                            ${(showLogo && schoolLogoData) ? `
                                <div class="logo-container flex ${logoPosition === 'center' ? 'justify-center' : logoPosition === 'right' ? 'justify-end' : 'justify-start'} mb-3">
                                    <img src="${schoolLogoData}" alt="شعار المدرسة" 
                                         style="height: ${logoSize}px; width: auto; max-width: ${logoSize * 1.5}px; object-fit: contain; 
                                                ${logoShape === 'circle' ? 'border-radius: 50%;' : logoShape === 'rounded' ? 'border-radius: 12px;' : ''}">
                                </div>
                            ` : ''}
                        </div>
                        
                        ${(leftItems.length > 0 || rightItems.length > 0) ? `
                        <div class="header-info grid grid-cols-2 gap-6 text-gray-700 bg-white p-4 rounded-lg border shadow-sm" style="margin: 15px 0;">
                            <div class="text-right space-y-2">${leftItems.join('')}</div>
                            <div class="text-left space-y-2">${rightItems.join('')}</div>
                        </div>
                        ` : ''}
                        
                        <!-- Student Info -->
                        ${(showStudentName || showStudentId || showStudentClass || showStudentSeat) ? `
                        <div class="student-info mt-4 p-3 bg-gray-50 rounded border">
                            <div class="grid grid-cols-2 gap-4">
                                ${showStudentName ? `<div style="font-family: ${headerFontFamily}; font-size: ${Math.max(11, headerFontSize - 10)}px;"><strong>اسم الطالب:</strong> <span class="border-b-2 border-gray-400 inline-block w-40 h-5 ml-2"></span></div>` : ''}
                                ${showStudentId ? `<div style="font-family: ${headerFontFamily}; font-size: ${Math.max(11, headerFontSize - 10)}px;"><strong>الرقم الجامعي:</strong> <span class="border-b-2 border-gray-400 inline-block w-32 h-5 ml-2"></span></div>` : ''}
                                ${showStudentClass ? `<div style="font-family: ${headerFontFamily}; font-size: ${Math.max(11, headerFontSize - 10)}px;"><strong>الشعبة:</strong> <span class="border-b-2 border-gray-400 inline-block w-24 h-5 ml-2"></span></div>` : ''}
                                ${showStudentSeat ? `<div style="font-family: ${headerFontFamily}; font-size: ${Math.max(11, headerFontSize - 10)}px;"><strong>رقم المقعد:</strong> <span class="border-b-2 border-gray-400 inline-block w-20 h-5 ml-2"></span></div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Instructions
                if (showInstructions) {
                    previewHTML += `
                        <div class="mb-4 p-3 bg-blue-50 rounded border border-blue-200">
                            <h3 class="font-bold text-blue-800 mb-2 text-sm">تعليمات الامتحان:</h3>
                            <ul class="text-xs text-blue-700 space-y-1">
                                <li>• اقرأ جميع الأسئلة بعناية قبل البدء في الإجابة</li>
                                <li>• أجب عن جميع الأسئلة المطلوبة</li>
                                <li>• استخدم القلم الأزرق أو الأسود فقط</li>
                                <li>• مدة الامتحان ${duration} دقيقة</li>
                            </ul>
                        </div>
                    `;
                }
                
                // Questions with grouping
                if (questions.length > 0) {
                    previewHTML += '<div class="questions-section">';
                    
                    if (groupByType) {
                        const groupedQuestions = groupQuestionsByType(questions);
                        let questionCounter = 1;
                        
                        Object.keys(groupedQuestions).forEach(type => {
                            const typeQuestions = groupedQuestions[type];
                            if (typeQuestions.length > 0) {
                                // Section header with edit capability
                                if (showSectionHeaders) {
                                    const sectionTitle = getSectionTitle(type);
                                    const sectionBgColor = document.getElementById('sectionBgColor')?.value || '#f3f4f6';
                                    const sectionBorderColor = document.getElementById('sectionBorderColor')?.value || '#3b82f6';
                                    const sectionStyle = document.getElementById('sectionStyle')?.value || 'modern';
                                    
                                    const sectionStyleClasses = getSectionStyleClasses(sectionStyle, sectionBgColor, sectionBorderColor);
                                    
                                    previewHTML += `
                                        <div class="section-header editable-section-title cursor-pointer hover:bg-gray-100 transition-colors" 
                                             style="font-family: ${sectionFontFamily}; font-size: ${sectionFontSize}px; ${sectionStyleClasses}" 
                                             onclick="editSectionTitle('${type}')" 
                                             title="انقر لتعديل عنوان القسم">
                                            ${sectionTitle}
                                            <i class="fas fa-edit text-xs text-gray-400 mr-2 opacity-0 group-hover:opacity-100"></i>
                                        </div>
                                    `;
                                    
                                    if (showSectionInstructions) {
                                        const instruction = getSectionInstruction(type);
                                        if (instruction) {
                                            previewHTML += `
                                                <div class="mb-3 text-sm text-gray-600 italic cursor-pointer hover:bg-gray-100 p-2 rounded transition-colors" 
                                                     onclick="editSectionInstruction('${type}')" 
                                                     title="انقر لتعديل تعليمات القسم">
                                                    ${instruction}
                                                    <i class="fas fa-edit text-xs text-gray-400 mr-2 opacity-0 hover:opacity-100"></i>
                                                </div>
                                            `;
                                        }
                                    }
                                }
                                
                                // Add section marks summary if enabled
                                if (showMarks) {
                                    const sectionTotal = typeQuestions.reduce((sum, q) => sum + (q.hideMarks ? 0 : (q.marks || 0)), 0);
                                    const sectionCount = typeQuestions.filter(q => !q.hideMarks).length;
                                    if (sectionTotal > 0) {
                                        previewHTML += `
                                            <div class="mb-3 text-sm text-gray-600 bg-blue-50 p-2 rounded border">
                                                <strong>مجموع درجات هذا القسم: ${sectionTotal} درجة (${sectionCount} سؤال)</strong>
                                            </div>
                                        `;
                                    }
                                }
                                
                                // Questions in this section
                                typeQuestions.forEach((question, index) => {
                                    previewHTML += renderQuestion(question, questionCounter, {
                                        showQuestionFrames,
                                        showMarks,
                                        questionNumbering,
                                        optionSymbols,
                                        shortAnswerSpace,
                                        essayLines,
                                        questionFontFamily,
                                        questionFontSize,
                                        optionFontFamily,
                                        optionFontSize,
                                        sectionFontFamily,
                                        sectionFontSize,
                                        questionBold,
                                        optionStyle,
                                        optionBoxStyle,
                                        optionBoxSize,
                                        answerMarkType
                                    });
                                    
                                    // Add page break indicator every 6-8 questions (approximate)
                                    if ((questionCounter % 7 === 0) && (questionCounter < questions.length)) {
                                        previewHTML += '<div class="page-break-indicator no-print"></div>';
                                    }
                                    
                                    questionCounter++;
                                });
                            }
                        });
                    } else {
                        questions.forEach((question, index) => {
                            previewHTML += renderQuestion(question, index + 1, {
                                showQuestionFrames,
                                showMarks,
                                questionNumbering,
                                optionSymbols,
                                shortAnswerSpace,
                                essayLines,
                                questionFontFamily,
                                questionFontSize,
                                optionFontFamily,
                                optionFontSize,
                                sectionFontFamily,
                                sectionFontSize,
                                questionBold,
                                optionStyle,
                                optionBoxStyle,
                                optionBoxSize,
                                answerMarkType
                            });
                        });
                    }
                    
                    previewHTML += '</div>';
                    
                    // Add total marks summary
                    if (showMarks) {
                        const totalCalculatedMarks = questions.reduce((sum, q) => sum + (q.hideMarks ? 0 : (q.marks || 0)), 0);
                        const visibleQuestionsCount = questions.filter(q => !q.hideMarks).length;
                        
                        if (totalCalculatedMarks > 0) {
                            previewHTML += `
                                <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="text-center">
                                        <h3 style="font-family: ${headerFontFamily}; font-size: ${Math.max(16, headerFontSize - 4)}px; font-weight: bold; color: #065f46; margin-bottom: 8px;">
                                            ملخص الدرجات
                                        </h3>
                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <strong>إجمالي الدرجات:</strong> ${totalCalculatedMarks} درجة
                                            </div>
                                            <div>
                                                <strong>عدد الأسئلة:</strong> ${visibleQuestionsCount} سؤال
                                            </div>
                                        </div>
                                        ${visibleQuestionsCount > 0 ? `
                                            <div class="mt-2 text-xs text-green-700">
                                                متوسط الدرجة لكل سؤال: ${(totalCalculatedMarks / visibleQuestionsCount).toFixed(1)} درجة
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // Add footer section
                    if (showTeacherSignature || showGoodLuck) {
                        previewHTML += `
                            <div class="exam-footer mt-8 pt-6 border-t border-gray-300">
                                ${showGoodLuck ? `
                                    <div class="text-center mb-6">
                                        <p style="font-family: ${headerFontFamily}; font-size: ${Math.max(14, headerFontSize - 6)}px; color: #059669; font-weight: bold;">
                                            🌟 بالتوفيق والنجاح 🌟
                                        </p>
                                    </div>
                                ` : ''}
                                ${showTeacherSignature ? `
                                    <div class="flex justify-between items-center">
                                        <div class="text-right">
                                            <p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px; color: #374151;">
                                                <strong>المعلم:</strong> ${teacherName}
                                            </p>
                                            <div class="mt-2 border-b-2 border-gray-400 w-32 h-6"></div>
                                            <p class="text-xs text-gray-500 mt-1">التوقيع</p>
                                        </div>
                                        <div class="text-left">
                                            <p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px; color: #374151;">
                                                <strong>التاريخ:</strong> ${examDate ? formatDate(examDate) : '___________'}
                                            </p>
                                        </div>
                                    </div>
                                ` : ''}
                                <!-- Developer Credit -->
                                <div class="text-center mt-6 pt-4 border-t border-gray-200">
                                    <p class="text-xs text-gray-400">تم إنشاء هذا الامتحان باستخدام منشئ الامتحانات الذكي المتطور</p>
                                    <p class="text-xs text-gray-500 mt-1">المطور: أ. عبد الرحمن نصر الله</p>
                                </div>
                            </div>
                        `;
                    } else {
                        // Add developer credit even if no footer is shown
                        previewHTML += `
                            <div class="exam-footer mt-8 pt-6 border-t border-gray-300">
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">تم إنشاء هذا الامتحان باستخدام منشئ الامتحانات الذكي المتطور</p>
                                    <p class="text-xs text-gray-500 mt-1">المطور: أ. عبد الرحمن نصر الله</p>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    previewHTML += `
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-file-alt text-4xl mb-3 opacity-30"></i>
                            <p class="text-lg">لا توجد أسئلة للعرض</p>
                            <p class="text-sm">أضف أسئلة من اللوحة الجانبية لرؤية المعاينة</p>
                        </div>
                    `;
                }
                
                examPreview.innerHTML = previewHTML;
                console.log('تم تحديث المعاينة بنجاح');
                
            } catch (error) {
                console.error('خطأ في تحديث المعاينة:', error);
            }
        }

        // Group questions by type
        function groupQuestionsByType(questions) {
            const groups = {
                'mcq': [],
                'true-false': [],
                'short': [],
                'essay': [],
                'fill': []
            };
            
            questions.forEach(question => {
                if (groups[question.type]) {
                    groups[question.type].push(question);
                }
            });
            
            return groups;
        }

        // Section titles and instructions with editing capability
        let sectionTitles = {
            'mcq': 'أولاً: أسئلة الاختيار من متعدد',
            'true-false': 'ثانياً: أسئلة صح أم خطأ',
            'short': 'ثالثاً: أسئلة الإجابة القصيرة',
            'fill': 'رابعاً: أسئلة أكمل الفراغ',
            'essay': 'خامساً: أسئلة المقال'
        };

        let sectionInstructions = {
            'mcq': 'ضع دائرة حول رمز الإجابة الصحيحة:',
            'true-false': 'ضع علامة (✓) أمام العبارة الصحيحة وعلامة (✗) أمام العبارة الخاطئة:',
            'short': 'أجب عن الأسئلة التالية إجابة قصيرة:',
            'fill': 'أكمل الفراغات التالية بما يناسبها:',
            'essay': 'أجب عن الأسئلة التالية إجابة مفصلة:'
        };

        // Get section titles
        function getSectionTitle(type) {
            return sectionTitles[type] || 'أسئلة متنوعة';
        }

        // Edit section title
        function editSectionTitle(type) {
            const currentTitle = sectionTitles[type];
            const newTitle = prompt('أدخل عنوان القسم الجديد:', currentTitle);
            if (newTitle !== null && newTitle.trim()) {
                sectionTitles[type] = newTitle.trim();
                updatePreview();
                showNotification('تم تحديث عنوان القسم بنجاح', 'success');
            }
        }

        // Get section instructions
        function getSectionInstruction(type) {
            return sectionInstructions[type] || '';
        }

        // Edit section instruction
        function editSectionInstruction(type) {
            const currentInstruction = sectionInstructions[type];
            const newInstruction = prompt('أدخل تعليمات القسم الجديدة:', currentInstruction);
            if (newInstruction !== null) {
                sectionInstructions[type] = newInstruction.trim();
                updatePreview();
                showNotification('تم تحديث تعليمات القسم بنجاح', 'success');
            }
        }

        // Get answer mark based on type (without symbols)
        function getAnswerMark(index, markType) {
            const arabicLetters = ['أ', 'ب', 'ج', 'د', 'هـ', 'و'];
            
            switch (markType) {
                case 'numbers':
                    return (index + 1).toString();
                case 'arabic-letters':
                    return arabicLetters[index] || (index + 1).toString();
                case 'english-letters':
                    return String.fromCharCode(65 + index);
                case 'empty':
                    return '';
                default:
                    return arabicLetters[index] || (index + 1).toString();
            }
        }

        // Render individual question with enhanced formatting
        function renderQuestion(question, questionNumber, options) {
            const {
                showQuestionFrames, showMarks, questionNumbering, optionSymbols, shortAnswerSpace, essayLines,
                questionFontFamily, questionFontSize, optionFontFamily, optionFontSize, sectionFontFamily, sectionFontSize,
                questionBold, optionStyle, optionBoxStyle, optionBoxSize, answerMarkType
            } = options;
            
            const frameClass = showQuestionFrames ? 'question-with-frame' : '';
            
            let marksHtml = '';
            if (showMarks && !question.hideMarks) {
                marksHtml = `<span class="float-left text-sm text-gray-600">(${question.marks} درجات)</span>`;
            }
            
            // Format question number
            const formattedNumber = getQuestionNumber(questionNumber, questionNumbering);
            
            // Box size mapping
            const boxSizes = {
                'small': 'w-4 h-4',
                'medium': 'w-6 h-6',
                'large': 'w-8 h-8'
            };
            
            // Box shape styles
            const boxShapes = {
                'circle': 'rounded-full',
                'square': 'rounded-sm',
                'none': 'border-0'
            };
            
            let questionHtml = `
                <div class="question-container mb-6 ${frameClass}">
                    <div class="flex justify-between items-start mb-3">
                        <h4 style="font-family: ${questionFontFamily}; font-size: ${questionFontSize}px; ${questionBold ? 'font-weight: bold;' : ''} color: #1f2937; flex: 1;">
                            ${formattedNumber} ${question.text}
                        </h4>
                        ${marksHtml}
                    </div>
                    <div class="question-content">
            `;
            
            if (question.type === 'mcq') {
                const optionLayoutClass = getOptionLayoutClass(optionStyle);
                
                questionHtml += `<div class="${optionLayoutClass}">`;
                question.options.forEach((option, i) => {
                    const answerMark = getAnswerMark(i, answerMarkType);
                    const boxClass = optionBoxStyle !== 'none' ? 
                        `answer-mark ${optionBoxStyle} ${boxSizes[optionBoxSize]}` : '';
                    
                    questionHtml += `
                        <div class="option-item flex items-center" style="background: transparent; padding: 2px 0; margin-bottom: 6px;">
                            ${optionBoxStyle !== 'none' ? `<span class="${boxClass}">${answerMark}</span>` : ''}
                            <span style="font-family: ${optionFontFamily}; font-size: ${optionFontSize}px;">${answerMark ? answerMark + ' ' : ''}${option}</span>
                        </div>
                    `;
                });
                questionHtml += `</div>`;
                
            } else if (question.type === 'true-false') {
                const layoutClass = optionStyle === 'horizontal' ? 'flex items-center space-x-8 space-x-reverse' : 'space-y-2';
                const boxClass = optionBoxStyle !== 'none' ? 
                    `answer-mark ${optionBoxStyle} ${boxSizes[optionBoxSize]}` : '';
                
                const trueMark = getAnswerMark(0, answerMarkType);
                const falseMark = getAnswerMark(1, answerMarkType);
                
                questionHtml += `
                    <div class="${layoutClass}">
                        <div class="flex items-center" style="background: transparent; padding: 2px 0;">
                            ${optionBoxStyle !== 'none' ? `<span class="${boxClass}">${trueMark}</span>` : ''}
                            <span style="font-family: ${optionFontFamily}; font-size: ${optionFontSize}px;">${trueMark ? trueMark + ' ' : ''}صح</span>
                        </div>
                        <div class="flex items-center" style="background: transparent; padding: 2px 0;">
                            ${optionBoxStyle !== 'none' ? `<span class="${boxClass}">${falseMark}</span>` : ''}
                            <span style="font-family: ${optionFontFamily}; font-size: ${optionFontSize}px;">${falseMark ? falseMark + ' ' : ''}خطأ</span>
                        </div>
                    </div>
                `;
                
            } else if (question.type === 'short') {
                const spaceMap = {'small': 1, 'medium': 2, 'large': 3};
                const lineCount = spaceMap[shortAnswerSpace] || 2;
                
                questionHtml += `<div class="answer-lines">`;
                for (let i = 0; i < lineCount; i++) {
                    questionHtml += `<div class="answer-line" style="height: 35px; border-bottom: 2px solid #9ca3af; margin-bottom: 8px;"></div>`;
                }
                questionHtml += `</div>`;
                
            } else if (question.type === 'essay') {
                const lineCount = parseInt(essayLines) || 5;
                questionHtml += `<div class="answer-lines">`;
                for (let i = 0; i < lineCount; i++) {
                    questionHtml += `<div class="answer-line" style="height: 35px; border-bottom: 2px solid #9ca3af; margin-bottom: 8px;"></div>`;
                }
                questionHtml += `</div>`;
                
            } else if (question.type === 'fill') {
                const textWithBlanks = question.text.replace(/_____/g, '<span class="border-b-2 border-gray-300 inline-block w-24 h-6"></span>');
                questionHtml = questionHtml.replace(question.text, textWithBlanks);
            }
            
            questionHtml += `
                    </div>
                </div>
            `;
            
            return questionHtml;
        }

        // Helper function for option layout
        function getOptionLayoutClass(style) {
            switch (style) {
                case 'horizontal':
                    return 'options-horizontal';
                case 'grid-2':
                    return 'options-grid-2';
                case 'grid-4':
                    return 'options-grid-4';
                case 'vertical':
                default:
                    return 'options-vertical';
            }
        }

        // Helper functions for formatting
        function getQuestionNumber(num, style) {
            switch (style) {
                case 'arabic':
                    return num + '.';
                case 'letters':
                    return String.fromCharCode(64 + num) + ')';
                case 'roman':
                    return toRoman(num) + '.';
                default:
                    return num + '.';
            }
        }

        function getOptionSymbol(index, style) {
            switch (style) {
                case 'letters':
                    return String.fromCharCode(65 + index) + ')';
                case 'numbers':
                    return (index + 1) + ')';
                case 'circles':
                    return '○';
                case 'empty':
                    return '';
                default:
                    return String.fromCharCode(65 + index) + ')';
            }
        }

        function toRoman(num) {
            const values = [10, 9, 5, 4, 1];
            const symbols = ['X', 'IX', 'V', 'IV', 'I'];
            let result = '';
            
            for (let i = 0; i < values.length; i++) {
                while (num >= values[i]) {
                    result += symbols[i];
                    num -= values[i];
                }
            }
            return result;
        }

        // Download exam as separate page images with enhanced rendering
        async function downloadAsImages() {
            try {
                // Show loading message
                const originalButton = document.querySelector('button[onclick="downloadAsImages()"]');
                const originalText = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>جاري التحضير...';
                originalButton.disabled = true;
                
                // Get the entire exam preview
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    throw new Error('عنصر المعاينة غير موجود');
                }
                
                // Check if there's content to capture
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    throw new Error('لا يوجد محتوى للتصدير. يرجى إضافة أسئلة أولاً');
                }
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>تحليل المحتوى...';
                
                // Create dynamic pages based on actual content height
                const pages = await createDynamicPages();
                
                if (pages.length === 0) {
                    throw new Error('فشل في تقسيم المحتوى إلى صفحات');
                }
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>إنشاء الصور...';
                
                // Generate filename base
                const examTitle = document.getElementById('examTitle').value || 'امتحان';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const timestamp = new Date().toISOString().slice(0, 10);
                const baseFilename = `${examTitle}_${subject}_${grade}_${timestamp}`;
                
                // Process each page with enhanced rendering
                for (let i = 0; i < pages.length; i++) {
                    try {
                        originalButton.innerHTML = `<i class="fas fa-spinner fa-spin ml-1"></i>صفحة ${i + 1}/${pages.length}...`;
                        
                        // Create optimized container for this page with proper A4 dimensions
                        const pageContainer = document.createElement('div');
                        pageContainer.style.cssText = `
                            position: absolute;
                            top: -10000px;
                            left: -10000px;
                            width: 794px;
                            min-height: 1123px;
                            background: #ffffff;
                            padding: 60px;
                            font-family: 'Cairo', 'Amiri', 'Tajawal', Arial, sans-serif;
                            direction: rtl;
                            text-align: right;
                            color: #000000;
                            line-height: 1.6;
                            box-sizing: border-box;
                            font-size: 16px;
                            overflow: visible;
                            border: none;
                            box-shadow: none;
                        `;
                        
                        pageContainer.innerHTML = pages[i];
                        document.body.appendChild(pageContainer);
                        
                        // Wait for fonts and rendering
                        await new Promise(resolve => setTimeout(resolve, 1200));
                        
                        // Enhanced html2canvas settings for better Arabic text rendering
                        const canvas = await html2canvas(pageContainer, {
                            scale: 3,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff',
                            width: 794,
                            height: Math.max(1123, pageContainer.scrollHeight + 120),
                            scrollX: 0,
                            scrollY: 0,
                            logging: false,
                            removeContainer: true,
                            imageTimeout: 20000,
                            foreignObjectRendering: true,
                            letterRendering: true,
                            onclone: function(clonedDoc) {
                                // Ensure proper font loading and Arabic text rendering
                                const clonedContainer = clonedDoc.querySelector('div');
                                if (clonedContainer) {
                                    clonedContainer.style.fontFamily = 'Cairo, Amiri, Tajawal, Arial, sans-serif';
                                    clonedContainer.style.fontWeight = 'normal';
                                    clonedContainer.style.textRendering = 'optimizeLegibility';
                                    clonedContainer.style.webkitFontSmoothing = 'antialiased';
                                    clonedContainer.style.mozOsxFontSmoothing = 'grayscale';
                                    
                                    // Fix any potential layout issues
                                    const allElements = clonedContainer.querySelectorAll('*');
                                    allElements.forEach(el => {
                                        if (el.style) {
                                            el.style.webkitTransform = 'none';
                                            el.style.transform = 'none';
                                            el.style.webkitFilter = 'none';
                                            el.style.filter = 'none';
                                        }
                                    });
                                }
                            }
                        });
                        
                        // Remove container
                        document.body.removeChild(pageContainer);
                        
                        if (canvas && canvas.width > 0 && canvas.height > 0) {
                            // Convert to high-quality PNG
                            const imageDataUrl = canvas.toDataURL('image/png', 1.0);
                            
                            // Download the image
                            const filename = `${baseFilename}_صفحة_${i + 1}.png`;
                            const link = document.createElement('a');
                            link.download = filename;
                            link.href = imageDataUrl;
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            // Small delay between downloads
                            await new Promise(resolve => setTimeout(resolve, 300));
                        } else {
                            throw new Error(`فشل في إنشاء الصورة للصفحة ${i + 1}`);
                        }
                        
                    } catch (pageError) {
                        console.error(`خطأ في إنشاء الصفحة ${i + 1}:`, pageError);
                        showNotification(`خطأ في الصفحة ${i + 1}: ${pageError.message}`, 'warning');
                        // Continue with next page
                    }
                }
                
                // Reset button
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
                
                showNotification(`تم تحميل ${pages.length} صفحة بنجاح! 🖼️✨`, 'success');
                
            } catch (error) {
                console.error('خطأ في إنشاء الصور:', error);
                showNotification(`حدث خطأ في إنشاء الصور: ${error.message}`, 'error');
                
                // Reset button
                const button = document.querySelector('button[onclick="downloadAsImages()"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-images ml-1"></i>تحميل كصور عالية الجودة';
                    button.disabled = false;
                }
            }
        }

        // Simple image download function - FIXED VERSION
        async function downloadAsImages() {
            try {
                // Check if html2canvas is available
                if (typeof html2canvas === 'undefined') {
                    showNotification('مكتبة html2canvas غير محملة. يرجى إعادة تحميل الصفحة', 'error');
                    return;
                }

                // Show loading message
                const originalButton = document.querySelector('button[onclick="downloadAsImages()"]');
                const originalText = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>جاري التحضير...';
                originalButton.disabled = true;
                
                // Get the entire exam preview
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    throw new Error('عنصر المعاينة غير موجود');
                }
                
                // Check if there's content to capture
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    throw new Error('لا يوجد محتوى للتصدير. يرجى إضافة أسئلة أولاً');
                }
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>تحضير المحتوى...';
                
                // Hide page break indicators
                examPreview.classList.add('capturing-images');
                
                // Generate filename base
                const examTitle = document.getElementById('examTitle').value || 'امتحان';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const timestamp = new Date().toISOString().slice(0, 10);
                const baseFilename = `${examTitle}_${subject}_${grade}_${timestamp}`;
                
                // Simple approach: capture the entire content as one image first
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>إنشاء الصورة...';
                
                try {
                    // Create a clean container for capture
                    const captureContainer = document.createElement('div');
                    captureContainer.style.cssText = `
                        position: absolute;
                        top: -9999px;
                        left: -9999px;
                        width: 800px;
                        background: #ffffff;
                        padding: 40px;
                        font-family: 'Cairo', Arial, sans-serif;
                        direction: rtl;
                        text-align: right;
                        color: #000000;
                        line-height: 1.5;
                        box-sizing: border-box;
                    `;
                    
                    // Clone the content without page break indicators
                    const cleanContent = examPreview.cloneNode(true);
                    const pageBreaks = cleanContent.querySelectorAll('.page-break-indicator');
                    pageBreaks.forEach(pb => pb.remove());
                    
                    captureContainer.appendChild(cleanContent);
                    document.body.appendChild(captureContainer);
                    
                    // Wait for rendering
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Capture with html2canvas
                    const canvas = await html2canvas(captureContainer, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        width: captureContainer.scrollWidth,
                        height: captureContainer.scrollHeight
                    });
                    
                    // Remove container
                    document.body.removeChild(captureContainer);
                    
                    if (canvas && canvas.width > 0 && canvas.height > 0) {
                        // Convert to PNG
                        const imageDataUrl = canvas.toDataURL('image/png', 1.0);
                        
                        // Download the image
                        const filename = `${baseFilename}.png`;
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = imageDataUrl;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        showNotification('تم تحميل الصورة بنجاح! 🖼️✨', 'success');
                    } else {
                        throw new Error('فشل في إنشاء الصورة');
                    }
                    
                } catch (captureError) {
                    console.error('خطأ في التقاط الصورة:', captureError);
                    throw captureError;
                }
                
                // Remove capturing class
                examPreview.classList.remove('capturing-images');
                
                // Reset button
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
                
            } catch (error) {
                console.error('خطأ في إنشاء الصور:', error);
                showNotification(`حدث خطأ في إنشاء الصور: ${error.message}`, 'error');
                
                // Remove capturing class
                const examPreview = document.getElementById('examPreview');
                if (examPreview) {
                    examPreview.classList.remove('capturing-images');
                }
                
                // Reset button
                const button = document.querySelector('button[onclick="downloadAsImages()"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-images ml-1"></i>صور PNG (html2canvas)';
                    button.disabled = false;
                }
            }
        }

        // Simple print function
        function printExam() {
            try {
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    showNotification('عنصر المعاينة غير موجود', 'error');
                    return;
                }
                
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    showNotification('لا يوجد محتوى للطباعة. يرجى إضافة أسئلة أولاً', 'error');
                    return;
                }
                
                // Hide page break indicators
                examPreview.classList.add('capturing-images');
                
                // Use window.print()
                window.print();
                
                // Remove capturing class after print dialog
                setTimeout(() => {
                    examPreview.classList.remove('capturing-images');
                }, 1000);
                
            } catch (error) {
                console.error('خطأ في الطباعة:', error);
                showNotification('حدث خطأ في الطباعة', 'error');
            }
        }

        // Alternative PDF generation using html2pdf.js (if available)
        async function saveToAdvancedPDF() {
            try {
                // Check if html2pdf is available
                if (typeof html2pdf === 'undefined') {
                    showNotification('مكتبة html2pdf غير محملة. استخدم الخيار العادي', 'warning');
                    return saveToPDF(); // Fallback to regular function
                }

                // Show loading message
                const originalButton = document.querySelector('button[onclick="saveToAdvancedPDF()"]');
                const originalText = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>جاري إنشاء PDF متقدم...';
                originalButton.disabled = true;
                
                // Get the preview element
                const previewElement = document.getElementById('examPreview');
                if (!previewElement) {
                    throw new Error('عنصر المعاينة غير موجود');
                }
                
                // Check if there's content to export
                if (!previewElement.innerHTML.trim() || questions.length === 0) {
                    throw new Error('لا يوجد محتوى للتصدير. يرجى إضافة أسئلة أولاً');
                }
                
                // Add capturing class to hide page break indicators
                previewElement.classList.add('capturing-images');
                
                // Create filename
                const examTitle = document.getElementById('examTitle').value || 'امتحان';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `${examTitle}_${subject}_${grade}_${timestamp}_متقدم.pdf`;
                
                // Configure html2pdf options
                const options = {
                    margin: [15, 15, 15, 15],
                    filename: filename,
                    image: { type: 'png', quality: 0.9 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    }
                };
                
                // Generate PDF
                await html2pdf().set(options).from(previewElement).save();
                
                // Remove capturing class
                previewElement.classList.remove('capturing-images');
                
                // Reset button
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
                
                showNotification('تم إنشاء PDF المتقدم بنجاح! 📄✨', 'success');
                
            } catch (error) {
                console.error('خطأ في إنشاء PDF المتقدم:', error);
                showNotification(`حدث خطأ في إنشاء PDF المتقدم: ${error.message}`, 'error');
                
                // Remove capturing class in case of error
                const previewElement = document.getElementById('examPreview');
                if (previewElement) {
                    previewElement.classList.remove('capturing-images');
                }
                
                // Reset button
                const button = document.querySelector('button[onclick="saveToAdvancedPDF()"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-file-pdf ml-1"></i>PDF متقدم (html2pdf)';
                    button.disabled = false;
                }
            }
        }

        // Alternative image download using dom-to-image (if available)
        async function downloadAsImagesAdvanced() {
            try {
                // Check if dom-to-image is available
                if (typeof domtoimage === 'undefined') {
                    showNotification('مكتبة dom-to-image غير محملة. استخدم الخيار العادي', 'warning');
                    return downloadAsImages(); // Fallback to regular function
                }

                // Show loading message
                const originalButton = document.querySelector('button[onclick="downloadAsImagesAdvanced()"]');
                const originalText = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>جاري التحضير المتقدم...';
                originalButton.disabled = true;
                
                // Get the entire exam preview
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    throw new Error('عنصر المعاينة غير موجود');
                }
                
                // Check if there's content to capture
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    throw new Error('لا يوجد محتوى للتصدير. يرجى إضافة أسئلة أولاً');
                }
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>تحضير المحتوى المتقدم...';
                
                // Hide page break indicators
                examPreview.classList.add('capturing-images');
                
                // Generate filename base
                const examTitle = document.getElementById('examTitle').value || 'امتحان';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const timestamp = new Date().toISOString().slice(0, 10);
                const baseFilename = `${examTitle}_${subject}_${grade}_${timestamp}_متقدم`;
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>إنشاء الصورة المتقدمة...';
                
                try {
                    // Create a clean container for capture
                    const captureContainer = document.createElement('div');
                    captureContainer.style.cssText = `
                        position: absolute;
                        top: -9999px;
                        left: -9999px;
                        width: 800px;
                        background: #ffffff;
                        padding: 40px;
                        font-family: 'Cairo', Arial, sans-serif;
                        direction: rtl;
                        text-align: right;
                        color: #000000;
                        line-height: 1.5;
                        box-sizing: border-box;
                    `;
                    
                    // Clone the content without page break indicators
                    const cleanContent = examPreview.cloneNode(true);
                    const pageBreaks = cleanContent.querySelectorAll('.page-break-indicator');
                    pageBreaks.forEach(pb => pb.remove());
                    
                    captureContainer.appendChild(cleanContent);
                    document.body.appendChild(captureContainer);
                    
                    // Wait for rendering
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Use dom-to-image
                    const dataUrl = await domtoimage.toPng(captureContainer, {
                        quality: 1.0,
                        bgcolor: '#ffffff',
                        cacheBust: true,
                        width: captureContainer.scrollWidth,
                        height: captureContainer.scrollHeight
                    });
                    
                    // Remove container
                    document.body.removeChild(captureContainer);
                    
                    if (dataUrl && dataUrl.length > 100) {
                        // Download the image
                        const filename = `${baseFilename}.png`;
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = dataUrl;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        showNotification('تم تحميل الصورة المتقدمة بنجاح! 🖼️✨', 'success');
                    } else {
                        throw new Error('فشل في إنشاء الصورة المتقدمة');
                    }
                    
                } catch (captureError) {
                    console.error('خطأ في التقاط الصورة المتقدمة:', captureError);
                    throw captureError;
                }
                
                // Remove capturing class
                examPreview.classList.remove('capturing-images');
                
                // Reset button
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
                
            } catch (error) {
                console.error('خطأ في إنشاء الصور المتقدمة:', error);
                showNotification(`حدث خطأ في إنشاء الصور المتقدمة: ${error.message}`, 'error');
                
                // Remove capturing class
                const examPreview = document.getElementById('examPreview');
                if (examPreview) {
                    examPreview.classList.remove('capturing-images');
                }
                
                // Reset button
                const button = document.querySelector('button[onclick="downloadAsImagesAdvanced()"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-images ml-1"></i>صور متقدمة (dom-to-image)';
                    button.disabled = false;
                }
            }
        }

        // Simple and reliable printing function
        function printExamAdvanced() {
            try {
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    showNotification('عنصر المعاينة غير موجود', 'error');
                    return;
                }
                
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    showNotification('لا يوجد محتوى للطباعة. يرجى إضافة أسئلة أولاً', 'error');
                    return;
                }
                
                // Hide page break indicators for printing
                examPreview.classList.add('capturing-images');
                
                // Use the standard print function with better styling
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>طباعة الامتحان</title>
                        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                        <style>
                            * {
                                font-family: 'Cairo', Arial, sans-serif !important;
                                direction: rtl !important;
                                text-align: right !important;
                            }
                            
                            body {
                                margin: 0;
                                padding: 20px;
                                font-size: 14px;
                                line-height: 1.5;
                                color: #000000;
                                background: #ffffff;
                            }
                            
                            .page-break-indicator {
                                display: none !important;
                            }
                            
                            .question-container {
                                page-break-inside: avoid;
                                break-inside: avoid;
                                margin-bottom: 20px;
                            }
                            
                            .exam-header {
                                page-break-after: avoid;
                            }
                            
                            .section-header {
                                page-break-after: avoid;
                                page-break-inside: avoid;
                            }
                            
                            @page {
                                size: A4;
                                margin: 15mm;
                            }
                            
                            @media print {
                                body { print-color-adjust: exact; }
                            }
                        </style>
                    </head>
                    <body>
                        ${examPreview.innerHTML}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                // Wait for content to load then print
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                    
                    // Remove capturing class
                    examPreview.classList.remove('capturing-images');
                    
                    showNotification('تم فتح نافذة الطباعة! 🖨️', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('خطأ في الطباعة:', error);
                showNotification(`حدث خطأ في الطباعة: ${error.message}`, 'error');
                
                // Remove capturing class
                const examPreview = document.getElementById('examPreview');
                if (examPreview) {
                    examPreview.classList.remove('capturing-images');
                }
            }
        }

        // Save as HTML file
        function saveAsHTML() {
            try {
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    showNotification('عنصر المعاينة غير موجود', 'error');
                    return;
                }
                
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    showNotification('لا يوجد محتوى للحفظ. يرجى إضافة أسئلة أولاً', 'error');
                    return;
                }
                
                // Create complete HTML document
                const htmlContent = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${document.getElementById('examTitle').value || 'امتحان'}</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700&family=Almarai:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Cairo', 'Amiri', 'Tajawal', Arial, sans-serif;
            direction: rtl;
            text-align: right;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
        }
        
        .page-break-indicator {
            display: none !important;
        }
        
        @media print {
            .question-container {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            @page {
                size: A4;
                margin: 15mm;
            }
        }
        
        .exam-header {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            background: #f8fafc;
        }
        
        .question-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #ffffff;
        }
        
        .section-header {
            background: #f3f4f6;
            padding: 12px 20px;
            margin: 20px 0 15px 0;
            border-right: 4px solid #3b82f6;
            font-weight: bold;
            font-size: 18px;
            color: #1f2937;
        }
        
        .answer-line {
            height: 30px;
            border-bottom: 1px solid #9ca3af;
            margin-bottom: 6px;
        }
        
        .answer-mark {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #374151;
            margin-left: 8px;
            text-align: center;
            line-height: 16px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .answer-mark.circle {
            border-radius: 50%;
        }
        
        .answer-mark.square {
            border-radius: 2px;
        }
    </style>
</head>
<body>
    ${examPreview.innerHTML.replace(/class="page-break-indicator[^"]*"/g, 'style="display:none"')}
</body>
</html>`;
                
                // Create filename
                const examTitle = document.getElementById('examTitle').value || 'امتحان';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `${examTitle}_${subject}_${grade}_${timestamp}.html`;
                
                // Create and download file
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                
                if (typeof saveAs !== 'undefined') {
                    saveAs(blob, filename);
                } else {
                    // Fallback method
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }
                
                showNotification('تم حفظ ملف HTML بنجاح! 📄', 'success');
                
            } catch (error) {
                console.error('خطأ في حفظ HTML:', error);
                showNotification(`حدث خطأ في حفظ HTML: ${error.message}`, 'error');
            }
        }

        // Simple and reliable PDF generation - FIXED VERSION
        async function saveToPDF() {
            try {
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    showNotification('مكتبة jsPDF غير محملة. يرجى إعادة تحميل الصفحة', 'error');
                    return;
                }

                // Show loading message
                const originalButton = document.querySelector('button[onclick="saveToPDF()"]');
                const originalText = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>جاري إنشاء PDF...';
                originalButton.disabled = true;
                
                // Get the preview element
                const previewElement = document.getElementById('examPreview');
                if (!previewElement) {
                    throw new Error('عنصر المعاينة غير موجود');
                }
                
                // Check if there's content to export
                if (!previewElement.innerHTML.trim() || questions.length === 0) {
                    throw new Error('لا يوجد محتوى للتصدير. يرجى إضافة أسئلة أولاً');
                }
                
                // Hide page break indicators
                previewElement.classList.add('capturing-images');
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>تحضير المحتوى...';
                
                // Create a clean container for PDF
                const pdfContainer = document.createElement('div');
                pdfContainer.style.cssText = `
                    position: absolute;
                    top: -9999px;
                    left: -9999px;
                    width: 800px;
                    background: #ffffff;
                    padding: 30px;
                    font-family: 'Cairo', Arial, sans-serif;
                    direction: rtl;
                    text-align: right;
                    color: #000000;
                    line-height: 1.5;
                    box-sizing: border-box;
                `;
                
                // Clone content without page break indicators
                const cleanContent = previewElement.cloneNode(true);
                const pageBreaks = cleanContent.querySelectorAll('.page-break-indicator');
                pageBreaks.forEach(pb => pb.remove());
                
                pdfContainer.appendChild(cleanContent);
                document.body.appendChild(pdfContainer);
                
                // Wait for rendering
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>إنشاء PDF...';
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Capture with html2canvas
                const canvas = await html2canvas(pdfContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    width: pdfContainer.scrollWidth,
                    height: pdfContainer.scrollHeight
                });
                
                // Remove container
                document.body.removeChild(pdfContainer);
                
                if (canvas && canvas.width > 0 && canvas.height > 0) {
                    const imgData = canvas.toDataURL('image/png', 0.9);
                    
                    // PDF dimensions
                    const pdfWidth = 210; // A4 width in mm
                    const pdfHeight = 297; // A4 height in mm
                    const margin = 15;
                    const contentWidth = pdfWidth - (margin * 2);
                    const contentHeight = pdfHeight - (margin * 2);
                    
                    // Calculate image dimensions
                    const imgWidth = contentWidth;
                    const imgHeight = (canvas.height * contentWidth) / canvas.width;
                    
                    // Add image to PDF, splitting across pages if needed
                    let yPosition = margin;
                    let remainingHeight = imgHeight;
                    let sourceY = 0;
                    let pageCount = 0;
                    
                    while (remainingHeight > 0) {
                        if (pageCount > 0) {
                            pdf.addPage();
                        }
                        
                        const availableHeight = contentHeight;
                        const currentPageHeight = Math.min(remainingHeight, availableHeight);
                        const sourceHeight = (currentPageHeight * canvas.width) / contentWidth;
                        
                        // Create section canvas
                        const sectionCanvas = document.createElement('canvas');
                        const sectionCtx = sectionCanvas.getContext('2d');
                        sectionCanvas.width = canvas.width;
                        sectionCanvas.height = sourceHeight;
                        
                        sectionCtx.drawImage(canvas, 0, sourceY, canvas.width, sourceHeight, 0, 0, canvas.width, sourceHeight);
                        
                        const sectionImgData = sectionCanvas.toDataURL('image/png', 0.9);
                        pdf.addImage(sectionImgData, 'PNG', margin, margin, imgWidth, currentPageHeight);
                        
                        remainingHeight -= currentPageHeight;
                        sourceY += sourceHeight;
                        pageCount++;
                    }
                    
                    // Add page numbers
                    const totalPages = pdf.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(10);
                        pdf.setTextColor(100);
                        pdf.text(`صفحة ${i} من ${totalPages}`, pdfWidth - margin - 30, pdfHeight - 5);
                    }
                    
                    // Create filename
                    const examTitle = document.getElementById('examTitle').value || 'امتحان';
                    const subject = getSubjectText(document.getElementById('subject').value);
                    const grade = getGradeText(document.getElementById('grade').value);
                    const timestamp = new Date().toISOString().slice(0, 10);
                    const filename = `${examTitle}_${subject}_${grade}_${timestamp}.pdf`;
                    
                    // Save PDF
                    pdf.save(filename);
                    
                    showNotification(`تم إنشاء PDF بنجاح مع ${totalPages} صفحة! 📄✨`, 'success');
                } else {
                    throw new Error('فشل في إنشاء الصورة للـ PDF');
                }
                
                // Remove capturing class
                previewElement.classList.remove('capturing-images');
                
                // Reset button
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
                
            } catch (error) {
                console.error('خطأ في إنشاء PDF:', error);
                showNotification(`حدث خطأ في إنشاء PDF: ${error.message}`, 'error');
                
                // Remove capturing class
                const previewElement = document.getElementById('examPreview');
                if (previewElement) {
                    previewElement.classList.remove('capturing-images');
                }
                
                // Reset button
                const button = document.querySelector('button[onclick="saveToPDF()"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-file-pdf ml-1"></i>PDF عادي';
                    button.disabled = false;
                }
            }
        }



        // Print function
        function printExam() {
            window.print();
        }

        // Copy to clipboard function
        function copyToClipboard() {
            const examPreview = document.getElementById('examPreview');
            const textContent = examPreview.innerText;
            
            navigator.clipboard.writeText(textContent).then(() => {
                alert('تم نسخ محتوى الامتحان إلى الحافظة بنجاح!');
            }).catch(() => {
                alert('فشل في نسخ المحتوى');
            });
        }

        // Toggle all marks visibility
        function toggleAllMarks() {
            const hasVisibleMarks = questions.some(q => !q.hideMarks);
            
            questions.forEach(question => {
                question.hideMarks = hasVisibleMarks;
            });
            
            updateQuestionsList();
            updatePreview();
            
            const status = hasVisibleMarks ? 'مخفية' : 'ظاهرة';
            showNotification(`جميع الدرجات الآن ${status}`, 'info');
        }

        // Calculate total marks
        function calculateTotalMarks() {
            const total = questions.reduce((sum, question) => sum + (question.marks || 0), 0);
            const questionCount = questions.length;
            
            const message = `إجمالي الدرجات: ${total}\nعدد الأسئلة: ${questionCount}\nمتوسط الدرجة لكل سؤال: ${questionCount > 0 ? (total / questionCount).toFixed(1) : 0}`;
            
            alert(message);
            
            // Update total marks in the form
            document.getElementById('totalMarks').value = total;
            updatePreview();
        }



        // Toggle developer menu
        function toggleDeveloperMenu() {
            const menu = document.getElementById('developerMenu');
            menu.classList.toggle('hidden');
        }

        // Close developer menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('developerMenu');
            const button = event.target.closest('button[onclick="toggleDeveloperMenu()"]');
            
            if (!button && !menu.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96f9864b60f260bf',t:'MTc1NTI2OTYzOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
