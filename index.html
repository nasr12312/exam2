<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†Ø´Ø¦ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Advanced PDF and Image Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/0.2.6/dom-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- Print.js for advanced printing -->
    <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://printjs-4de6.kxcdn.com/print.min.css">
    
    <!-- Puppeteer alternative - html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700&family=Almarai:wght@300;400;700&display=swap');
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .preview-container {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .page-preview {
            background: white;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px auto;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            min-height: 600px;
            position: relative;
        }

        /* Page break indicators - only for screen preview */
        .page-break-indicator {
            position: relative;
            margin: 30px 0;
            border-top: 2px dashed #ef4444;
            text-align: center;
            display: block;
        }

        .page-break-indicator::before {
            content: "ÙØ§ØµÙ„ Ø§Ù„ØµÙØ­Ø© - Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ØªØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§";
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #fef2f2;
            color: #dc2626;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            border: 1px solid #fecaca;
            white-space: nowrap;
            z-index: 10;
        }

        /* Hide page break indicators completely when capturing images */
        .capturing-images .page-break-indicator {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
        }

        .capturing-images .page-break-indicator::before {
            display: none !important;
            content: none !important;
        }

        @media print {
            .page-break-indicator {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
            }
            
            .page-break-indicator::before {
                display: none !important;
                content: none !important;
            }
        }

        /* Page height simulation */
        .page-section {
            min-height: 800px;
            position: relative;
        }

        .page-section:not(:last-child)::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: -30px;
            right: -30px;
            height: 2px;
            background: linear-gradient(to right, transparent, #ef4444, transparent);
        }
        
        .question-container {
            margin-bottom: 20px;
            padding: 0;
            border-radius: 0;
            background: transparent;
            page-break-inside: avoid;
        }
        
        .question-with-frame {
            border: 2px solid #e5e7eb;
            padding: 15px;
            border-radius: 8px;
            background: white;
        }
        
        .mcq-options .option-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            padding: 2px 0;
            border-radius: 0;
            background: transparent;
        }
        
        .answer-line {
            height: 30px;
            border-bottom: 1px solid #9ca3af;
            margin-bottom: 6px;
        }
        
        .question-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: #f9fafb;
            transition: all 0.3s ease;
        }
        
        .question-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .options-horizontal {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .options-vertical {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .options-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .options-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        /* Compact header styles */
        .exam-header {
            padding: 15px;
            margin-bottom: 20px;
        }

        .exam-header h1 {
            font-size: 20px !important;
            margin-bottom: 10px !important;
        }

        .exam-header .header-info {
            font-size: 12px !important;
            padding: 10px;
        }

        .exam-header .student-info {
            font-size: 11px !important;
            margin-top: 10px;
        }

        .exam-header .logo-container img {
            max-height: 50px !important;
            max-width: 80px !important;
        }

        /* Question section headers */
        .section-header {
            background: #f3f4f6;
            padding: 8px 15px;
            margin: 20px 0 15px 0;
            border-right: 4px solid #3b82f6;
            font-weight: bold;
            font-size: 16px;
            color: #1f2937;
        }

        /* Answer marking styles */
        .answer-mark {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #374151;
            margin-left: 8px;
            text-align: center;
            line-height: 16px;
            font-weight: bold;
            font-size: 12px;
        }

        .answer-mark.circle {
            border-radius: 50%;
        }

        .answer-mark.square {
            border-radius: 2px;
        }

        @media print {
            .page-preview {
                box-shadow: none;
                margin: 0;
                padding: 15px;
            }
            
            .question-container {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .no-print {
                display: none !important;
            }

            .exam-header {
                padding: 10px;
            }

            .section-header {
                margin: 15px 0 10px 0;
                padding: 6px 12px;
            }
        }

        .logo-preview {
            max-width: 80px;
            max-height: 60px;
            object-fit: contain;
            border: 2px dashed #d1d5db;
            padding: 4px;
            border-radius: 4px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .status-connected {
            background-color: #10b981;
        }

        .status-disconnected {
            background-color: #ef4444;
        }

        .status-connecting {
            background-color: #f59e0b;
            animation: pulse 2s infinite;
        }

        /* Drag and Drop Styles */
        .draggable {
            transition: all 0.3s ease;
            cursor: move;
        }

        .draggable:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .draggable.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .drag-handle {
            transition: color 0.2s ease;
        }

        .drag-handle:hover {
            color: #3b82f6 !important;
        }

        /* Editable Elements */
        .editable-text {
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 2px 4px;
        }

        .editable-text:hover {
            background-color: #f3f4f6 !important;
            border: 1px dashed #9ca3af;
        }

        /* Manual Edit Mode Styles */
        .manual-edit-mode .editable-element {
            cursor: text;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 4px;
            min-height: 20px;
            position: relative;
        }

        .manual-edit-mode .editable-element:hover {
            background-color: #fef3c7 !important;
            border: 2px dashed #f59e0b !important;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .manual-edit-mode .editable-element.editing {
            background-color: #dbeafe !important;
            border: 2px solid #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .manual-edit-mode .editable-element::before {
            content: "Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„";
            position: absolute;
            top: -25px;
            right: 0;
            background: #1f2937;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1000;
            pointer-events: none;
        }

        .manual-edit-mode .editable-element:hover::before {
            opacity: 1;
        }

        .manual-edit-mode .editable-element.editing::before {
            content: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„...";
            background: #059669;
        }

        /* Formatting Toolbar */
        .format-toolbar {
            position: fixed;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
        }

        .format-toolbar.active {
            display: flex;
        }

        .format-toolbar button {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: right;
            font-size: 12px;
        }

        .format-toolbar button:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        .format-toolbar button.active {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        /* Custom Styles */
        .custom-title {
            font-size: 24px !important;
            font-weight: bold !important;
            color: #1f2937 !important;
            text-align: center !important;
            margin: 20px 0 !important;
        }

        .custom-subtitle {
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #374151 !important;
            margin: 15px 0 !important;
        }

        .custom-highlight {
            background-color: #fef08a !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            font-weight: 500 !important;
        }

        .custom-important {
            color: #dc2626 !important;
            font-weight: bold !important;
            background-color: #fef2f2 !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            border-right: 4px solid #dc2626 !important;
        }

        .editable-marks {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .editable-marks:hover {
            background-color: #dcfce7 !important;
            transform: scale(1.05);
        }

        .editable-section-title {
            transition: all 0.2s ease;
            position: relative;
            padding: 8px 15px;
            border-radius: 8px;
        }

        .editable-section-title:hover {
            background-color: #f8fafc !important;
            border: 2px dashed #3b82f6;
        }

        .editable-section-title:hover::after {
            content: "Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„";
            position: absolute;
            top: -25px;
            right: 10px;
            background: #1f2937;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 1000;
        }

        /* Question Item Enhancements */
        .question-item {
            position: relative;
            overflow: hidden;
        }

        .question-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .question-item:hover::before {
            opacity: 1;
        }

        /* Button Enhancements */
        .question-item button {
            transition: all 0.2s ease;
            border-radius: 6px;
            padding: 6px;
        }

        .question-item button:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Animation for new questions */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .question-item.new-question {
            animation: slideInRight 0.5s ease-out;
        }

        /* Improved hover effects */
        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="bg-white bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-brain text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Ù…Ù†Ø´Ø¦ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ±</h1>
                        <p class="text-blue-100">Ø£Ù†Ø´Ø¦ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø¨ØªÙ†Ø³ÙŠÙ‚ Ù…ØªÙ‚Ø¯Ù…</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 space-x-reverse">
                    <div id="aiStatus" class="flex items-center bg-white bg-opacity-20 px-3 py-2 rounded-full">
                        <div id="statusIndicator" class="w-3 h-3 rounded-full status-disconnected ml-2"></div>
                        <span id="statusText" class="text-sm">ØºÙŠØ± Ù…ØªØµÙ„</span>
                    </div>
                    <button onclick="testAIConnection()" class="bg-white bg-opacity-20 p-2 rounded-full hover:bg-opacity-30 transition-all" title="Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <!-- Developer Info Dropdown -->
                    <div class="relative">
                        <button onclick="toggleDeveloperMenu()" class="bg-white bg-opacity-20 p-2 rounded-full hover:bg-opacity-30 transition-all" title="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ±">
                            <i class="fas fa-user-circle"></i>
                        </button>
                        <div id="developerMenu" class="hidden absolute left-0 mt-2 w-64 bg-white rounded-lg shadow-lg border z-50">
                            <div class="p-4">
                                <div class="text-center mb-3">
                                    <h3 class="font-bold text-gray-800">Ø§Ù„Ù…Ø·ÙˆØ±</h3>
                                    <p class="text-sm text-gray-600">Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ù†ØµØ± Ø§Ù„Ù„Ù‡</p>
                                </div>
                                <div class="space-y-2">
                                    <a href="https://www.instagram.com/nasrallah_2002/" target="_blank" class="flex items-center p-2 rounded hover:bg-gray-100 transition-colors">
                                        <i class="fab fa-instagram text-pink-500 ml-2"></i>
                                        <span class="text-sm text-gray-700">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</span>
                                    </a>
                                    <a href="https://www.youtube.com/@tnasrallah" target="_blank" class="flex items-center p-2 rounded hover:bg-gray-100 transition-colors">
                                        <i class="fab fa-youtube text-red-500 ml-2"></i>
                                        <span class="text-sm text-gray-700">Ù‚Ù†Ø§Ø© Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨</span>
                                    </a>
                                </div>
                                <div class="mt-3 pt-3 border-t text-center">
                                    <p class="text-xs text-gray-500">Ù…Ù†Ø´Ø¦ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ±</p>
                                    <p class="text-xs text-gray-400">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2024</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Control Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <!-- Tabs -->
                    <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                        <button onclick="switchTab('basic')" id="tab-basic" class="flex-1 py-2 px-1 rounded-md text-xs font-medium transition-all tab-active">
                            <i class="fas fa-cog ml-1"></i>Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                        </button>
                        <button onclick="switchTab('questions')" id="tab-questions" class="flex-1 py-2 px-1 rounded-md text-xs font-medium transition-all">
                            <i class="fas fa-question ml-1"></i>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                        </button>
                        <button onclick="switchTab('format')" id="tab-format" class="flex-1 py-2 px-1 rounded-md text-xs font-medium transition-all">
                            <i class="fas fa-palette ml-1"></i>Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
                        </button>
                        <button onclick="switchTab('ai')" id="tab-ai" class="flex-1 py-2 px-1 rounded-md text-xs font-medium transition-all">
                            <i class="fas fa-robot ml-1"></i>Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                        </button>
                    </div>

                    <!-- Basic Settings Tab -->
                    <div id="basic-tab" class="space-y-6">
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h3>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</label>
                                <input type="text" id="examTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª - Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„" value="Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª - Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                                    <select id="subject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
                                        <option value="math" selected>Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
                                        <option value="arabic">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                                        <option value="english">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
                                        <option value="science">Ø§Ù„Ø¹Ù„ÙˆÙ…</option>
                                        <option value="history">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
                                        <option value="physics">Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡</option>
                                        <option value="chemistry">Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ØµÙ</label>
                                    <select id="grade" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                                        <option value="1">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                        <option value="2">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                        <option value="3">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                        <option value="4">Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                        <option value="5">Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                        <option value="6">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                        <option value="7">Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</option>
                                        <option value="8">Ø§Ù„Ø«Ø§Ù…Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</option>
                                        <option value="9" selected>Ø§Ù„ØªØ§Ø³Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</option>
                                        <option value="10">Ø§Ù„Ø¹Ø§Ø´Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                                        <option value="11">Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                                        <option value="12">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ (Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ)</option>
                                        <option value="university-1">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
                                        <option value="university-2">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
                                        <option value="university-3">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option>
                                        <option value="university-4">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©</option>
                                        <option value="master">Ø§Ù„Ù…Ø§Ø¬Ø³ØªÙŠØ±</option>
                                        <option value="phd">Ø§Ù„Ø¯ÙƒØªÙˆØ±Ø§Ù‡</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)</label>
                                    <input type="number" id="duration" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="90" value="90">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</label>
                                    <input type="number" id="totalMarks" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="100" value="100">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</label>
                                <input type="text" id="teacherName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ø£. Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯" value="Ø£. Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
                                <input type="text" id="schoolName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†ÙˆØ± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©" value="Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†ÙˆØ± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©">
                            </div>

                            <!-- School Logo Upload -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
                                <div class="space-y-3">
                                    <input type="file" id="schoolLogoFile" accept="image/*" onchange="handleLogoUpload()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <div id="logoPreview" class="hidden">
                                        <img id="logoImage" class="logo-preview mx-auto" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±">
                                        <button onclick="removeLogo()" class="mt-2 text-red-600 text-sm hover:text-red-800">
                                            <i class="fas fa-trash ml-1"></i>Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø±
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Header Template Upload -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ­Ù…ÙŠÙ„ ØªØ±ÙˆÙŠØ³Ø© Ø¬Ø§Ù‡Ø²Ø©</label>
                                <div class="space-y-3">
                                    <input type="file" id="headerTemplateFile" accept="image/*" onchange="handleHeaderTemplateUpload()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <div id="headerTemplatePreview" class="hidden">
                                        <div class="bg-gray-50 p-3 rounded-lg border">
                                            <img id="headerTemplateImage" class="w-full object-contain border-2 dashed #d1d5db p-2 rounded mb-3" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©" style="max-height: 200px;">
                                            
                                            <!-- Advanced Header Controls -->
                                            <div class="space-y-4">
                                                <h5 class="font-medium text-purple-800 mb-2">ğŸ¨ ØªØ­ÙƒÙ… Ù…ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø©</h5>
                                                
                                                <!-- Position Controls -->
                                                <div class="bg-blue-50 p-3 rounded border">
                                                    <h6 class="font-medium text-blue-800 mb-2">ğŸ“ Ø§Ù„Ù…ÙˆØ¶Ø¹ ÙˆØ§Ù„Ø­Ø±ÙƒØ©</h6>
                                                    <div class="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙÙ‚ÙŠ: <span id="headerXPositionLabel">0px</span></label>
                                                            <input type="range" id="headerXPosition" min="-100" max="100" value="0" onchange="updateHeaderPosition()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ: <span id="headerYPositionLabel">0px</span></label>
                                                            <input type="range" id="headerYPosition" min="-50" max="50" value="0" onchange="updateHeaderPosition()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ø¯ÙˆØ±Ø§Ù†: <span id="headerRotationLabel">0Â°</span></label>
                                                            <input type="range" id="headerRotation" min="-45" max="45" value="0" onchange="updateHeaderPosition()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…ÙŠÙ„: <span id="headerSkewLabel">0Â°</span></label>
                                                            <input type="range" id="headerSkew" min="-15" max="15" value="0" onchange="updateHeaderPosition()" class="w-full">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Size Controls -->
                                                <div class="bg-green-50 p-3 rounded border">
                                                    <h6 class="font-medium text-green-800 mb-2">ğŸ“ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ÙˆØ§Ù„Ø­Ø¬Ù…</h6>
                                                    <div class="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ø¹Ø±Ø¶: <span id="headerWidthLabel">100%</span></label>
                                                            <input type="range" id="headerWidth" min="20" max="150" value="100" onchange="updateHeaderSize()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ø§Ø±ØªÙØ§Ø¹: <span id="headerHeightLabel">200px</span></label>
                                                            <input type="range" id="headerHeight" min="50" max="500" value="200" onchange="updateHeaderSize()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±: <span id="headerScaleLabel">100%</span></label>
                                                            <input type="range" id="headerScale" min="50" max="200" value="100" onchange="updateHeaderSize()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶/Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</label>
                                                            <select id="headerAspectRatio" onchange="updateHeaderSize()" class="w-full px-2 py-1 text-xs border border-gray-300 rounded-md">
                                                                <option value="auto">ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
                                                                <option value="1/1">Ù…Ø±Ø¨Ø¹ (1:1)</option>
                                                                <option value="4/3">4:3</option>
                                                                <option value="16/9">16:9</option>
                                                                <option value="3/2">3:2</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Alignment and Display -->
                                                <div class="bg-yellow-50 p-3 rounded border">
                                                    <h6 class="font-medium text-yellow-800 mb-2">ğŸ¯ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© ÙˆØ§Ù„Ø¹Ø±Ø¶</h6>
                                                    <div class="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø£ÙÙ‚ÙŠØ©</label>
                                                            <select id="headerAlignment" onchange="updateHeaderStyle()" class="w-full px-2 py-1 text-xs border border-gray-300 rounded-md">
                                                                <option value="center" selected>ÙˆØ³Ø·</option>
                                                                <option value="right">ÙŠÙ…ÙŠÙ†</option>
                                                                <option value="left">ÙŠØ³Ø§Ø±</option>
                                                                <option value="justify">Ù…Ù„Ø¡ Ø§Ù„Ø¹Ø±Ø¶</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠØ©</label>
                                                            <select id="headerVerticalAlign" onchange="updateHeaderStyle()" class="w-full px-2 py-1 text-xs border border-gray-300 rounded-md">
                                                                <option value="top">Ø£Ø¹Ù„Ù‰</option>
                                                                <option value="middle" selected>ÙˆØ³Ø·</option>
                                                                <option value="bottom">Ø£Ø³ÙÙ„</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ù†Ù…Ø· Ø§Ù„Ø¹Ø±Ø¶</label>
                                                            <select id="headerDisplayMode" onchange="updateHeaderStyle()" class="w-full px-2 py-1 text-xs border border-gray-300 rounded-md">
                                                                <option value="contain" selected>Ø§Ø­ØªÙˆØ§Ø¡ ÙƒØ§Ù…Ù„</option>
                                                                <option value="cover">ØªØºØ·ÙŠØ© ÙƒØ§Ù…Ù„Ø©</option>
                                                                <option value="fill">Ù…Ù„Ø¡ ÙƒØ§Ù…Ù„</option>
                                                                <option value="scale-down">ØªØµØºÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
                                                                <option value="none">Ø­Ø¬Ù… Ø·Ø¨ÙŠØ¹ÙŠ</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶ (Z-Index): <span id="headerZIndexLabel">1</span></label>
                                                            <input type="range" id="headerZIndex" min="0" max="10" value="1" onchange="updateHeaderStyle()" class="w-full">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Spacing Controls -->
                                                <div class="bg-purple-50 p-3 rounded border">
                                                    <h6 class="font-medium text-purple-800 mb-2">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø­Ø´Ùˆ</h6>
                                                    <div class="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ©: <span id="headerMarginTopLabel">0px</span></label>
                                                            <input type="range" id="headerMarginTop" min="0" max="100" value="0" onchange="updateHeaderSpacing()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠØ©: <span id="headerMarginBottomLabel">20px</span></label>
                                                            <input type="range" id="headerMarginBottom" min="0" max="100" value="20" onchange="updateHeaderSpacing()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙŠÙ…Ù†Ù‰: <span id="headerMarginRightLabel">0px</span></label>
                                                            <input type="range" id="headerMarginRight" min="0" max="100" value="0" onchange="updateHeaderSpacing()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙŠØ³Ø±Ù‰: <span id="headerMarginLeftLabel">0px</span></label>
                                                            <input type="range" id="headerMarginLeft" min="0" max="100" value="0" onchange="updateHeaderSpacing()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ: <span id="headerPaddingLabel">0px</span></label>
                                                            <input type="range" id="headerPadding" min="0" max="50" value="0" onchange="updateHeaderSpacing()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ±: <span id="headerGapLabel">0px</span></label>
                                                            <input type="range" id="headerGap" min="0" max="30" value="0" onchange="updateHeaderSpacing()" class="w-full">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Border and Shadow -->
                                                <div class="bg-red-50 p-3 rounded border">
                                                    <h6 class="font-medium text-red-800 mb-2">ğŸ–¼ï¸ Ø§Ù„Ø­Ø¯ÙˆØ¯ ÙˆØ§Ù„Ø¸Ù„Ø§Ù„</h6>
                                                    <div class="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø­Ø¯ÙˆØ¯: <span id="headerBorderRadiusLabel">8px</span></label>
                                                            <input type="range" id="headerBorderRadius" min="0" max="50" value="8" onchange="updateHeaderBorder()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø³Ù…Ùƒ Ø§Ù„Ø­Ø¯ÙˆØ¯: <span id="headerBorderWidthLabel">0px</span></label>
                                                            <input type="range" id="headerBorderWidth" min="0" max="10" value="0" onchange="updateHeaderBorder()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯</label>
                                                            <input type="color" id="headerBorderColor" value="#e5e7eb" onchange="updateHeaderBorder()" class="w-full h-8 rounded border">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ù†Ù…Ø· Ø§Ù„Ø­Ø¯ÙˆØ¯</label>
                                                            <select id="headerBorderStyle" onchange="updateHeaderBorder()" class="w-full px-2 py-1 text-xs border border-gray-300 rounded-md">
                                                                <option value="solid">Ù…ØµÙ…Øª</option>
                                                                <option value="dashed">Ù…ØªÙ‚Ø·Ø¹</option>
                                                                <option value="dotted">Ù†Ù‚Ø§Ø·</option>
                                                                <option value="double">Ù…Ø²Ø¯ÙˆØ¬</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø´Ø¯Ø© Ø§Ù„Ø¸Ù„: <span id="headerShadowLabel">Ø®ÙÙŠÙ</span></label>
                                                            <input type="range" id="headerShadow" min="0" max="5" value="1" onchange="updateHeaderBorder()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ù„ÙˆÙ† Ø§Ù„Ø¸Ù„</label>
                                                            <input type="color" id="headerShadowColor" value="#000000" onchange="updateHeaderBorder()" class="w-full h-8 rounded border">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Effects and Filters -->
                                                <div class="bg-indigo-50 p-3 rounded border">
                                                    <h6 class="font-medium text-indigo-800 mb-2">âœ¨ Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª ÙˆØ§Ù„Ù…Ø±Ø´Ø­Ø§Øª</h6>
                                                    <div class="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ø´ÙØ§ÙÙŠØ©: <span id="headerOpacityLabel">100%</span></label>
                                                            <input type="range" id="headerOpacity" min="10" max="100" value="100" onchange="updateHeaderFilters()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠØ©: <span id="headerBlurLabel">0px</span></label>
                                                            <input type="range" id="headerBlur" min="0" max="10" value="0" onchange="updateHeaderFilters()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ø³Ø·ÙˆØ¹: <span id="headerBrightnessLabel">100%</span></label>
                                                            <input type="range" id="headerBrightness" min="50" max="200" value="100" onchange="updateHeaderFilters()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„ØªØ¨Ø§ÙŠÙ†: <span id="headerContrastLabel">100%</span></label>
                                                            <input type="range" id="headerContrast" min="50" max="200" value="100" onchange="updateHeaderFilters()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„ØªØ´Ø¨Ø¹: <span id="headerSaturationLabel">100%</span></label>
                                                            <input type="range" id="headerSaturation" min="0" max="200" value="100" onchange="updateHeaderFilters()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©: <span id="headerHueLabel">0Â°</span></label>
                                                            <input type="range" id="headerHue" min="-180" max="180" value="0" onchange="updateHeaderFilters()" class="w-full">
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Special Filters -->
                                                    <div class="mt-3 space-y-2">
                                                        <label class="flex items-center">
                                                            <input type="checkbox" id="headerGrayscale" onchange="updateHeaderFilters()" class="ml-2 text-indigo-600">
                                                            <span class="text-xs">ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø±Ù…Ø§Ø¯ÙŠ</span>
                                                        </label>
                                                        <label class="flex items-center">
                                                            <input type="checkbox" id="headerSepia" onchange="updateHeaderFilters()" class="ml-2 text-indigo-600">
                                                            <span class="text-xs">ØªØ£Ø«ÙŠØ± Ø§Ù„Ø³ÙŠØ¨ÙŠØ§ (Ø¨Ù†ÙŠ Ù‚Ø¯ÙŠÙ…)</span>
                                                        </label>
                                                        <label class="flex items-center">
                                                            <input type="checkbox" id="headerInvert" onchange="updateHeaderFilters()" class="ml-2 text-indigo-600">
                                                            <span class="text-xs">Ø¹ÙƒØ³ Ø§Ù„Ø£Ù„ÙˆØ§Ù†</span>
                                                        </label>
                                                        <label class="flex items-center">
                                                            <input type="checkbox" id="headerDropShadow" onchange="updateHeaderFilters()" class="ml-2 text-indigo-600">
                                                            <span class="text-xs">Ø¸Ù„ Ù…Ù†Ø³Ø¯Ù„</span>
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                <!-- Background and Patterns -->
                                                <div class="bg-teal-50 p-3 rounded border">
                                                    <h6 class="font-medium text-teal-800 mb-2">ğŸ¨ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ø£Ù†Ù…Ø§Ø·</h6>
                                                    <div class="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
                                                            <input type="color" id="headerBgColor" value="#ffffff" onchange="updateHeaderBackground()" class="w-full h-8 rounded border">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø®Ù„ÙÙŠØ©: <span id="headerBgOpacityLabel">0%</span></label>
                                                            <input type="range" id="headerBgOpacity" min="0" max="100" value="0" onchange="updateHeaderBackground()" class="w-full">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ù†Ù…Ø· Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
                                                            <select id="headerBackgroundPattern" onchange="updateHeaderBackground()" class="w-full px-2 py-1 text-xs border border-gray-300 rounded-md">
                                                                <option value="none">Ø¨Ø¯ÙˆÙ† Ù†Ù…Ø·</option>
                                                                <option value="dots">Ù†Ù‚Ø§Ø·</option>
                                                                <option value="lines">Ø®Ø·ÙˆØ· Ø£ÙÙ‚ÙŠØ©</option>
                                                                <option value="grid">Ø´Ø¨ÙƒØ©</option>
                                                                <option value="diagonal">Ø®Ø·ÙˆØ· Ù‚Ø·Ø±ÙŠØ©</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label class="flex items-center">
                                                                <input type="checkbox" id="headerGradientOverlay" onchange="updateHeaderBackground()" class="ml-2 text-teal-600">
                                                                <span class="text-xs">ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ ÙƒØ·Ø¨Ù‚Ø© Ø¹Ù„ÙˆÙŠØ©</span>
                                                            </label>
                                                        </div>
                                                        <div>
                                                            <label class="flex items-center">
                                                                <input type="checkbox" id="headerRoundedCorners" onchange="updateHeaderBackground()" class="ml-2 text-teal-600">
                                                                <span class="text-xs">Ø²ÙˆØ§ÙŠØ§ Ø¯Ø§Ø¦Ø±ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Quick Control Buttons -->
                                                <div class="bg-gray-50 p-3 rounded border">
                                                    <h6 class="font-medium text-gray-800 mb-2">âš¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³Ø±ÙŠØ¹</h6>
                                                    <div class="grid grid-cols-3 gap-2">
                                                        <button onclick="centerHeaderTemplate()" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                                            ğŸ¯ ØªÙˆØ³ÙŠØ·
                                                        </button>
                                                        <button onclick="resetHeaderPosition()" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">
                                                            ğŸ“ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ÙˆØ¶Ø¹
                                                        </button>
                                                        <button onclick="fitHeaderToWidth()" class="bg-purple-500 text-white px-2 py-1 rounded text-xs hover:bg-purple-600">
                                                            â†”ï¸ Ù…Ù„Ø¡ Ø§Ù„Ø¹Ø±Ø¶
                                                        </button>
                                                        <button onclick="makeHeaderSquare()" class="bg-yellow-500 text-white px-2 py-1 rounded text-xs hover:bg-yellow-600">
                                                            â¬œ Ù…Ø±Ø¨Ø¹
                                                        </button>
                                                        <button onclick="rotateHeader90()" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                                            ğŸ”„ Ø¯ÙˆØ±Ø§Ù† 90Â°
                                                        </button>
                                                        <button onclick="flipHeaderHorizontal()" class="bg-indigo-500 text-white px-2 py-1 rounded text-xs hover:bg-indigo-600">
                                                            â†”ï¸ Ø§Ù†Ø¹ÙƒØ§Ø³ Ø£ÙÙ‚ÙŠ
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- Preset Styles -->
                                                <div class="bg-orange-50 p-3 rounded border">
                                                    <h6 class="font-medium text-orange-800 mb-2">ğŸ¨ Ø£Ù†Ù…Ø§Ø· Ø¬Ø§Ù‡Ø²Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</h6>
                                                    <div class="grid grid-cols-2 gap-2">
                                                        <button onclick="applyHeaderPreset('modern')" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-3 py-2 rounded text-xs hover:from-blue-600 hover:to-purple-600">
                                                            ğŸŒŸ Ø¹ØµØ±ÙŠ
                                                        </button>
                                                        <button onclick="applyHeaderPreset('classic')" class="bg-gradient-to-r from-gray-600 to-gray-800 text-white px-3 py-2 rounded text-xs hover:from-gray-700 hover:to-gray-900">
                                                            ğŸ›ï¸ ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ
                                                        </button>
                                                        <button onclick="applyHeaderPreset('elegant')" class="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-3 py-2 rounded text-xs hover:from-pink-600 hover:to-rose-600">
                                                            ğŸ’ Ø£Ù†ÙŠÙ‚
                                                        </button>
                                                        <button onclick="applyHeaderPreset('minimal')" class="bg-gradient-to-r from-green-500 to-teal-500 text-white px-3 py-2 rounded text-xs hover:from-green-600 hover:to-teal-600">
                                                            â– Ø¨Ø³ÙŠØ·
                                                        </button>
                                                        <button onclick="applyHeaderPreset('bold')" class="bg-gradient-to-r from-red-500 to-orange-500 text-white px-3 py-2 rounded text-xs hover:from-red-600 hover:to-orange-600">
                                                            ğŸ’ª Ø¬Ø±ÙŠØ¡
                                                        </button>
                                                        <button onclick="applyHeaderPreset('artistic')" class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-3 py-2 rounded text-xs hover:from-purple-600 hover:to-indigo-600">
                                                            ğŸ¨ ÙÙ†ÙŠ
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="flex gap-2 mt-4 pt-3 border-t">
                                                <button onclick="removeHeaderTemplate()" class="text-red-600 text-sm hover:text-red-800 px-2 py-1 rounded border border-red-200 hover:bg-red-50">
                                                    <i class="fas fa-trash ml-1"></i>Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©
                                                </button>
                                                <button onclick="toggleHeaderTemplate()" id="toggleHeaderBtn" class="text-blue-600 text-sm hover:text-blue-800 px-2 py-1 rounded border border-blue-200 hover:bg-blue-50">
                                                    <i class="fas fa-eye-slash ml-1"></i>Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©
                                                </button>
                                                <button onclick="resetHeaderSettings()" class="text-gray-600 text-sm hover:text-gray-800 px-2 py-1 rounded border border-gray-200 hover:bg-gray-50">
                                                    <i class="fas fa-undo ml-1"></i>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                                                </button>
                                                <button onclick="duplicateHeaderTemplate()" class="text-green-600 text-sm hover:text-green-800 px-2 py-1 rounded border border-green-200 hover:bg-green-50">
                                                    <i class="fas fa-copy ml-1"></i>Ù†Ø³Ø® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        <p><i class="fas fa-info-circle ml-1"></i>ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ ØªØ±ÙˆÙŠØ³Ø© Ø¬Ø§Ù‡Ø²Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ù…Ø¸Ù‡Ø±Ù‡Ø§ ÙˆØ­Ø¬Ù…Ù‡Ø§ ÙˆÙ…ÙˆØ¶Ø¹Ù‡Ø§</p>
                                        <p><i class="fas fa-lightbulb ml-1"></i>Ø§Ù„Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©: 800x200 Ø¨ÙƒØ³Ù„ Ø£Ùˆ Ø£ÙƒØ¨Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø¬ÙˆØ¯Ø©</p>
                                        <p><i class="fas fa-palette ml-1"></i>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù„Ø¶Ø¨Ø· Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø­Ø³Ø¨ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ø¨Ø¯Ù‚Ø©</p>
                                        <p><i class="fas fa-magic ml-1"></i>Ø¬Ø±Ø¨ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØµØ§Ù…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙÙˆØ±ÙŠØ©</p>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" id="examDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <div class="mt-2">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                                    <select id="dateFormat" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                        <option value="arabic" selected>Ø¹Ø±Ø¨ÙŠ (Ù¡Ù¥ Ø±Ù…Ø¶Ø§Ù† Ù¡Ù¤Ù¤Ù¥)</option>
                                        <option value="hijri">Ù‡Ø¬Ø±ÙŠ (15/09/1445)</option>
                                        <option value="gregorian">Ù…ÙŠÙ„Ø§Ø¯ÙŠ (15/04/2024)</option>
                                        <option value="both">ÙƒÙ„Ø§Ù‡Ù…Ø§ (15/04/2024 - 15/09/1445)</option>
                                        <option value="text">Ù†ØµÙŠ (Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø± Ù…Ù† Ø£Ø¨Ø±ÙŠÙ„)</option>
                                    </select>
                                </div>
                            </div>

                            <button onclick="updatePreview()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                                <i class="fas fa-refresh ml-2"></i>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                            </button>
                        </div>
                    </div>

                    <!-- Questions Tab -->
                    <div id="questions-tab" class="space-y-6 hidden">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h3>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                            <select id="questionType" onchange="toggleQuestionOptions()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="mcq">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</option>
                                <option value="true-false">ØµØ­ Ø£Ù… Ø®Ø·Ø£</option>
                                <option value="short">Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©</option>
                                <option value="essay">Ù…Ù‚Ø§Ù„ÙŠ</option>
                                <option value="fill">Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                            <textarea id="questionText" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..."></textarea>
                        </div>

                        <!-- Question Details -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-800 mb-3">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø³Ø¤Ø§Ù„</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</label>
                                    <select id="questionDifficulty" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="easy">Ø³Ù‡Ù„</option>
                                        <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                                        <option value="hard">ØµØ¹Ø¨</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹/Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                                    <input type="text" id="questionTopic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¬Ø¨Ø±ØŒ Ø§Ù„Ù†Ø­ÙˆØŒ Ø§Ù„Ø®Ù„Ø§ÙŠØ§...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</label>
                                    <input type="text" id="questionObjective" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ù…Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­Ù‚Ù‚Ù‡ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                                    <input type="number" id="questionTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="5" min="1" max="60">
                                </div>
                            </div>
                        </div>

                        <!-- MCQ Options -->
                        <div id="mcqOptions" class="space-y-4">
                            <label class="block text-sm font-medium text-gray-700">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:</label>
                            <div id="mcqOptionsList" class="space-y-2">
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <input type="radio" name="correctMCQ" value="1" class="text-blue-600">
                                    <input type="text" id="option1" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„">
                                </div>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <input type="radio" name="correctMCQ" value="2" class="text-blue-600">
                                    <input type="text" id="option2" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ">
                                </div>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <input type="radio" name="correctMCQ" value="3" class="text-blue-600">
                                    <input type="text" id="option3" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«">
                                </div>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <input type="radio" name="correctMCQ" value="4" class="text-blue-600">
                                    <input type="text" id="option4" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹">
                                </div>
                            </div>
                        </div>

                        <!-- True/False Options -->
                        <div id="trueFalseOptions" class="space-y-2 hidden">
                            <label class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</label>
                            <div class="flex items-center space-x-4 space-x-reverse">
                                <label class="flex items-center">
                                    <input type="radio" name="trueFalseAnswer" value="true" class="ml-2 text-blue-600">
                                    <span>ØµØ­</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="trueFalseAnswer" value="false" class="ml-2 text-blue-600">
                                    <span>Ø®Ø·Ø£</span>
                                </label>
                            </div>
                        </div>

                        <!-- Fill Options -->
                        <div id="fillOptions" class="space-y-2 hidden">
                            <label class="block text-sm font-medium text-gray-700">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©:</label>
                            <input type="text" id="fillAnswers" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¯Ø±Ø¬Ø©</label>
                            <input type="number" id="questionMarks" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="5" value="5">
                        </div>

                        <button onclick="addQuestion()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-4 rounded-md hover:from-blue-700 hover:to-indigo-700 transition-all">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„
                        </button>
                    </div>

                    <!-- Format Tab -->
                    <div id="format-tab" class="space-y-6 hidden">
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg border">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h3>
                        </div>

                        <!-- Manual Editing Mode -->
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h4 class="font-bold text-yellow-800 mb-3">
                                <i class="fas fa-edit ml-2"></i>ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
                            </h4>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enableManualEdit" onchange="toggleManualEditMode()" class="ml-2 text-yellow-600">
                                        <span class="text-sm font-medium">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</span>
                                    </label>
                                    <button onclick="saveManualChanges()" id="saveManualBtn" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 disabled:opacity-50" disabled>
                                        <i class="fas fa-save ml-1"></i>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                                    </button>
                                </div>
                                <div class="text-xs text-yellow-700 bg-yellow-100 p-2 rounded">
                                    <p><strong>ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong></p>
                                    <ul class="list-disc list-inside mt-1 space-y-1">
                                        <li>ÙØ¹Ù‘Ù„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</li>
                                        <li>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Øµ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡</li>
                                        <li>Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</li>
                                        <li>Ø§Ø¶ØºØ· Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</li>
                                    </ul>
                                </div>
                            </div>
                        </div>



                        <!-- Font and Layout -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">Ø§Ù„Ø®Ø· ÙˆØ§Ù„ØªØ®Ø·ÙŠØ·</h4>
                            
                            <!-- Header Font Settings -->
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <h5 class="font-medium text-blue-800 mb-3">Ø®Ø· Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©</h5>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
                                        <select id="headerFontFamily" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                            <option value="Cairo">Cairo</option>
                                            <option value="Amiri">Amiri</option>
                                            <option value="Tajawal">Tajawal</option>
                                            <option value="Almarai">Almarai</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·: <span id="headerFontSizeLabel">ÙƒØ¨ÙŠØ±</span></label>
                                        <input type="range" id="headerFontSize" min="16" max="28" value="24" onchange="updateHeaderFontSize()" class="w-full">
                                    </div>
                                </div>
                            </div>

                            <!-- Question Font Settings -->
                            <div class="bg-green-50 p-3 rounded-lg">
                                <h5 class="font-medium text-green-800 mb-3">Ø®Ø· Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h5>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
                                        <select id="questionFontFamily" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500">
                                            <option value="Cairo" selected>Cairo</option>
                                            <option value="Amiri">Amiri</option>
                                            <option value="Tajawal">Tajawal</option>
                                            <option value="Almarai">Almarai</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·: <span id="questionFontSizeLabel">Ù…ØªÙˆØ³Ø·</span></label>
                                        <input type="range" id="questionFontSize" min="14" max="22" value="18" onchange="updateQuestionFontSize()" class="w-full">
                                    </div>
                                </div>
                            </div>

                            <!-- Options Font Settings -->
                            <div class="bg-orange-50 p-3 rounded-lg">
                                <h5 class="font-medium text-orange-800 mb-3">Ø®Ø· Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</h5>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
                                        <select id="optionFontFamily" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-orange-500">
                                            <option value="Cairo" selected>Cairo</option>
                                            <option value="Amiri">Amiri</option>
                                            <option value="Tajawal">Tajawal</option>
                                            <option value="Almarai">Almarai</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·: <span id="optionFontSizeLabel">Ù…ØªÙˆØ³Ø·</span></label>
                                        <input type="range" id="optionFontSize" min="12" max="20" value="16" onchange="updateOptionFontSize()" class="w-full">
                                    </div>
                                </div>
                            </div>

                            <!-- Section Headers Font Settings -->
                            <div class="bg-purple-50 p-3 rounded-lg">
                                <h5 class="font-medium text-purple-800 mb-3">Ø®Ø· Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h5>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
                                        <select id="sectionFontFamily" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-purple-500">
                                            <option value="Cairo" selected>Cairo</option>
                                            <option value="Amiri">Amiri</option>
                                            <option value="Tajawal">Tajawal</option>
                                            <option value="Almarai">Almarai</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·: <span id="sectionFontSizeLabel">Ù…ØªÙˆØ³Ø·</span></label>
                                        <input type="range" id="sectionFontSize" min="14" max="24" value="18" onchange="updateSectionFontSize()" class="w-full">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
                                        <input type="color" id="sectionBgColor" value="#f3f4f6" onchange="updatePreview()" class="w-full h-8 rounded border">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯</label>
                                        <input type="color" id="sectionBorderColor" value="#3b82f6" onchange="updatePreview()" class="w-full h-8 rounded border">
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Ù†Ù…Ø· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                                    <select id="sectionStyle" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                        <option value="modern" selected>Ø¹ØµØ±ÙŠ</option>
                                        <option value="classic">ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ</option>
                                        <option value="minimal">Ø¨Ø³ÙŠØ·</option>
                                        <option value="bold">Ø¹Ø±ÙŠØ¶</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Header Options -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h4>
                            
                            <!-- Header Layout -->
                            <div class="bg-purple-50 p-3 rounded-lg">
                                <h5 class="font-medium text-purple-800 mb-3">ØªØ®Ø·ÙŠØ· Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©</h5>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ù†Ù…Ø· Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©</label>
                                        <select id="headerStyle" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                            <option value="classic">ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ</option>
                                            <option value="modern" selected>Ø¹ØµØ±ÙŠ</option>
                                            <option value="minimal">Ø¨Ø³ÙŠØ·</option>
                                            <option value="formal">Ø±Ø³Ù…ÙŠ</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
                                            <input type="color" id="headerBgColor" value="#f8fafc" onchange="updatePreview()" class="w-full h-8 rounded border">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯</label>
                                            <input type="color" id="headerBorderColor" value="#e5e7eb" onchange="updatePreview()" class="w-full h-8 rounded border">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Header Elements -->
                            <div class="bg-indigo-50 p-3 rounded-lg">
                                <h5 class="font-medium text-indigo-800 mb-3">Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©</h5>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showSubject" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">Ø§Ù„Ù…Ø§Ø¯Ø©</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showGrade" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">Ø§Ù„ØµÙ</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showDuration" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">Ø§Ù„Ù…Ø¯Ø©</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showTotalMarks" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showTeacher" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">Ø§Ù„Ù…Ø¹Ù„Ù…</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showSchool" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showDate" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showLogo" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">Ø§Ù„Ø´Ø¹Ø§Ø±</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Logo Settings -->
                            <div class="bg-pink-50 p-3 rounded-lg">
                                <h5 class="font-medium text-pink-800 mb-3">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¹Ø§Ø±</h5>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¹Ø§Ø±</label>
                                        <select id="logoPosition" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                            <option value="center" selected>ÙˆØ³Ø·</option>
                                            <option value="right">ÙŠÙ…ÙŠÙ†</option>
                                            <option value="left">ÙŠØ³Ø§Ø±</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø­Ø¬Ù… Ø§Ù„Ø´Ø¹Ø§Ø±: <span id="logoSizeLabel">Ù…ØªÙˆØ³Ø·</span></label>
                                            <input type="range" id="logoSize" min="40" max="120" value="80" onchange="updateLogoSize()" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø´ÙƒÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±</label>
                                            <select id="logoShape" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                                <option value="normal" selected>Ø·Ø¨ÙŠØ¹ÙŠ</option>
                                                <option value="circle">Ø¯Ø§Ø¦Ø±ÙŠ</option>
                                                <option value="rounded">Ø²ÙˆØ§ÙŠØ§ Ù…Ø¯ÙˆØ±Ø©</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer Settings -->
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <h5 class="font-medium text-gray-800 mb-3">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showTeacherSignature" checked onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showGoodLuck" checked onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆÙÙŠÙ‚</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Student Info Settings -->
                            <div class="bg-teal-50 p-3 rounded-lg">
                                <h5 class="font-medium text-teal-800 mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h5>
                                <div class="space-y-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="showStudentName" checked onchange="updatePreview()" class="ml-2 text-teal-600">
                                            <span class="text-sm">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="showStudentId" checked onchange="updatePreview()" class="ml-2 text-teal-600">
                                            <span class="text-sm">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="showStudentClass" onchange="updatePreview()" class="ml-2 text-teal-600">
                                            <span class="text-sm">Ø§Ù„Ø´Ø¹Ø¨Ø©</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="showStudentSeat" onchange="updatePreview()" class="ml-2 text-teal-600">
                                            <span class="text-sm">Ø±Ù‚Ù… Ø§Ù„Ù…Ù‚Ø¹Ø¯</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Question Formatting -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h4>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                    <select id="questionNumbering" onchange="updatePreview()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="arabic">Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ© (1ØŒ 2ØŒ 3)</option>
                                        <option value="letters">Ø­Ø±ÙˆÙ (Ø£ØŒ Ø¨ØŒ Ø¬)</option>
                                        <option value="roman">Ø£Ø±Ù‚Ø§Ù… Ø±ÙˆÙ…Ø§Ù†ÙŠØ© (IØŒ IIØŒ III)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø±Ù…ÙˆØ² Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</label>
                                    <select id="optionSymbols" onchange="updatePreview()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="letters">Ø­Ø±ÙˆÙ (Ø£ØŒ Ø¨ØŒ Ø¬ØŒ Ø¯)</option>
                                        <option value="numbers">Ø£Ø±Ù‚Ø§Ù… (1ØŒ 2ØŒ 3ØŒ 4)</option>
                                        <option value="circles">Ø¯ÙˆØ§Ø¦Ø± (â—‹)</option>
                                        <option value="empty">Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ²</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Question Styling -->
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <h5 class="font-medium text-gray-800 mb-3">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showQuestionFrames" onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">Ø¥Ø·Ø§Ø± Ø­ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showMarks" checked onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">Ø¥Ø¸Ù‡Ø§Ø± Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showInstructions" onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="questionBold" checked onchange="updatePreview()" class="ml-2 text-gray-600">
                                        <span class="text-sm">Ù†Øµ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¹Ø±ÙŠØ¶</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Options Styling -->
                            <div class="bg-yellow-50 p-3 rounded-lg">
                                <h5 class="font-medium text-yellow-800 mb-3">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</h5>
                                <div class="space-y-2">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ù†Ù…Ø· Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</label>
                                        <select id="optionStyle" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                            <option value="vertical" selected>Ø¹Ù…ÙˆØ¯ÙŠ</option>
                                            <option value="horizontal">Ø£ÙÙ‚ÙŠ</option>
                                            <option value="grid-2">Ø´Ø¨ÙƒØ© (2 ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±)</option>
                                            <option value="grid-4">Ø´Ø¨ÙƒØ© (4 ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±)</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø´ÙƒÙ„ Ø§Ù„Ø®Ø§Ù†Ø©</label>
                                            <select id="optionBoxStyle" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                                <option value="circle">Ø¯Ø§Ø¦Ø±Ø©</option>
                                                <option value="square">Ù…Ø±Ø¨Ø¹</option>
                                                <option value="none">Ø¨Ø¯ÙˆÙ† Ø®Ø§Ù†Ø©</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø­Ø¬Ù… Ø§Ù„Ø®Ø§Ù†Ø©</label>
                                            <select id="optionBoxSize" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                                <option value="small">ØµØºÙŠØ±</option>
                                                <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                                                <option value="large">ÙƒØ¨ÙŠØ±</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„ØªÙ…Ø±ÙŠØ²</label>
                                        <select id="answerMarkType" onchange="updatePreview()" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                            <option value="numbers">Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (1ØŒ 2ØŒ 3ØŒ 4)</option>
                                            <option value="arabic-letters" selected>Ø­Ø±ÙˆÙ Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø· (Ø£ØŒ Ø¨ØŒ Ø¬ØŒ Ø¯)</option>
                                            <option value="english-letters">Ø­Ø±ÙˆÙ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø· (AØŒ BØŒ CØŒ D)</option>
                                            <option value="empty">ÙØ§Ø±ØºØ© Ù„Ù„ØªÙ…Ø±ÙŠØ²</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Question Organization -->
                            <div class="bg-indigo-50 p-3 rounded-lg">
                                <h5 class="font-medium text-indigo-800 mb-3">ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h5>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="groupByType" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showSectionHeaders" checked onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="showSectionInstructions" onchange="updatePreview()" class="ml-2 text-indigo-600">
                                        <span class="text-sm">ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙƒÙ„ Ù‚Ø³Ù…</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Answer Spaces -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</h4>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù‚ØµÙŠØ±Ø©</label>
                                    <select id="shortAnswerSpace" onchange="updatePreview()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="small">ØµØºÙŠØ± (Ø®Ø· ÙˆØ§Ø­Ø¯)</option>
                                        <option value="medium" selected>Ù…ØªÙˆØ³Ø· (Ø®Ø·ÙŠÙ†)</option>
                                        <option value="large">ÙƒØ¨ÙŠØ± (Ø«Ù„Ø§Ø«Ø© Ø®Ø·ÙˆØ·)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ: <span id="essayLinesLabel">5 Ø®Ø·ÙˆØ·</span></label>
                                    <input type="range" id="essayLines" min="3" max="15" value="5" onchange="updateEssayLines()" class="w-full">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Tab -->
                    <div id="ai-tab" class="space-y-6 hidden">
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
                            <p class="text-sm text-gray-600">Ø£Ù†Ø´Ø¦ Ø£Ø³Ø¦Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</p>
                        </div>

                        <!-- Gemini AI Generator -->
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="font-bold text-purple-800 mb-3">
                                <i class="fas fa-brain ml-2"></i>Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø°ÙƒÙŠ - Gemini AI
                            </h4>
                            <div class="bg-green-100 border border-green-300 rounded p-2 mb-3">
                                <p class="text-xs text-green-800">
                                    <i class="fas fa-check-circle ml-1"></i>
                                    Ù…ØªØµÙ„ Ø¨Ù€ Google Gemini AI Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø³Ø¦Ù„Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙˆÙ…ØªÙ†ÙˆØ¹Ø©
                                </p>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                        <input type="text" id="aiTopic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¬Ø¨Ø±ØŒ Ø§Ù„Ù†Ø­ÙˆØŒ Ø§Ù„Ø®Ù„Ø§ÙŠØ§...">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                        <input type="number" id="aiQuestionCount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="5" min="1" max="20" value="5">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</label>
                                    <select id="difficultyLevel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="easy">Ø³Ù‡Ù„</option>
                                        <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                                        <option value="hard">ØµØ¹Ø¨</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="aiMcq" checked class="ml-2 text-purple-600">
                                            <span class="text-sm">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="aiTrueFalse" class="ml-2 text-purple-600">
                                            <span class="text-sm">ØµØ­ Ø£Ù… Ø®Ø·Ø£</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="aiShort" class="ml-2 text-purple-600">
                                            <span class="text-sm">Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="aiFill" class="ml-2 text-purple-600">
                                            <span class="text-sm">Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº</span>
                                        </label>
                                    </div>
                                </div>

                                <button onclick="generateGeminiAI()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 px-4 rounded-md hover:from-purple-700 hover:to-indigo-700 transition-all">
                                    <i class="fas fa-magic ml-2"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                                </button>
                            </div>
                        </div>

                        <!-- External AI Generator (Offline) -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-bold text-blue-800 mb-3">
                                <i class="fas fa-robot ml-2"></i>Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
                            </h4>
                            <p class="text-sm text-blue-600 mb-4">Ø§Ø³ØªØ®Ø¯Ù… ChatGPT Ø£Ùˆ Claude Ø£Ùˆ Ø£ÙŠ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¢Ø®Ø±</p>
                            
                            <div class="space-y-4">
                                <!-- Step 1: Generate Prompt -->
                                <div class="bg-white p-3 rounded border">
                                    <h5 class="font-semibold text-blue-800 mb-3">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨</h5>
                                    
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
                                            <input type="text" id="externalTopic" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¬Ø¨Ø±ØŒ Ø§Ù„Ù†Ø­Ùˆ...">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                            <input type="number" id="externalCount" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md" value="5" min="1" max="20">
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label>
                                            <select id="externalDifficulty" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                                <option value="easy">Ø³Ù‡Ù„</option>
                                                <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                                                <option value="hard">ØµØ¹Ø¨</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Ø§Ù„ØµÙ</label>
                                            <select id="externalGrade" class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                                                <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                                                <option value="9">Ø§Ù„ØªØ§Ø³Ø¹</option>
                                                <option value="10">Ø§Ù„Ø¹Ø§Ø´Ø±</option>
                                                <option value="11">Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±</option>
                                                <option value="12">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
                                        <div class="grid grid-cols-2 gap-1">
                                            <label class="flex items-center text-xs">
                                                <input type="checkbox" id="externalMcq" checked class="ml-1">
                                                <span>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</span>
                                            </label>
                                            <label class="flex items-center text-xs">
                                                <input type="checkbox" id="externalTrueFalse" class="ml-1">
                                                <span>ØµØ­ Ø£Ù… Ø®Ø·Ø£</span>
                                            </label>
                                            <label class="flex items-center text-xs">
                                                <input type="checkbox" id="externalShort" class="ml-1">
                                                <span>Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©</span>
                                            </label>
                                            <label class="flex items-center text-xs">
                                                <input type="checkbox" id="externalFill" class="ml-1">
                                                <span>Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button onclick="generateExternalPrompt()" class="w-full bg-blue-600 text-white py-2 px-3 rounded-md hover:bg-blue-700 transition-all text-sm">
                                        <i class="fas fa-magic ml-1"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Øµ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                                    </button>
                                </div>
                                
                                <!-- Generated Prompt Display -->
                                <div id="generatedPrompt" class="hidden bg-green-50 border border-green-200 rounded p-3">
                                    <h5 class="font-semibold text-green-800 mb-2">Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙÙˆÙ„Ø¯ - Ø§Ù†Ø³Ø®Ù‡ ÙˆØ§Ø³ØªØ®Ø¯Ù…Ù‡:</h5>
                                    <div class="bg-white p-3 rounded border text-sm" style="direction: ltr; text-align: left;">
                                        <pre id="promptText" class="whitespace-pre-wrap text-xs"></pre>
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="copyPromptToClipboard()" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                            <i class="fas fa-copy ml-1"></i>Ù†Ø³Ø® Ø§Ù„Ù†Øµ
                                        </button>
                                        <button onclick="openChatGPT()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                            <i class="fas fa-external-link-alt ml-1"></i>ÙØªØ­ ChatGPT
                                        </button>
                                        <button onclick="openClaude()" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700">
                                            <i class="fas fa-external-link-alt ml-1"></i>ÙØªØ­ Claude
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Step 2: Paste AI Response -->
                                <div class="bg-white p-3 rounded border">
                                    <h5 class="font-semibold text-blue-800 mb-3">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù„ØµÙ‚ Ø±Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h5>
                                    <textarea id="aiResponseText" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø±Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©..."></textarea>
                                    <button onclick="parseExternalAIResponse()" class="w-full mt-2 bg-green-600 text-white py-2 px-3 rounded-md hover:bg-green-700 transition-all text-sm">
                                        <i class="fas fa-cogs ml-1"></i>ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù…ØªØ­Ø§Ù†
                                    </button>
                                </div>
                                
                                <!-- Instructions -->
                                <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                                    <h5 class="font-semibold text-yellow-800 mb-2">ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</h5>
                                    <ol class="text-xs text-yellow-700 space-y-1">
                                        <li>1. Ø§Ù…Ù„Ø£ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Øµ"</li>
                                        <li>2. Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙÙˆÙ„Ø¯</li>
                                        <li>3. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ChatGPT Ø£Ùˆ Claude ÙˆØ§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ</li>
                                        <li>4. Ø§Ù†Ø³Ø® Ø±Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØ§Ù„ØµÙ‚Ù‡ ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø© Ø£Ø¹Ù„Ø§Ù‡</li>
                                        <li>5. Ø§Ø¶ØºØ· "ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù…ØªØ­Ø§Ù†"</li>
                                    </ol>
                                </div>
                            </div>
                        </div>



                        <!-- Status Messages -->
                        <div id="aiSuccess" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 ml-2"></i>
                                <div>
                                    <p class="text-green-800 font-medium">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!</p>
                                    <p class="text-green-600 text-sm" id="aiSuccessMessage"></p>
                                </div>
                            </div>
                        </div>

                        <div id="aiError" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-600 ml-2"></i>
                                <div>
                                    <p class="text-red-800 font-medium">Ø­Ø¯Ø« Ø®Ø·Ø£</p>
                                    <p class="text-red-600 text-sm" id="aiErrorMessage"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Marks Control -->
                    <div class="mt-6 pt-4 border-t">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
                        <div class="grid grid-cols-1 gap-2">
                            <button onclick="bulkEditMarks()" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition-colors text-sm">
                                <i class="fas fa-edit ml-1"></i>ØªØ¹Ø¯ÙŠÙ„ Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù„Ø¯Ø±Ø¬Ø§Øª
                            </button>
                            <button onclick="toggleAllMarks()" class="bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 transition-colors text-sm">
                                <i class="fas fa-eye-slash ml-1"></i>Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
                            </button>
                            <button onclick="calculateTotalMarks()" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 transition-colors text-sm">
                                <i class="fas fa-calculator ml-1"></i>Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ
                            </button>
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="mt-6 pt-4 border-t">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">ØªØµØ¯ÙŠØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h3>
                        <div class="grid grid-cols-1 gap-3">
                            <!-- PDF Options -->
                            <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                <h4 class="font-medium text-red-800 mb-2">ØªØµØ¯ÙŠØ± PDF</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <button onclick="saveToPDF()" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition-colors text-sm">
                                        <i class="fas fa-file-pdf ml-1"></i>PDF Ø¹Ø§Ø¯ÙŠ
                                    </button>
                                    <button onclick="saveToAdvancedPDF()" class="bg-red-700 text-white py-2 px-4 rounded-md hover:bg-red-800 transition-colors text-sm">
                                        <i class="fas fa-file-pdf ml-1"></i>PDF Ù…ØªÙ‚Ø¯Ù… (html2pdf)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Image Options -->
                            <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                                <h4 class="font-medium text-green-800 mb-2">ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <button onclick="downloadAsImages()" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors text-sm">
                                        <i class="fas fa-images ml-1"></i>ØµÙˆØ± PNG (html2canvas)
                                    </button>
                                    <button onclick="downloadAsImagesAdvanced()" class="bg-green-700 text-white py-2 px-4 rounded-md hover:bg-green-800 transition-colors text-sm">
                                        <i class="fas fa-images ml-1"></i>ØµÙˆØ± Ù…ØªÙ‚Ø¯Ù…Ø© (dom-to-image)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Print Options -->
                            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                <h4 class="font-medium text-blue-800 mb-2">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <button onclick="printExam()" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors text-sm">
                                        <i class="fas fa-print ml-1"></i>Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø§Ø¯ÙŠØ©
                                    </button>
                                    <button onclick="printExamAdvanced()" class="bg-blue-700 text-white py-2 px-4 rounded-md hover:bg-blue-800 transition-colors text-sm">
                                        <i class="fas fa-print ml-1"></i>Ø·Ø¨Ø§Ø¹Ø© Ù…ØªÙ‚Ø¯Ù…Ø© (Print.js)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Other Options -->
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <h4 class="font-medium text-gray-800 mb-2">Ø®ÙŠØ§Ø±Ø§Øª Ø£Ø®Ø±Ù‰</h4>
                                <div class="grid grid-cols-1 gap-2">
                                    <button onclick="copyToClipboard()" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors text-sm">
                                        <i class="fas fa-copy ml-1"></i>Ù†Ø³Ø® Ø§Ù„Ù†Øµ
                                    </button>
                                    <button onclick="saveAsHTML()" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition-colors text-sm">
                                        <i class="fas fa-code ml-1"></i>Ø­ÙØ¸ HTML
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Questions List -->
                <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                        <span id="questionCount" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">0 Ø³Ø¤Ø§Ù„</span>
                    </div>
                    <div id="questionsList" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-question-circle text-4xl mb-3 opacity-50"></i>
                            <p>Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯</p>
                            <p class="text-sm">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø©</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-4 sticky top-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h3>
                        <button onclick="updatePreview()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-md text-sm hover:bg-blue-200 transition-colors">
                            <i class="fas fa-refresh ml-1"></i>ØªØ­Ø¯ÙŠØ«
                        </button>
                    </div>

                    <div class="preview-container" id="previewContainer">
                        <div class="page-preview" style="max-height: 80vh; overflow-y: auto; transform: scale(0.8); transform-origin: top right; width: 125%;">
                            <div id="examPreview">
                                <!-- Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‡Ù†Ø§ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Format Toolbar -->
    <div id="formatToolbar" class="format-toolbar">
        <div class="text-center mb-2">
            <h6 class="text-sm font-bold text-gray-800">Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ†Ø³ÙŠÙ‚</h6>
        </div>
        
        <button onclick="formatSelectedText('bold')" title="Ø¹Ø±ÙŠØ¶">
            <i class="fas fa-bold ml-1"></i>Ø¹Ø±ÙŠØ¶
        </button>
        <button onclick="formatSelectedText('italic')" title="Ù…Ø§Ø¦Ù„">
            <i class="fas fa-italic ml-1"></i>Ù…Ø§Ø¦Ù„
        </button>
        <button onclick="formatSelectedText('underline')" title="ØªØ­ØªÙ‡ Ø®Ø·">
            <i class="fas fa-underline ml-1"></i>ØªØ­ØªÙ‡ Ø®Ø·
        </button>
        
        <div class="border-t border-gray-200 my-2"></div>
        
        <button onclick="formatSelectedText('fontSize', '18px')" title="Ø®Ø· ÙƒØ¨ÙŠØ±">
            <i class="fas fa-text-height ml-1"></i>Ø®Ø· ÙƒØ¨ÙŠØ±
        </button>
        <button onclick="formatSelectedText('fontSize', '14px')" title="Ø®Ø· ØµØºÙŠØ±">
            <i class="fas fa-compress-alt ml-1"></i>Ø®Ø· ØµØºÙŠØ±
        </button>
        
        <div class="border-t border-gray-200 my-2"></div>
        
        <div class="flex items-center gap-2">
            <label class="text-xs">Ù„ÙˆÙ† Ø§Ù„Ù†Øµ:</label>
            <input type="color" id="toolbarTextColor" onchange="formatSelectedText('color', this.value)" class="w-6 h-6 rounded">
        </div>
        
        <div class="flex items-center gap-2">
            <label class="text-xs">Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©:</label>
            <input type="color" id="toolbarBgColor" onchange="formatSelectedText('backgroundColor', this.value)" class="w-6 h-6 rounded">
        </div>
        
        <div class="border-t border-gray-200 my-2"></div>
        
        <button onclick="formatSelectedText('alignCenter')" title="Ù…Ø­Ø§Ø°Ø§Ø© ÙˆØ³Ø·">
            <i class="fas fa-align-center ml-1"></i>ÙˆØ³Ø·
        </button>
        <button onclick="formatSelectedText('alignRight')" title="Ù…Ø­Ø§Ø°Ø§Ø© ÙŠÙ…ÙŠÙ†">
            <i class="fas fa-align-right ml-1"></i>ÙŠÙ…ÙŠÙ†
        </button>
        <button onclick="formatSelectedText('alignLeft')" title="Ù…Ø­Ø§Ø°Ø§Ø© ÙŠØ³Ø§Ø±">
            <i class="fas fa-align-left ml-1"></i>ÙŠØ³Ø§Ø±
        </button>
        
        <div class="border-t border-gray-200 my-2"></div>
        
        <button onclick="applyQuickFormatToSelected('highlight')" class="bg-yellow-100 text-yellow-800">
            <i class="fas fa-highlighter ml-1"></i>ØªÙ…ÙŠÙŠØ²
        </button>
        <button onclick="applyQuickFormatToSelected('important')" class="bg-red-100 text-red-800">
            <i class="fas fa-exclamation-triangle ml-1"></i>Ù…Ù‡Ù…
        </button>
        
        <div class="border-t border-gray-200 my-2"></div>
        
        <button onclick="clearFormatting()" class="bg-gray-100 text-gray-800">
            <i class="fas fa-eraser ml-1"></i>Ù…Ø³Ø­ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
        </button>
        
        <button onclick="closeFormatToolbar()" class="bg-red-100 text-red-800 mt-2">
            <i class="fas fa-times ml-1"></i>Ø¥ØºÙ„Ø§Ù‚
        </button>
    </div>

    <script>
        // Global variables
        let questions = [];
        const GEMINI_API_KEY = 'AIzaSyC7MgGE_ygA_T16_KBzZbJJxEQvqu7cfe8'; // Ù…ÙØªØ§Ø­ API Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';
        let isAIConnected = false;
        let schoolLogoData = null;
        let headerTemplateData = null;
        let showHeaderTemplate = true;
        let librariesLoaded = false;
        
        // Manual editing variables
        let isManualEditMode = false;
        let currentEditingElement = null;
        let originalContent = '';
        let hasUnsavedChanges = false;
        
        // Header template settings
        let headerSettings = {
            // Position and Movement
            xPosition: 0,
            yPosition: 0,
            rotation: 0,
            skew: 0,
            
            // Size and Dimensions
            width: 100,
            height: 200,
            scale: 100,
            aspectRatio: 'auto',
            
            // Alignment and Display
            alignment: 'center',
            verticalAlign: 'middle',
            displayMode: 'contain',
            zIndex: 1,
            
            // Spacing and Padding
            marginTop: 0,
            marginBottom: 20,
            marginRight: 0,
            marginLeft: 0,
            padding: 0,
            gap: 0,
            
            // Borders and Shadows
            borderRadius: 8,
            borderWidth: 0,
            borderColor: '#e5e7eb',
            borderStyle: 'solid',
            shadow: 1,
            shadowColor: '#000000',
            
            // Effects and Filters
            opacity: 100,
            blur: 0,
            brightness: 100,
            contrast: 100,
            saturation: 100,
            hue: 0,
            grayscale: false,
            sepia: false,
            invert: false,
            dropShadow: false,
            
            // Background and Patterns
            bgColor: '#ffffff',
            bgOpacity: 0,
            backgroundPattern: 'none',
            gradientOverlay: false,
            roundedCorners: false
        };

        // Check if required libraries are loaded
        function checkLibraries() {
            const checks = {
                tailwind: typeof window.tailwind !== 'undefined' || document.querySelector('script[src*="tailwindcss"]'),
                html2canvas: typeof html2canvas !== 'undefined',
                jsPDF: typeof window.jspdf !== 'undefined',
                domtoimage: typeof domtoimage !== 'undefined',
                fabric: typeof fabric !== 'undefined',
                printjs: typeof printJS !== 'undefined',
                html2pdf: typeof html2pdf !== 'undefined',
                saveAs: typeof saveAs !== 'undefined'
            };
            
            const missing = Object.keys(checks).filter(lib => !checks[lib]);
            
            if (missing.length > 0) {
                console.warn('Ù…ÙƒØªØ¨Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©:', missing);
                showNotification(`Ù…ÙƒØªØ¨Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©: ${missing.join(', ')}. Ø¨Ø¹Ø¶ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ`, 'warning');
            }
            
            // Check if at least basic libraries are loaded
            const basicLibsLoaded = checks.html2canvas && checks.jsPDF;
            if (basicLibsLoaded) {
                librariesLoaded = true;
                console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…');
                if (missing.length === 0) {
                    console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸš€');
                }
                return true;
            }
            
            return false;
        }

        // Wait for libraries to load
        function waitForLibraries() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 20;
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (checkLibraries() || attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        resolve(librariesLoaded);
                    }
                }, 500);
            });
        }
        
        // Initialize the application with error handling
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹...');
                
                // Check if all required elements exist
                const requiredElements = ['examTitle', 'examPreview', 'questionsList'];
                const missingElements = requiredElements.filter(id => !document.getElementById(id));
                
                if (missingElements.length > 0) {
                    console.error('Ø¹Ù†Ø§ØµØ± Ù…ÙÙ‚ÙˆØ¯Ø©:', missingElements);
                    showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© - Ø¹Ù†Ø§ØµØ± Ù…ÙÙ‚ÙˆØ¯Ø©', 'error');
                    return;
                }
                
                // Set current date
                const today = new Date().toISOString().split('T')[0];
                const examDateElement = document.getElementById('examDate');
                if (examDateElement) {
                    examDateElement.value = today;
                }
                
                // Initialize functions with error handling after libraries load
                waitForLibraries().then(() => {
                    setTimeout(() => {
                        try {
                            updatePreview();
                            toggleQuestionOptions();
                            testAIConnection();
                            console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
                            showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰', 'success');
                        } catch (initError) {
                            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', initError);
                            showNotification('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                        }
                    }, 500);
                });
                
                // Add event listeners for real-time updates with error handling
                const inputs = ['examTitle', 'subject', 'grade', 'duration', 'totalMarks', 'teacherName', 'schoolName', 'examDate'];
                inputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', safeUpdatePreview);
                        element.addEventListener('change', safeUpdatePreview);
                    }
                });

                // Add event listeners for formatting controls with error handling
                const formatControls = [
                    'headerFontFamily', 'headerFontSize', 'questionFontFamily', 'questionFontSize',
                    'optionFontFamily', 'optionFontSize', 'sectionFontFamily', 'sectionFontSize',
                    'headerStyle', 'headerBgColor', 'headerBorderColor', 'showQuestionFrames',
                    'showMarks', 'showInstructions', 'questionBold', 'questionNumbering',
                    'optionSymbols', 'optionStyle', 'optionBoxStyle', 'optionBoxSize',
                    'answerMarkType', 'shortAnswerSpace', 'essayLines', 'groupByType',
                    'showSectionHeaders', 'showSectionInstructions', 'showSubject', 'showGrade',
                    'showDuration', 'showTotalMarks', 'showTeacher', 'showSchool', 'showDate',
                    'showLogo', 'showStudentName', 'showStudentId', 'showStudentClass', 'showStudentSeat',
                    'logoPosition', 'logoSize', 'logoShape', 'showTeacherSignature', 'showGoodLuck',
                    'dateFormat', 'sectionBgColor', 'sectionBorderColor', 'sectionStyle'
                ];
                
                formatControls.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', safeUpdatePreview);
                        element.addEventListener('change', safeUpdatePreview);
                    }
                });
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©:', error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©', 'error');
            }
        });

        // Safe update preview function with error handling
        function safeUpdatePreview() {
            try {
                updatePreview();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©:', error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©', 'warning');
            }
        }

        // Logo handling functions
        function handleLogoUpload() {
            const fileInput = document.getElementById('schoolLogoFile');
            const file = fileInput.files[0];
            
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ØµØºØ± Ù…Ù† 5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    schoolLogoData = e.target.result;
                    document.getElementById('logoImage').src = schoolLogoData;
                    document.getElementById('logoPreview').classList.remove('hidden');
                    updatePreview();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() {
            schoolLogoData = null;
            document.getElementById('schoolLogoFile').value = '';
            document.getElementById('logoPreview').classList.add('hidden');
            updatePreview();
        }

        // Header Template handling functions
        function handleHeaderTemplateUpload() {
            const fileInput = document.getElementById('headerTemplateFile');
            const file = fileInput.files[0];
            
            if (file) {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    showNotification('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ØµØºØ± Ù…Ù† 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    headerTemplateData = e.target.result;
                    document.getElementById('headerTemplateImage').src = headerTemplateData;
                    document.getElementById('headerTemplatePreview').classList.remove('hidden');
                    showHeaderTemplate = true;
                    updateToggleHeaderButton();
                    updatePreview();
                    showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ¨', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeHeaderTemplate() {
            headerTemplateData = null;
            showHeaderTemplate = true;
            document.getElementById('headerTemplateFile').value = '';
            document.getElementById('headerTemplatePreview').classList.add('hidden');
            updatePreview();
            showNotification('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©', 'info');
        }

        function toggleHeaderTemplate() {
            showHeaderTemplate = !showHeaderTemplate;
            updateToggleHeaderButton();
            updatePreview();
            const status = showHeaderTemplate ? 'Ø¥Ø¸Ù‡Ø§Ø±' : 'Ø¥Ø®ÙØ§Ø¡';
            showNotification(`ØªÙ… ${status} Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©`, 'info');
        }

        function updateToggleHeaderButton() {
            const button = document.getElementById('toggleHeaderBtn');
            if (button) {
                if (showHeaderTemplate) {
                    button.innerHTML = '<i class="fas fa-eye-slash ml-1"></i>Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©';
                    button.className = 'text-blue-600 text-sm hover:text-blue-800 px-2 py-1 rounded border border-blue-200 hover:bg-blue-50';
                } else {
                    button.innerHTML = '<i class="fas fa-eye ml-1"></i>Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©';
                    button.className = 'text-green-600 text-sm hover:text-green-800 px-2 py-1 rounded border border-green-200 hover:bg-green-50';
                }
            }
        }

        // Header template control functions
        function updateHeaderPosition() {
            const xPosition = document.getElementById('headerXPosition')?.value || 0;
            const yPosition = document.getElementById('headerYPosition')?.value || 0;
            const rotation = document.getElementById('headerRotation')?.value || 0;
            const skew = document.getElementById('headerSkew')?.value || 0;
            
            headerSettings.xPosition = parseInt(xPosition);
            headerSettings.yPosition = parseInt(yPosition);
            headerSettings.rotation = parseInt(rotation);
            headerSettings.skew = parseInt(skew);
            
            document.getElementById('headerXPositionLabel').textContent = xPosition + 'px';
            document.getElementById('headerYPositionLabel').textContent = yPosition + 'px';
            document.getElementById('headerRotationLabel').textContent = rotation + 'Â°';
            document.getElementById('headerSkewLabel').textContent = skew + 'Â°';
            
            updatePreview();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©', 'info');
        }

        function updateHeaderSize() {
            const width = document.getElementById('headerWidth')?.value || 100;
            const height = document.getElementById('headerHeight')?.value || 200;
            const scale = document.getElementById('headerScale')?.value || 100;
            const aspectRatio = document.getElementById('headerAspectRatio')?.value || 'auto';
            
            headerSettings.width = parseInt(width);
            headerSettings.height = parseInt(height);
            headerSettings.scale = parseInt(scale);
            headerSettings.aspectRatio = aspectRatio;
            
            document.getElementById('headerWidthLabel').textContent = width + '%';
            document.getElementById('headerHeightLabel').textContent = height + 'px';
            document.getElementById('headerScaleLabel').textContent = scale + '%';
            
            updatePreview();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ù… Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©', 'info');
        }

        function updateHeaderStyle() {
            const alignment = document.getElementById('headerAlignment')?.value || 'center';
            const verticalAlign = document.getElementById('headerVerticalAlign')?.value || 'middle';
            const displayMode = document.getElementById('headerDisplayMode')?.value || 'contain';
            const zIndex = document.getElementById('headerZIndex')?.value || 1;
            
            headerSettings.alignment = alignment;
            headerSettings.verticalAlign = verticalAlign;
            headerSettings.displayMode = displayMode;
            headerSettings.zIndex = parseInt(zIndex);
            
            document.getElementById('headerZIndexLabel').textContent = zIndex;
            
            updatePreview();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù†Ù…Ø· Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©', 'info');
        }

        function updateHeaderSpacing() {
            const marginTop = document.getElementById('headerMarginTop')?.value || 0;
            const marginBottom = document.getElementById('headerMarginBottom')?.value || 20;
            const marginRight = document.getElementById('headerMarginRight')?.value || 0;
            const marginLeft = document.getElementById('headerMarginLeft')?.value || 0;
            const padding = document.getElementById('headerPadding')?.value || 0;
            const gap = document.getElementById('headerGap')?.value || 0;
            
            headerSettings.marginTop = parseInt(marginTop);
            headerSettings.marginBottom = parseInt(marginBottom);
            headerSettings.marginRight = parseInt(marginRight);
            headerSettings.marginLeft = parseInt(marginLeft);
            headerSettings.padding = parseInt(padding);
            headerSettings.gap = parseInt(gap);
            
            document.getElementById('headerMarginTopLabel').textContent = marginTop + 'px';
            document.getElementById('headerMarginBottomLabel').textContent = marginBottom + 'px';
            document.getElementById('headerMarginRightLabel').textContent = marginRight + 'px';
            document.getElementById('headerMarginLeftLabel').textContent = marginLeft + 'px';
            document.getElementById('headerPaddingLabel').textContent = padding + 'px';
            document.getElementById('headerGapLabel').textContent = gap + 'px';
            
            updatePreview();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§ÙØ§Øª', 'info');
        }

        function updateHeaderBorder() {
            const borderRadius = document.getElementById('headerBorderRadius')?.value || 8;
            const borderWidth = document.getElementById('headerBorderWidth')?.value || 0;
            const borderColor = document.getElementById('headerBorderColor')?.value || '#e5e7eb';
            const borderStyle = document.getElementById('headerBorderStyle')?.value || 'solid';
            const shadow = document.getElementById('headerShadow')?.value || 1;
            const shadowColor = document.getElementById('headerShadowColor')?.value || '#000000';
            
            headerSettings.borderRadius = parseInt(borderRadius);
            headerSettings.borderWidth = parseInt(borderWidth);
            headerSettings.borderColor = borderColor;
            headerSettings.borderStyle = borderStyle;
            headerSettings.shadow = parseInt(shadow);
            headerSettings.shadowColor = shadowColor;
            
            document.getElementById('headerBorderRadiusLabel').textContent = borderRadius + 'px';
            document.getElementById('headerBorderWidthLabel').textContent = borderWidth + 'px';
            
            const shadowLabels = ['Ø¨Ø¯ÙˆÙ†', 'Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹', 'Ø®ÙÙŠÙ', 'Ù…ØªÙˆØ³Ø·', 'Ù‚ÙˆÙŠ', 'Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹'];
            document.getElementById('headerShadowLabel').textContent = shadowLabels[shadow] || 'Ø®ÙÙŠÙ';
            
            updatePreview();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¯ÙˆØ¯ ÙˆØ§Ù„Ø¸Ù„', 'info');
        }

        function updateHeaderFilters() {
            const opacity = document.getElementById('headerOpacity')?.value || 100;
            const blur = document.getElementById('headerBlur')?.value || 0;
            const brightness = document.getElementById('headerBrightness')?.value || 100;
            const contrast = document.getElementById('headerContrast')?.value || 100;
            const saturation = document.getElementById('headerSaturation')?.value || 100;
            const hue = document.getElementById('headerHue')?.value || 0;
            const grayscale = document.getElementById('headerGrayscale')?.checked || false;
            const sepia = document.getElementById('headerSepia')?.checked || false;
            const invert = document.getElementById('headerInvert')?.checked || false;
            const dropShadow = document.getElementById('headerDropShadow')?.checked || false;
            
            headerSettings.opacity = parseInt(opacity);
            headerSettings.blur = parseInt(blur);
            headerSettings.brightness = parseInt(brightness);
            headerSettings.contrast = parseInt(contrast);
            headerSettings.saturation = parseInt(saturation);
            headerSettings.hue = parseInt(hue);
            headerSettings.grayscale = grayscale;
            headerSettings.sepia = sepia;
            headerSettings.invert = invert;
            headerSettings.dropShadow = dropShadow;
            
            document.getElementById('headerOpacityLabel').textContent = opacity + '%';
            document.getElementById('headerBlurLabel').textContent = blur + 'px';
            document.getElementById('headerBrightnessLabel').textContent = brightness + '%';
            document.getElementById('headerContrastLabel').textContent = contrast + '%';
            document.getElementById('headerSaturationLabel').textContent = saturation + '%';
            document.getElementById('headerHueLabel').textContent = hue + 'Â°';
            
            updatePreview();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª', 'info');
        }

        function updateHeaderBackground() {
            const bgColor = document.getElementById('headerBgColor')?.value || '#ffffff';
            const bgOpacity = document.getElementById('headerBgOpacity')?.value || 0;
            const backgroundPattern = document.getElementById('headerBackgroundPattern')?.value || 'none';
            const gradientOverlay = document.getElementById('headerGradientOverlay')?.checked || false;
            const roundedCorners = document.getElementById('headerRoundedCorners')?.checked || false;
            
            headerSettings.bgColor = bgColor;
            headerSettings.bgOpacity = parseInt(bgOpacity);
            headerSettings.backgroundPattern = backgroundPattern;
            headerSettings.gradientOverlay = gradientOverlay;
            headerSettings.roundedCorners = roundedCorners;
            
            document.getElementById('headerBgOpacityLabel').textContent = bgOpacity + '%';
            
            updatePreview();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©', 'info');
        }

        function resetHeaderSettings() {
            // Reset to default values
            headerSettings = {
                width: 100,
                height: 200,
                alignment: 'center',
                displayMode: 'contain',
                marginTop: 0,
                marginBottom: 20,
                borderRadius: 8,
                shadow: 1,
                border: false,
                grayscale: false,
                sepia: false,
                opacity: 100
            };
            
            // Update UI controls
            document.getElementById('headerWidth').value = 100;
            document.getElementById('headerHeight').value = 200;
            document.getElementById('headerAlignment').value = 'center';
            document.getElementById('headerDisplayMode').value = 'contain';
            document.getElementById('headerMarginTop').value = 0;
            document.getElementById('headerMarginBottom').value = 20;
            document.getElementById('headerBorderRadius').value = 8;
            document.getElementById('headerShadow').value = 1;
            document.getElementById('headerBorder').checked = false;
            document.getElementById('headerGrayscale').checked = false;
            document.getElementById('headerSepia').checked = false;
            document.getElementById('headerOpacity').value = 100;
            
            // Update labels
            document.getElementById('headerWidthLabel').textContent = '100%';
            document.getElementById('headerHeightLabel').textContent = '200px';
            document.getElementById('headerMarginTopLabel').textContent = '0px';
            document.getElementById('headerMarginBottomLabel').textContent = '20px';
            document.getElementById('headerBorderRadiusLabel').textContent = '8px';
            document.getElementById('headerShadowLabel').textContent = 'Ø®ÙÙŠÙ';
            document.getElementById('headerOpacityLabel').textContent = '100%';
            
            updatePreview();
            showNotification('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©! ğŸ”„', 'success');
        }

        function duplicateHeaderTemplate() {
            if (!headerTemplateData) {
                showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ±ÙˆÙŠØ³Ø© Ù„Ù†Ø³Ø® Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙ‡Ø§', 'warning');
                return;
            }
            
            // Copy current settings to clipboard as JSON
            const settingsText = JSON.stringify(headerSettings, null, 2);
            
            navigator.clipboard.writeText(settingsText).then(() => {
                showNotification('ØªÙ… Ù†Ø³Ø® Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©! ğŸ“‹', 'success');
            }).catch(() => {
                // Fallback: show settings in alert
                alert('Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©:\n\n' + settingsText);
                showNotification('ØªÙ… Ø¹Ø±Ø¶ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©', 'info');
            });
        }

        // Quick Control Functions
        function centerHeaderTemplate() {
            headerSettings.xPosition = 0;
            headerSettings.yPosition = 0;
            headerSettings.alignment = 'center';
            
            // Update UI
            if (document.getElementById('headerXPosition')) {
                document.getElementById('headerXPosition').value = 0;
                document.getElementById('headerXPositionLabel').textContent = '0px';
            }
            if (document.getElementById('headerYPosition')) {
                document.getElementById('headerYPosition').value = 0;
                document.getElementById('headerYPositionLabel').textContent = '0px';
            }
            if (document.getElementById('headerAlignment')) {
                document.getElementById('headerAlignment').value = 'center';
            }
            
            updatePreview();
            showNotification('ØªÙ… ØªÙˆØ³ÙŠØ· Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©! ğŸ¯', 'success');
        }

        function resetHeaderPosition() {
            headerSettings.xPosition = 0;
            headerSettings.yPosition = 0;
            headerSettings.rotation = 0;
            headerSettings.skew = 0;
            headerSettings.scale = 100;
            
            // Update UI
            if (document.getElementById('headerXPosition')) {
                document.getElementById('headerXPosition').value = 0;
                document.getElementById('headerXPositionLabel').textContent = '0px';
            }
            if (document.getElementById('headerYPosition')) {
                document.getElementById('headerYPosition').value = 0;
                document.getElementById('headerYPositionLabel').textContent = '0px';
            }
            if (document.getElementById('headerRotation')) {
                document.getElementById('headerRotation').value = 0;
                document.getElementById('headerRotationLabel').textContent = '0Â°';
            }
            if (document.getElementById('headerSkew')) {
                document.getElementById('headerSkew').value = 0;
                document.getElementById('headerSkewLabel').textContent = '0Â°';
            }
            if (document.getElementById('headerScale')) {
                document.getElementById('headerScale').value = 100;
                document.getElementById('headerScaleLabel').textContent = '100%';
            }
            
            updatePreview();
            showNotification('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©! ğŸ“', 'success');
        }

        function fitHeaderToWidth() {
            headerSettings.width = 100;
            headerSettings.alignment = 'justify';
            
            // Update UI
            if (document.getElementById('headerWidth')) {
                document.getElementById('headerWidth').value = 100;
                document.getElementById('headerWidthLabel').textContent = '100%';
            }
            if (document.getElementById('headerAlignment')) {
                document.getElementById('headerAlignment').value = 'justify';
            }
            
            updatePreview();
            showNotification('ØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„! â†”ï¸', 'success');
        }

        function makeHeaderSquare() {
            headerSettings.aspectRatio = '1/1';
            headerSettings.width = 50;
            headerSettings.alignment = 'center';
            
            // Update UI
            if (document.getElementById('headerAspectRatio')) {
                document.getElementById('headerAspectRatio').value = '1/1';
            }
            if (document.getElementById('headerWidth')) {
                document.getElementById('headerWidth').value = 50;
                document.getElementById('headerWidthLabel').textContent = '50%';
            }
            if (document.getElementById('headerAlignment')) {
                document.getElementById('headerAlignment').value = 'center';
            }
            
            updatePreview();
            showNotification('ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø¥Ù„Ù‰ Ù…Ø±Ø¨Ø¹! â¬œ', 'success');
        }

        function rotateHeader90() {
            headerSettings.rotation = (headerSettings.rotation + 90) % 360;
            
            // Update UI
            if (document.getElementById('headerRotation')) {
                document.getElementById('headerRotation').value = headerSettings.rotation;
                document.getElementById('headerRotationLabel').textContent = headerSettings.rotation + 'Â°';
            }
            
            updatePreview();
            showNotification(`ØªÙ… Ø¯ÙˆØ±Ø§Ù† Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø¥Ù„Ù‰ ${headerSettings.rotation}Â°! ğŸ”„`, 'success');
        }

        function flipHeaderHorizontal() {
            headerSettings.scale = headerSettings.scale > 0 ? -Math.abs(headerSettings.scale) : Math.abs(headerSettings.scale);
            
            // Update UI
            if (document.getElementById('headerScale')) {
                document.getElementById('headerScale').value = Math.abs(headerSettings.scale);
                document.getElementById('headerScaleLabel').textContent = Math.abs(headerSettings.scale) + '%';
            }
            
            updatePreview();
            showNotification('ØªÙ… Ø§Ù†Ø¹ÙƒØ§Ø³ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø£ÙÙ‚ÙŠØ§Ù‹! â†”ï¸', 'success');
        }

        // Preset Styles Functions
        function applyHeaderPreset(presetName) {
            switch (presetName) {
                case 'modern':
                    Object.assign(headerSettings, {
                        borderRadius: 15,
                        shadow: 2,
                        borderWidth: 0,
                        blur: 0,
                        brightness: 110,
                        contrast: 105,
                        saturation: 110,
                        backgroundPattern: 'none',
                        gradientOverlay: true,
                        roundedCorners: true
                    });
                    break;
                    
                case 'classic':
                    Object.assign(headerSettings, {
                        borderRadius: 0,
                        shadow: 1,
                        borderWidth: 2,
                        borderStyle: 'solid',
                        borderColor: '#374151',
                        blur: 0,
                        brightness: 100,
                        contrast: 100,
                        saturation: 90,
                        backgroundPattern: 'none',
                        gradientOverlay: false,
                        roundedCorners: false
                    });
                    break;
                    
                case 'elegant':
                    Object.assign(headerSettings, {
                        borderRadius: 25,
                        shadow: 3,
                        borderWidth: 1,
                        borderStyle: 'solid',
                        borderColor: '#d1d5db',
                        blur: 0,
                        brightness: 105,
                        contrast: 102,
                        saturation: 105,
                        backgroundPattern: 'dots',
                        gradientOverlay: true,
                        roundedCorners: true,
                        opacity: 95
                    });
                    break;
                    
                case 'minimal':
                    Object.assign(headerSettings, {
                        borderRadius: 8,
                        shadow: 0,
                        borderWidth: 0,
                        blur: 0,
                        brightness: 100,
                        contrast: 100,
                        saturation: 100,
                        backgroundPattern: 'none',
                        gradientOverlay: false,
                        roundedCorners: false,
                        opacity: 100
                    });
                    break;
                    
                case 'bold':
                    Object.assign(headerSettings, {
                        borderRadius: 5,
                        shadow: 4,
                        borderWidth: 3,
                        borderStyle: 'solid',
                        borderColor: '#1f2937',
                        blur: 0,
                        brightness: 120,
                        contrast: 120,
                        saturation: 130,
                        backgroundPattern: 'lines',
                        gradientOverlay: false,
                        roundedCorners: false,
                        scale: 105
                    });
                    break;
                    
                case 'artistic':
                    Object.assign(headerSettings, {
                        borderRadius: 20,
                        shadow: 3,
                        borderWidth: 0,
                        blur: 1,
                        brightness: 110,
                        contrast: 110,
                        saturation: 120,
                        hue: 15,
                        backgroundPattern: 'diagonal',
                        gradientOverlay: true,
                        roundedCorners: true,
                        rotation: 2,
                        skew: 1
                    });
                    break;
            }
            
            // Update all UI controls
            resetHeaderSettings();
            
            // Apply the preset values to UI
            Object.keys(headerSettings).forEach(key => {
                const element = document.getElementById('header' + key.charAt(0).toUpperCase() + key.slice(1));
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = headerSettings[key];
                    } else {
                        element.value = headerSettings[key];
                    }
                }
            });
            
            // Update labels
            updateAllHeaderLabels();
            updatePreview();
            showNotification(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù…Ø· ${getPresetNameArabic(presetName)}! ğŸ¨`, 'success');
        }

        function getPresetNameArabic(presetName) {
            const names = {
                'modern': 'Ø§Ù„Ø¹ØµØ±ÙŠ',
                'classic': 'Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ',
                'elegant': 'Ø§Ù„Ø£Ù†ÙŠÙ‚',
                'minimal': 'Ø§Ù„Ø¨Ø³ÙŠØ·',
                'bold': 'Ø§Ù„Ø¬Ø±ÙŠØ¡',
                'artistic': 'Ø§Ù„ÙÙ†ÙŠ'
            };
            return names[presetName] || presetName;
        }

        function updateAllHeaderLabels() {
            // Update all labels with current values
            const labelUpdates = {
                'headerXPositionLabel': headerSettings.xPosition + 'px',
                'headerYPositionLabel': headerSettings.yPosition + 'px',
                'headerRotationLabel': headerSettings.rotation + 'Â°',
                'headerSkewLabel': headerSettings.skew + 'Â°',
                'headerWidthLabel': headerSettings.width + '%',
                'headerHeightLabel': headerSettings.height + 'px',
                'headerScaleLabel': headerSettings.scale + '%',
                'headerMarginTopLabel': headerSettings.marginTop + 'px',
                'headerMarginBottomLabel': headerSettings.marginBottom + 'px',
                'headerMarginRightLabel': headerSettings.marginRight + 'px',
                'headerMarginLeftLabel': headerSettings.marginLeft + 'px',
                'headerPaddingLabel': headerSettings.padding + 'px',
                'headerGapLabel': headerSettings.gap + 'px',
                'headerBorderRadiusLabel': headerSettings.borderRadius + 'px',
                'headerBorderWidthLabel': headerSettings.borderWidth + 'px',
                'headerOpacityLabel': headerSettings.opacity + '%',
                'headerBlurLabel': headerSettings.blur + 'px',
                'headerBrightnessLabel': headerSettings.brightness + '%',
                'headerContrastLabel': headerSettings.contrast + '%',
                'headerSaturationLabel': headerSettings.saturation + '%',
                'headerHueLabel': headerSettings.hue + 'Â°',
                'headerBgOpacityLabel': headerSettings.bgOpacity + '%'
            };
            
            Object.keys(labelUpdates).forEach(labelId => {
                const label = document.getElementById(labelId);
                if (label) {
                    label.textContent = labelUpdates[labelId];
                }
            });
            
            // Update shadow label
            const shadowLabels = ['Ø¨Ø¯ÙˆÙ†', 'Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹', 'Ø®ÙÙŠÙ', 'Ù…ØªÙˆØ³Ø·', 'Ù‚ÙˆÙŠ', 'Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹'];
            const shadowLabel = document.getElementById('headerShadowLabel');
            if (shadowLabel) {
                shadowLabel.textContent = shadowLabels[headerSettings.shadow] || 'Ø®ÙÙŠÙ';
            }
        }

        function getHeaderTemplateStyle() {
            if (!headerTemplateData || !showHeaderTemplate) return '';
            
            // Build transform string
            let transforms = [];
            if (headerSettings.xPosition !== 0) transforms.push(`translateX(${headerSettings.xPosition}px)`);
            if (headerSettings.yPosition !== 0) transforms.push(`translateY(${headerSettings.yPosition}px)`);
            if (headerSettings.rotation !== 0) transforms.push(`rotate(${headerSettings.rotation}deg)`);
            if (headerSettings.skew !== 0) transforms.push(`skewX(${headerSettings.skew}deg)`);
            if (headerSettings.scale !== 100) transforms.push(`scale(${headerSettings.scale / 100})`);
            
            // Build shadow string
            const shadowMap = {
                0: 'none',
                1: `0 2px 8px ${headerSettings.shadowColor}20`,
                2: `0 4px 12px ${headerSettings.shadowColor}30`,
                3: `0 8px 25px ${headerSettings.shadowColor}40`,
                4: `0 12px 35px ${headerSettings.shadowColor}50`,
                5: `0 16px 45px ${headerSettings.shadowColor}60`
            };
            
            // Build filters
            let filters = [];
            if (headerSettings.opacity < 100) filters.push(`opacity(${headerSettings.opacity}%)`);
            if (headerSettings.blur > 0) filters.push(`blur(${headerSettings.blur}px)`);
            if (headerSettings.brightness !== 100) filters.push(`brightness(${headerSettings.brightness}%)`);
            if (headerSettings.contrast !== 100) filters.push(`contrast(${headerSettings.contrast}%)`);
            if (headerSettings.saturation !== 100) filters.push(`saturate(${headerSettings.saturation}%)`);
            if (headerSettings.hue !== 0) filters.push(`hue-rotate(${headerSettings.hue}deg)`);
            if (headerSettings.grayscale) filters.push('grayscale(100%)');
            if (headerSettings.sepia) filters.push('sepia(100%)');
            if (headerSettings.invert) filters.push('invert(100%)');
            if (headerSettings.dropShadow) filters.push(`drop-shadow(4px 4px 8px ${headerSettings.shadowColor}40)`);
            
            // Build background
            let backgroundStyles = '';
            if (headerSettings.bgOpacity > 0) {
                const bgColorWithOpacity = headerSettings.bgColor + Math.round(headerSettings.bgOpacity * 2.55).toString(16).padStart(2, '0');
                backgroundStyles += `background-color: ${bgColorWithOpacity}; `;
            }
            
            // Build pattern overlay
            let patternOverlay = '';
            if (headerSettings.backgroundPattern !== 'none') {
                const patterns = {
                    'dots': 'radial-gradient(circle, #00000020 1px, transparent 1px)',
                    'lines': 'linear-gradient(0deg, transparent 24%, #00000020 25%, #00000020 26%, transparent 27%, transparent 74%, #00000020 75%, #00000020 76%, transparent 77%)',
                    'grid': 'linear-gradient(#00000020 1px, transparent 1px), linear-gradient(90deg, #00000020 1px, transparent 1px)',
                    'diagonal': 'linear-gradient(45deg, #00000020 25%, transparent 25%, transparent 75%, #00000020 75%)'
                };
                patternOverlay = `background-image: ${patterns[headerSettings.backgroundPattern]}; background-size: 20px 20px; `;
            }
            
            // Build gradient overlay
            let gradientOverlay = '';
            if (headerSettings.gradientOverlay) {
                gradientOverlay = 'background-image: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(147,51,234,0.1) 100%); ';
            }
            
            // Aspect ratio handling
            let aspectRatioStyle = '';
            if (headerSettings.aspectRatio !== 'auto') {
                aspectRatioStyle = `aspect-ratio: ${headerSettings.aspectRatio}; `;
            }
            
            // Alignment styles - ØªØ¹Ø¯ÙŠÙ„ Ù„ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø£Ø·Ø±Ø§Ù
            let alignmentStyles = '';
            switch (headerSettings.alignment) {
                case 'center':
                    alignmentStyles = 'margin-left: auto; margin-right: auto; ';
                    break;
                case 'right':
                    alignmentStyles = 'margin-left: 0; margin-right: 0; '; // ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙŠÙ…Ù†
                    break;
                case 'left':
                    alignmentStyles = 'margin-left: 0; margin-right: 0; '; // ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙŠØ³Ø±
                    break;
                case 'justify':
                    alignmentStyles = 'width: 100% !important; margin: 0; '; // ØªÙ…Ù„Ø£ Ø§Ù„Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø·Ø±Ø§Ù
                    break;
            }
            
            return `
                width: ${headerSettings.width}%;
                height: ${headerSettings.height}px;
                ${aspectRatioStyle}
                object-fit: ${headerSettings.displayMode};
                margin-top: ${headerSettings.marginTop}px;
                margin-bottom: ${headerSettings.marginBottom}px;
                margin-right: ${headerSettings.marginRight}px;
                margin-left: ${headerSettings.marginLeft}px;
                padding: ${headerSettings.padding}px;
                border-radius: ${headerSettings.borderRadius}px;
                ${headerSettings.borderWidth > 0 ? `border: ${headerSettings.borderWidth}px ${headerSettings.borderStyle} ${headerSettings.borderColor};` : ''}
                box-shadow: ${shadowMap[headerSettings.shadow] || shadowMap[1]};
                ${transforms.length > 0 ? `transform: ${transforms.join(' ')};` : ''}
                ${filters.length > 0 ? `filter: ${filters.join(' ')};` : ''}
                z-index: ${headerSettings.zIndex};
                display: block;
                ${alignmentStyles}
                ${backgroundStyles}
                ${patternOverlay}
                ${gradientOverlay}
                ${headerSettings.roundedCorners ? `border-radius: ${headerSettings.borderRadius * 2}px;` : ''}
                transition: all 0.3s ease;
            `;
        }

        // AI Connection Functions
        async function testAIConnection() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const testButton = document.querySelector('button[onclick="testAIConnection()"]');
            
            // Show loading state
            statusIndicator.className = 'w-3 h-3 rounded-full status-connecting ml-2';
            statusText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...';
            testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ - Ø±Ø¯ Ø¨ÙƒÙ„Ù…Ø© "Ù…ØªØµÙ„" ÙÙ‚Ø·'
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 10,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Gemini Response:', data);
                    
                    if (data.candidates && data.candidates[0]) {
                        if (data.candidates[0].content && data.candidates[0].content.parts) {
                            isAIConnected = true;
                            statusIndicator.className = 'w-3 h-3 rounded-full status-connected ml-2';
                            statusText.textContent = 'Ù…ØªØµÙ„';
                            console.log('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Gemini AI Ø¨Ù†Ø¬Ø§Ø­');
                            showNotification('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Gemini AI Ø¨Ù†Ø¬Ø§Ø­! ğŸ¤–âœ¨', 'success');
                            return;
                        } else if (data.candidates[0].finishReason === 'SAFETY') {
                            throw new Error('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©');
                        }
                    }
                    
                    if (data.error) {
                        throw new Error(data.error.message || 'Ø®Ø·Ø£ Ù…Ù† API');
                    }
                }
                
                const errorData = await response.json().catch(() => ({}));
                if (errorData.error) {
                    if (errorData.error.code === 400) {
                        throw new Error('Ù…ÙØªØ§Ø­ API ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
                    } else if (errorData.error.code === 429) {
                        throw new Error('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹');
                    } else {
                        throw new Error(errorData.error.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                    }
                }
                
                throw new Error(`HTTP ${response.status}: ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API`);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Gemini AI:', error);
                isAIConnected = false;
                statusIndicator.className = 'w-3 h-3 rounded-full status-disconnected ml-2';
                statusText.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
                showNotification(`ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`, 'error');
            } finally {
                testButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
            }
        }

        // Gemini AI Generation
        async function generateGeminiAI() {
            const topic = document.getElementById('aiTopic').value.trim();
            const count = parseInt(document.getElementById('aiQuestionCount').value) || 5;
            const difficulty = document.getElementById('difficultyLevel').value;
            
            if (!topic) {
                showAIError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
                return;
            }

            const button = document.querySelector('button[onclick="generateGeminiAI()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...';
            button.disabled = true;

            try {
                const questionTypes = [];
                if (document.getElementById('aiMcq').checked) questionTypes.push('Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯');
                if (document.getElementById('aiTrueFalse').checked) questionTypes.push('ØµØ­ Ø£Ù… Ø®Ø·Ø£');
                if (document.getElementById('aiShort').checked) questionTypes.push('Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©');
                if (document.getElementById('aiFill').checked) questionTypes.push('Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº');

                if (questionTypes.length === 0) {
                    showAIError('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
                    return;
                }

                const difficultyText = {
                    'easy': 'Ø³Ù‡Ù„',
                    'medium': 'Ù…ØªÙˆØ³Ø·',
                    'hard': 'ØµØ¹Ø¨'
                }[difficulty];

                const prompt = `Ø£Ù†Ø´Ø¦ ${count} Ø£Ø³Ø¦Ù„Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø­ÙˆÙ„ Ù…ÙˆØ¶ÙˆØ¹ "${topic}" Ø¨Ù…Ø³ØªÙˆÙ‰ ØµØ¹ÙˆØ¨Ø© ${difficultyText}.

Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${questionTypes.join('ØŒ ')}

ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø§Ù„Ø¶Ø¨Ø·:

[Ø§Ù„Ø³Ø¤Ø§Ù„ 1]
Ø§Ù„Ù†ÙˆØ¹: Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯
Ø§Ù„Ù†Øµ: [Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„]
Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª: Ø£) [Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„] | Ø¨) [Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ] | Ø¬) [Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«] | Ø¯) [Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹]
Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: Ø£
Ø§Ù„Ø¯Ø±Ø¬Ø©: 5
Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ${topic}
Ø§Ù„Ù‡Ø¯Ù: [Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ]
Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­: 3

ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…ÙÙ‡ÙˆÙ…Ø© ÙˆØµØ­ÙŠØ­Ø© Ø¹Ù„Ù…ÙŠØ§Ù‹ ÙˆØ¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰.`;

                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 4096,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.error) {
                        if (errorData.error.code === 400) {
                            throw new Error('Ù…ÙØªØ§Ø­ API ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
                        } else if (errorData.error.code === 429) {
                            throw new Error('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹');
                        } else {
                            throw new Error(errorData.error.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                        }
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Gemini Full Response:', data);
                
                if (!data.candidates || !data.candidates[0]) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ');
                }

                const candidate = data.candidates[0];
                
                if (candidate.finishReason === 'SAFETY') {
                    throw new Error('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©. Ø¬Ø±Ø¨ Ù…ÙˆØ¶ÙˆØ¹Ø§Ù‹ Ø¢Ø®Ø±');
                }
                
                if (!candidate.content || !candidate.content.parts || !candidate.content.parts[0]) {
                    throw new Error('Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­');
                }

                const aiText = candidate.content.parts[0].text;
                console.log('Gemini Response Text:', aiText);
                
                const generatedQuestions = parseAIResponseText(aiText);
                
                if (generatedQuestions.length === 0) {
                    showAIError('Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø© ØµØ§Ù„Ø­Ø©. Ø¬Ø±Ø¨ Ù…ÙˆØ¶ÙˆØ¹Ø§Ù‹ Ù…Ø®ØªÙ„ÙØ§Ù‹ Ø£Ùˆ Ù‚Ù„Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
                    return;
                }

                questions.push(...generatedQuestions);
                
                updateQuestionsList();
                updatePreview();
                showAISuccess(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${generatedQuestions.length} Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­! ğŸ¯âœ¨`);
                
                // Clear form
                document.getElementById('aiTopic').value = '';
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:', error);
                showAIError(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${error.message}`);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }





        // Tab switching with error handling
        function switchTab(tabName) {
            try {
                console.log('ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø¥Ù„Ù‰:', tabName);
                
                const tabs = ['basic', 'questions', 'format', 'ai'];
                tabs.forEach(tab => {
                    const tabElement = document.getElementById(tab + '-tab');
                    const buttonElement = document.getElementById('tab-' + tab);
                    if (tabElement) tabElement.classList.add('hidden');
                    if (buttonElement) buttonElement.classList.remove('tab-active');
                });
                
                const selectedTab = document.getElementById(tabName + '-tab');
                const selectedButton = document.getElementById('tab-' + tabName);
                if (selectedTab) selectedTab.classList.remove('hidden');
                if (selectedButton) selectedButton.classList.add('tab-active');
                
                console.log('ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨:', error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨', 'error');
            }
        }

        // Toggle question options based on type
        function toggleQuestionOptions() {
            const questionType = document.getElementById('questionType').value;
            console.log('Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯:', questionType);
            
            const containers = ['mcqOptions', 'trueFalseOptions', 'fillOptions'];
            containers.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
            
            switch(questionType) {
                case 'mcq':
                    document.getElementById('mcqOptions').classList.remove('hidden');
                    break;
                case 'true-false':
                    document.getElementById('trueFalseOptions').classList.remove('hidden');
                    break;
                case 'fill':
                    document.getElementById('fillOptions').classList.remove('hidden');
                    break;
            }
        }

        // Add question function with enhanced details and error handling
        function addQuestion() {
            try {
                const questionText = document.getElementById('questionText')?.value?.trim();
                const questionType = document.getElementById('questionType')?.value;
                const questionMarks = parseInt(document.getElementById('questionMarks')?.value) || 5;
                const questionDifficulty = document.getElementById('questionDifficulty')?.value || 'medium';
                const questionTopic = document.getElementById('questionTopic')?.value?.trim() || '';
                const questionObjective = document.getElementById('questionObjective')?.value?.trim() || '';
                const questionTime = parseInt(document.getElementById('questionTime')?.value) || 5;
                
                if (!questionText) {
                    showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„', 'error');
                    return;
                }
                
                const question = {
                    id: Date.now(),
                    text: questionText,
                    type: questionType,
                    marks: questionMarks,
                    difficulty: questionDifficulty,
                    topic: questionTopic,
                    objective: questionObjective,
                    estimatedTime: questionTime,
                    options: [],
                    correctAnswer: null,
                    acceptedAnswers: []
                };
                
                if (questionType === 'mcq') {
                    const options = [];
                    const correctAnswerRadio = document.querySelector('input[name="correctMCQ"]:checked');
                    
                    for (let i = 1; i <= 4; i++) {
                        const optionElement = document.getElementById(`option${i}`);
                        if (optionElement && optionElement.value.trim()) {
                            options.push(optionElement.value.trim());
                        }
                    }
                    
                    if (options.length < 2) {
                        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø®ÙŠØ§Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                        return;
                    }
                    
                    if (!correctAnswerRadio) {
                        showNotification('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©', 'error');
                        return;
                    }
                    
                    question.options = options;
                    question.correctAnswer = parseInt(correctAnswerRadio.value);
                    
                } else if (questionType === 'true-false') {
                    const correctAnswerRadio = document.querySelector('input[name="trueFalseAnswer"]:checked');
                    question.options = ['ØµØ­', 'Ø®Ø·Ø£'];
                    question.correctAnswer = correctAnswerRadio ? (correctAnswerRadio.value === 'true' ? 1 : 2) : 1;
                    
                } else if (questionType === 'fill') {
                    const fillAnswersElement = document.getElementById('fillAnswers');
                    const fillAnswers = fillAnswersElement ? fillAnswersElement.value.trim() : '';
                    question.acceptedAnswers = fillAnswers ? fillAnswers.split('ØŒ').map(ans => ans.trim()).filter(ans => ans) : [];
                }
                
                questions.push(question);
                console.log('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„:', question);
                
                updateQuestionsList();
                safeUpdatePreview();
                clearQuestionForm();
                
                showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                // Scroll to the new question
                setTimeout(() => {
                    try {
                        const questionsList = document.getElementById('questionsList');
                        if (questionsList) {
                            questionsList.scrollTop = questionsList.scrollHeight;
                        }
                    } catch (scrollError) {
                        console.warn('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ…Ø±ÙŠØ±:', scrollError);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„', 'error');
            }
        }

        // Enhanced notification system with error handling
        function showNotification(message, type = 'info') {
            try {
                // Remove existing notifications
                const existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(n => {
                    try {
                        n.remove();
                    } catch (e) {
                        console.warn('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', e);
                    }
                });
                
                const notification = document.createElement('div');
                notification.className = `notification fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300`;
                
                const colors = {
                    'success': 'bg-green-500 text-white',
                    'error': 'bg-red-500 text-white',
                    'warning': 'bg-yellow-500 text-white',
                    'info': 'bg-blue-500 text-white'
                };
                
                const icons = {
                    'success': 'fas fa-check-circle',
                    'error': 'fas fa-exclamation-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'info': 'fas fa-info-circle'
                };
                
                notification.className += ` ${colors[type] || colors.info}`;
                notification.innerHTML = `
                    <div class="flex items-center">
                        <i class="${icons[type] || icons.info} ml-2"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    try {
                        notification.style.transform = 'translateX(-50%) translateY(0)';
                        notification.style.opacity = '1';
                    } catch (e) {
                        console.warn('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', e);
                    }
                }, 10);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    try {
                        notification.style.transform = 'translateX(-50%) translateY(-100%)';
                        notification.style.opacity = '0';
                        setTimeout(() => {
                            try {
                                if (notification.parentNode) {
                                    notification.remove();
                                }
                            } catch (e) {
                                console.warn('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ£Ø®Ø±:', e);
                            }
                        }, 300);
                    } catch (e) {
                        console.warn('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', e);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', error);
                // Fallback to alert
                alert(message);
            }
        }

        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø§Ù„ØµÙØ­Ø©:', event.error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©', 'error');
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Promise:', event.reason);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'warning');
        });

        // Clear question form
        function clearQuestionForm() {
            document.getElementById('questionText').value = '';
            document.getElementById('questionMarks').value = '5';
            document.getElementById('questionTopic').value = '';
            document.getElementById('questionObjective').value = '';
            document.getElementById('questionTime').value = '';
            
            for (let i = 1; i <= 4; i++) {
                const optionElement = document.getElementById(`option${i}`);
                if (optionElement) optionElement.value = '';
            }
            
            const radioButtons = document.querySelectorAll('input[name="correctMCQ"]');
            radioButtons.forEach(radio => radio.checked = false);
            
            const trueFalseRadios = document.querySelectorAll('input[name="trueFalseAnswer"]');
            trueFalseRadios.forEach(radio => radio.checked = false);
            
            const fillAnswers = document.getElementById('fillAnswers');
            if (fillAnswers) fillAnswers.value = '';
        }

        // Delete question
        function deleteQuestion(questionId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) {
                questions = questions.filter(q => q.id !== questionId);
                updateQuestionsList();
                updatePreview();
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            }
        }

        // Update questions list with enhanced details and drag-drop
        function updateQuestionsList() {
            const questionsList = document.getElementById('questionsList');
            const questionCount = document.getElementById('questionCount');
            
            questionCount.textContent = `${questions.length} Ø³Ø¤Ø§Ù„`;
            
            if (questions.length === 0) {
                questionsList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-question-circle text-4xl mb-3 opacity-50"></i>
                        <p>Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯</p>
                        <p class="text-sm">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø©</p>
                    </div>
                `;
                return;
            }
            
            questionsList.innerHTML = questions.map((question, index) => `
                <div class="question-item draggable" draggable="true" data-question-id="${question.id}" data-index="${index}">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center ml-2">
                            <i class="fas fa-grip-vertical text-gray-400 cursor-move drag-handle" title="Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center mb-2 flex-wrap gap-2">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">
                                    ${getQuestionTypeText(question.type)}
                                </span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium editable-marks" 
                                      onclick="editMarks(${question.id}, ${question.marks})" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„">
                                    ${question.marks} Ø¯Ø±Ø¬Ø©
                                </span>
                                <button onclick="toggleQuestionMarks(${question.id})" 
                                        class="px-2 py-1 rounded text-xs font-medium ${question.hideMarks ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}" 
                                        title="${question.hideMarks ? 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø±Ø¬Ø©' : 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø±Ø¬Ø©'}">
                                    ${question.hideMarks ? 'Ù…Ø®ÙÙŠØ©' : 'Ø¸Ø§Ù‡Ø±Ø©'}
                                </button>
                                <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-medium">
                                    #${index + 1}
                                </span>
                                ${question.difficulty ? `
                                    <span class="bg-${getDifficultyColor(question.difficulty)}-100 text-${getDifficultyColor(question.difficulty)}-800 px-2 py-1 rounded text-xs font-medium">
                                        ${getDifficultyText(question.difficulty)}
                                    </span>
                                ` : ''}
                                ${question.estimatedTime ? `
                                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-medium">
                                        ${question.estimatedTime} Ø¯
                                    </span>
                                ` : ''}
                            </div>
                            <p class="text-gray-800 font-medium mb-2 editable-text cursor-pointer hover:bg-gray-50 p-1 rounded" 
                               onclick="editQuestionText(${question.id})" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„">${question.text}</p>
                            ${question.topic ? `<p class="text-sm text-gray-600 mb-1"><strong>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</strong> <span class="editable-text cursor-pointer hover:bg-gray-50 p-1 rounded" onclick="editQuestionTopic(${question.id})" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„">${question.topic}</span></p>` : ''}
                            ${question.objective ? `<p class="text-sm text-gray-600 mb-2"><strong>Ø§Ù„Ù‡Ø¯Ù:</strong> <span class="editable-text cursor-pointer hover:bg-gray-50 p-1 rounded" onclick="editQuestionObjective(${question.id})" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„">${question.objective}</span></p>` : ''}
                            ${question.options.length > 0 ? `
                                <div class="text-sm text-gray-600">
                                    ${question.options.map((option, i) => `
                                        <div class="flex items-center mb-1">
                                            <span class="w-6 h-6 border-2 border-gray-400 rounded-full flex items-center justify-center text-xs font-bold ml-2">${String.fromCharCode(65 + i)}</span>
                                            <span class="editable-text cursor-pointer hover:bg-gray-50 p-1 rounded flex-1" 
                                                  onclick="editOption(${question.id}, ${i})" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„">${option}</span>
                                            ${question.correctAnswer === (i + 1) ? '<i class="fas fa-check text-green-600 mr-2"></i>' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex flex-col space-y-1">
                            <button onclick="editQuestion(${question.id})" class="text-blue-600 hover:text-blue-800 p-1" title="ØªØ¹Ø¯ÙŠÙ„">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="duplicateQuestion(${question.id})" class="text-green-600 hover:text-green-800 p-1" title="Ù†Ø³Ø®">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="deleteQuestion(${question.id})" class="text-red-600 hover:text-red-800 p-1" title="Ø­Ø°Ù">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Initialize drag and drop
            initializeDragAndDrop();
        }

        // Initialize drag and drop functionality
        function initializeDragAndDrop() {
            const draggableItems = document.querySelectorAll('.draggable');
            
            draggableItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const draggedIndex = parseInt(draggedElement.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // Reorder questions array
                const draggedQuestion = questions[draggedIndex];
                questions.splice(draggedIndex, 1);
                questions.splice(targetIndex, 0, draggedQuestion);
                
                updateQuestionsList();
                updatePreview();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            draggedElement = null;
        }

        // Edit functions
        function editMarks(questionId, currentMarks) {
            const newMarks = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', currentMarks);
            if (newMarks !== null && !isNaN(newMarks) && newMarks > 0) {
                const question = questions.find(q => q.id === questionId);
                if (question) {
                    question.marks = parseInt(newMarks);
                    updateQuestionsList();
                    updatePreview();
                    showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø¬Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                }
            }
        }

        // Toggle marks visibility for individual questions
        function toggleQuestionMarks(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                question.hideMarks = !question.hideMarks;
                updateQuestionsList();
                updatePreview();
                const status = question.hideMarks ? 'Ù…Ø®ÙÙŠØ©' : 'Ø¸Ø§Ù‡Ø±Ø©';
                showNotification(`Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¢Ù† ${status} Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„`, 'info');
            }
        }

        // Bulk edit marks
        function bulkEditMarks() {
            const selectedType = prompt('Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø§ØªÙ‡Ø§:\n1 - Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯\n2 - ØµØ­ Ø£Ù… Ø®Ø·Ø£\n3 - Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©\n4 - Ù…Ù‚Ø§Ù„ÙŠ\n5 - Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº\n6 - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', '6');
            
            if (!selectedType) return;
            
            const typeMap = {
                '1': 'mcq',
                '2': 'true-false', 
                '3': 'short',
                '4': 'essay',
                '5': 'fill',
                '6': 'all'
            };
            
            const targetType = typeMap[selectedType];
            if (!targetType) return;
            
            const newMarks = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', '5');
            if (newMarks === null || isNaN(newMarks) || newMarks <= 0) return;
            
            let updatedCount = 0;
            questions.forEach(question => {
                if (targetType === 'all' || question.type === targetType) {
                    question.marks = parseInt(newMarks);
                    updatedCount++;
                }
            });
            
            updateQuestionsList();
            updatePreview();
            showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¯Ø±Ø¬Ø§Øª ${updatedCount} Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
        }

        function editQuestionText(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                const newText = prompt('Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', question.text);
                if (newText !== null && newText.trim()) {
                    question.text = newText.trim();
                    updateQuestionsList();
                    updatePreview();
                }
            }
        }

        function editQuestionTopic(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                const newTopic = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', question.topic || '');
                if (newTopic !== null) {
                    question.topic = newTopic.trim();
                    updateQuestionsList();
                    updatePreview();
                }
            }
        }

        function editQuestionObjective(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                const newObjective = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', question.objective || '');
                if (newObjective !== null) {
                    question.objective = newObjective.trim();
                    updateQuestionsList();
                    updatePreview();
                }
            }
        }

        function editOption(questionId, optionIndex) {
            const question = questions.find(q => q.id === questionId);
            if (question && question.options[optionIndex]) {
                const newOption = prompt('Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯:', question.options[optionIndex]);
                if (newOption !== null && newOption.trim()) {
                    question.options[optionIndex] = newOption.trim();
                    updateQuestionsList();
                    updatePreview();
                }
            }
        }

        function editQuestion(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                // Switch to questions tab and populate form
                switchTab('questions');
                
                // Populate form with question data
                document.getElementById('questionText').value = question.text;
                document.getElementById('questionType').value = question.type;
                document.getElementById('questionMarks').value = question.marks;
                document.getElementById('questionDifficulty').value = question.difficulty || 'medium';
                document.getElementById('questionTopic').value = question.topic || '';
                document.getElementById('questionObjective').value = question.objective || '';
                document.getElementById('questionTime').value = question.estimatedTime || 5;
                
                // Handle options based on question type
                if (question.type === 'mcq') {
                    for (let i = 0; i < 4; i++) {
                        const optionElement = document.getElementById(`option${i + 1}`);
                        if (optionElement) {
                            optionElement.value = question.options[i] || '';
                        }
                    }
                    
                    // Set correct answer
                    if (question.correctAnswer) {
                        const correctRadio = document.querySelector(`input[name="correctMCQ"][value="${question.correctAnswer}"]`);
                        if (correctRadio) correctRadio.checked = true;
                    }
                } else if (question.type === 'true-false') {
                    const correctValue = question.correctAnswer === 1 ? 'true' : 'false';
                    const correctRadio = document.querySelector(`input[name="trueFalseAnswer"][value="${correctValue}"]`);
                    if (correctRadio) correctRadio.checked = true;
                } else if (question.type === 'fill') {
                    const fillAnswers = document.getElementById('fillAnswers');
                    if (fillAnswers) fillAnswers.value = question.acceptedAnswers.join('ØŒ ');
                }
                
                toggleQuestionOptions();
                
                // Remove the question from array (will be re-added when form is submitted)
                questions = questions.filter(q => q.id !== questionId);
                updateQuestionsList();
                updatePreview();
                
                alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„. Ù‚Ù… Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø«Ù… Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„"');
            }
        }

        function duplicateQuestion(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                const duplicatedQuestion = {
                    ...question,
                    id: Date.now(),
                    text: question.text + ' (Ù†Ø³Ø®Ø©)'
                };
                questions.push(duplicatedQuestion);
                updateQuestionsList();
                updatePreview();
                alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            }
        }

        // Helper functions for question details
        function getQuestionTypeText(type) {
            const types = {
                'mcq': 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯',
                'true-false': 'ØµØ­ Ø£Ù… Ø®Ø·Ø£',
                'short': 'Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©',
                'essay': 'Ù…Ù‚Ø§Ù„ÙŠ',
                'fill': 'Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº'
            };
            return types[type] || type;
        }

        // Format date based on selected format
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const dateFormat = document.getElementById('dateFormat')?.value || 'arabic';
            
            switch (dateFormat) {
                case 'arabic':
                    return formatArabicDate(date);
                case 'hijri':
                    return formatHijriDate(date);
                case 'gregorian':
                    return date.toLocaleDateString('ar-SA');
                case 'both':
                    return `${date.toLocaleDateString('ar-SA')} - ${formatHijriDate(date)}`;
                case 'text':
                    return formatTextDate(date);
                default:
                    return date.toLocaleDateString('ar-SA');
            }
        }

        function formatArabicDate(date) {
            const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 
                           'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
            const arabicNumerals = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            
            const day = date.getDate().toString().replace(/\d/g, d => arabicNumerals[d]);
            const month = months[date.getMonth()];
            const year = date.getFullYear().toString().replace(/\d/g, d => arabicNumerals[d]);
            
            return `${day} ${month} ${year}`;
        }

        function formatHijriDate(date) {
            // Simplified Hijri conversion (approximate)
            const hijriYear = Math.floor((date.getFullYear() - 622) * 1.030684) + 1;
            const hijriMonth = Math.floor(Math.random() * 12) + 1; // Simplified
            const hijriDay = date.getDate();
            
            return `${hijriDay.toString().padStart(2, '0')}/${hijriMonth.toString().padStart(2, '0')}/${hijriYear}`;
        }

        function formatTextDate(date) {
            const days = ['Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„Ø±Ø§Ø¨Ø¹', 'Ø§Ù„Ø®Ø§Ù…Ø³', 'Ø§Ù„Ø³Ø§Ø¯Ø³', 'Ø§Ù„Ø³Ø§Ø¨Ø¹', 'Ø§Ù„Ø«Ø§Ù…Ù†', 'Ø§Ù„ØªØ§Ø³Ø¹', 'Ø§Ù„Ø¹Ø§Ø´Ø±',
                         'Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±', 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±', 'Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ø´Ø±', 'Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ø´Ø±', 'Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø±', 'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø¹Ø´Ø±', 'Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø¹Ø´Ø±', 'Ø§Ù„Ø«Ø§Ù…Ù† Ø¹Ø´Ø±', 'Ø§Ù„ØªØ§Ø³Ø¹ Ø¹Ø´Ø±', 'Ø§Ù„Ø¹Ø´Ø±ÙˆÙ†',
                         'Ø§Ù„Ø­Ø§Ø¯ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†', 'Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†', 'Ø§Ù„Ø«Ø§Ù„Ø« ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†', 'Ø§Ù„Ø±Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†', 'Ø§Ù„Ø®Ø§Ù…Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†', 'Ø§Ù„Ø³Ø§Ø¯Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†', 'Ø§Ù„Ø³Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†', 'Ø§Ù„Ø«Ø§Ù…Ù† ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†', 'Ø§Ù„ØªØ§Ø³Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†', 'Ø§Ù„Ø­Ø§Ø¯ÙŠ ÙˆØ§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†'];
            const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 
                           'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
            
            const day = days[date.getDate() - 1];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            
            return `${day} Ù…Ù† ${month} ${year}`;
        }

        // Get section style classes
        function getSectionStyleClasses(style, bgColor, borderColor) {
            switch (style) {
                case 'modern':
                    return `background-color: ${bgColor}; border-right: 4px solid ${borderColor}; padding: 12px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);`;
                case 'classic':
                    return `background-color: ${bgColor}; border: 2px solid ${borderColor}; padding: 10px 15px; border-radius: 0;`;
                case 'minimal':
                    return `background-color: transparent; border-bottom: 2px solid ${borderColor}; padding: 8px 0; border-radius: 0;`;
                case 'bold':
                    return `background-color: ${borderColor}; color: white; padding: 12px 20px; border-radius: 6px; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.15);`;
                default:
                    return `background-color: ${bgColor}; border-right: 4px solid ${borderColor}; padding: 12px 20px;`;
            }
        }

        function getDifficultyColor(difficulty) {
            const colors = {
                'easy': 'green',
                'medium': 'yellow',
                'hard': 'red'
            };
            return colors[difficulty] || 'gray';
        }

        function getDifficultyText(difficulty) {
            const texts = {
                'easy': 'Ø³Ù‡Ù„',
                'medium': 'Ù…ØªÙˆØ³Ø·',
                'hard': 'ØµØ¹Ø¨'
            };
            return texts[difficulty] || difficulty;
        }

        function getSubjectText(subject) {
            const subjects = {
                'math': 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª',
                'arabic': 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                'english': 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
                'science': 'Ø§Ù„Ø¹Ù„ÙˆÙ…',
                'history': 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
                'physics': 'Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡',
                'chemistry': 'Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡'
            };
            return subjects[subject] || subject || 'Ø§Ù„Ù…Ø§Ø¯Ø©';
        }

        function getGradeText(grade) {
            const grades = {
                '1': 'Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
                '2': 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
                '3': 'Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
                '4': 'Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
                '5': 'Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
                '6': 'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
                '7': 'Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ',
                '8': 'Ø§Ù„Ø«Ø§Ù…Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ',
                '9': 'Ø§Ù„ØªØ§Ø³Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ',
                '10': 'Ø§Ù„Ø¹Ø§Ø´Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ',
                '11': 'Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ',
                '12': 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ (Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠ)',
                'university-1': 'Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰',
                'university-2': 'Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©',
                'university-3': 'Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ø«Ø§Ù„Ø«Ø©',
                'university-4': 'Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©',
                'master': 'Ø§Ù„Ù…Ø§Ø¬Ø³ØªÙŠØ±',
                'phd': 'Ø§Ù„Ø¯ÙƒØªÙˆØ±Ø§Ù‡'
            };
            return grades[grade] || grade || 'Ø§Ù„ØµÙ';
        }

        // Font size and spacing controls
        function updateHeaderFontSize() {
            const fontSize = document.getElementById('headerFontSize').value;
            const labels = {16: 'ØµØºÙŠØ±', 20: 'Ù…ØªÙˆØ³Ø·', 24: 'ÙƒØ¨ÙŠØ±', 28: 'ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹'};
            document.getElementById('headerFontSizeLabel').textContent = labels[fontSize] || 'ÙƒØ¨ÙŠØ±';
            updatePreview();
        }

        function updateQuestionFontSize() {
            const fontSize = document.getElementById('questionFontSize').value;
            const labels = {14: 'ØµØºÙŠØ±', 16: 'Ù…ØªÙˆØ³Ø·', 18: 'ÙƒØ¨ÙŠØ±', 20: 'ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹', 22: 'Ø¶Ø®Ù…'};
            document.getElementById('questionFontSizeLabel').textContent = labels[fontSize] || 'Ù…ØªÙˆØ³Ø·';
            updatePreview();
        }

        function updateOptionFontSize() {
            const fontSize = document.getElementById('optionFontSize').value;
            const labels = {12: 'ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹', 14: 'ØµØºÙŠØ±', 16: 'Ù…ØªÙˆØ³Ø·', 18: 'ÙƒØ¨ÙŠØ±', 20: 'ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹'};
            document.getElementById('optionFontSizeLabel').textContent = labels[fontSize] || 'Ù…ØªÙˆØ³Ø·';
            updatePreview();
        }

        function updateEssayLines() {
            const lines = document.getElementById('essayLines').value;
            document.getElementById('essayLinesLabel').textContent = lines + ' Ø®Ø·ÙˆØ·';
            updatePreview();
        }

        function updateSectionFontSize() {
            const fontSize = document.getElementById('sectionFontSize').value;
            const labels = {14: 'ØµØºÙŠØ±', 16: 'Ù…ØªÙˆØ³Ø·', 18: 'ÙƒØ¨ÙŠØ±', 20: 'ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹', 22: 'Ø¶Ø®Ù…', 24: 'Ø¶Ø®Ù… Ø¬Ø¯Ø§Ù‹'};
            document.getElementById('sectionFontSizeLabel').textContent = labels[fontSize] || 'Ù…ØªÙˆØ³Ø·';
            updatePreview();
        }

        function updateLogoSize() {
            const size = document.getElementById('logoSize').value;
            const labels = {40: 'ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹', 60: 'ØµØºÙŠØ±', 80: 'Ù…ØªÙˆØ³Ø·', 100: 'ÙƒØ¨ÙŠØ±', 120: 'ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹'};
            document.getElementById('logoSizeLabel').textContent = labels[size] || 'Ù…ØªÙˆØ³Ø·';
            updatePreview();
        }



        function parseAIResponseText(aiResponse) {
            const questions = [];
            const questionBlocks = aiResponse.split(/\[Ø§Ù„Ø³Ø¤Ø§Ù„ \d+\]/).filter(block => block.trim());
            
            questionBlocks.forEach((block, index) => {
                try {
                    const lines = block.trim().split('\n').filter(line => line.trim());
                    const question = {
                        id: Date.now() + index,
                        options: [],
                        correctAnswer: null,
                        acceptedAnswers: [],
                        difficulty: 'medium',
                        topic: '',
                        objective: '',
                        estimatedTime: 5
                    };
                    
                    lines.forEach(line => {
                        const trimmedLine = line.trim();
                        
                        if (trimmedLine.startsWith('Ø§Ù„Ù†ÙˆØ¹:')) {
                            const type = trimmedLine.replace('Ø§Ù„Ù†ÙˆØ¹:', '').trim();
                            if (type.includes('Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯')) question.type = 'mcq';
                            else if (type.includes('ØµØ­ Ø£Ù… Ø®Ø·Ø£')) question.type = 'true-false';
                            else if (type.includes('Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©')) question.type = 'short';
                            else if (type.includes('Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº')) question.type = 'fill';
                            else if (type.includes('Ù…Ù‚Ø§Ù„ÙŠ')) question.type = 'essay';
                            else question.type = 'short';
                        }
                        else if (trimmedLine.startsWith('Ø§Ù„Ù†Øµ:')) {
                            question.text = trimmedLine.replace('Ø§Ù„Ù†Øµ:', '').trim();
                        }
                        else if (trimmedLine.startsWith('Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:')) {
                            const optionsText = trimmedLine.replace('Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:', '').trim();
                            const options = optionsText.split('|').map(opt => 
                                opt.trim().replace(/^[Ø£-Ø¯]\)\s*/, '')
                            );
                            question.options = options;
                        }
                        else if (trimmedLine.startsWith('Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:')) {
                            const answer = trimmedLine.replace('Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:', '').trim();
                            if (question.type === 'mcq') {
                                const letterMap = {'Ø£': 1, 'Ø¨': 2, 'Ø¬': 3, 'Ø¯': 4};
                                question.correctAnswer = letterMap[answer] || 1;
                            } else if (question.type === 'true-false') {
                                question.options = ['ØµØ­', 'Ø®Ø·Ø£'];
                                question.correctAnswer = answer === 'ØµØ­' ? 1 : 2;
                            }
                        }
                        else if (trimmedLine.startsWith('Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©:')) {
                            const answers = trimmedLine.replace('Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©:', '').trim();
                            question.acceptedAnswers = answers.split('ØŒ').map(ans => ans.trim()).filter(ans => ans);
                        }
                        else if (trimmedLine.startsWith('Ø§Ù„Ø¯Ø±Ø¬Ø©:')) {
                            question.marks = parseInt(trimmedLine.replace('Ø§Ù„Ø¯Ø±Ø¬Ø©:', '').trim()) || 5;
                        }
                        else if (trimmedLine.startsWith('Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:')) {
                            question.topic = trimmedLine.replace('Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:', '').trim();
                        }
                        else if (trimmedLine.startsWith('Ø§Ù„Ù‡Ø¯Ù:')) {
                            question.objective = trimmedLine.replace('Ø§Ù„Ù‡Ø¯Ù:', '').trim();
                        }
                        else if (trimmedLine.startsWith('Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­:')) {
                            question.estimatedTime = parseInt(trimmedLine.replace('Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­:', '').trim()) || 5;
                        }
                    });
                    
                    if (question.text && question.type) {
                        questions.push(question);
                    }
                } catch (error) {
                    console.error('Error parsing question block:', error);
                }
            });
            
            return questions;
        }

        function showAISuccess(message) {
            document.getElementById('aiError').classList.add('hidden');
            document.getElementById('aiSuccess').classList.remove('hidden');
            document.getElementById('aiSuccessMessage').textContent = message;
            
            setTimeout(() => {
                document.getElementById('aiSuccess').classList.add('hidden');
            }, 5000);
        }

        function showAIError(message) {
            document.getElementById('aiSuccess').classList.add('hidden');
            document.getElementById('aiError').classList.remove('hidden');
            document.getElementById('aiErrorMessage').textContent = message;
            
            setTimeout(() => {
                document.getElementById('aiError').classList.add('hidden');
            }, 5000);
        }

        // External AI Functions
        function generateExternalPrompt() {
            const topic = document.getElementById('externalTopic').value.trim();
            const count = document.getElementById('externalCount').value || '5';
            const difficulty = document.getElementById('externalDifficulty').value;
            const grade = document.getElementById('externalGrade').value;
            
            if (!topic) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'error');
                return;
            }
            
            // Get selected question types
            const questionTypes = [];
            if (document.getElementById('externalMcq').checked) questionTypes.push('Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯');
            if (document.getElementById('externalTrueFalse').checked) questionTypes.push('ØµØ­ Ø£Ù… Ø®Ø·Ø£');
            if (document.getElementById('externalShort').checked) questionTypes.push('Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©');
            if (document.getElementById('externalFill').checked) questionTypes.push('Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº');
            
            if (questionTypes.length === 0) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'error');
                return;
            }
            
            const difficultyText = {
                'easy': 'Ø³Ù‡Ù„',
                'medium': 'Ù…ØªÙˆØ³Ø·', 
                'hard': 'ØµØ¹Ø¨'
            }[difficulty];
            
            const gradeText = grade ? ` Ù„Ù„ØµÙ ${getGradeText(grade)}` : '';
            
            // Generate comprehensive prompt
            const prompt = `Ø£Ù†Ø´Ø¦ ${count} Ø£Ø³Ø¦Ù„Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø­ÙˆÙ„ Ù…ÙˆØ¶ÙˆØ¹ "${topic}"${gradeText} Ø¨Ù…Ø³ØªÙˆÙ‰ ØµØ¹ÙˆØ¨Ø© ${difficultyText}.

Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${questionTypes.join('ØŒ ')}

ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø§Ù„Ø¶Ø¨Ø·:

[Ø§Ù„Ø³Ø¤Ø§Ù„ 1]
Ø§Ù„Ù†ÙˆØ¹: Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯
Ø§Ù„Ù†Øµ: [Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„]
Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª: Ø£) [Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„] | Ø¨) [Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ] | Ø¬) [Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«] | Ø¯) [Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹]
Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: Ø£
Ø§Ù„Ø¯Ø±Ø¬Ø©: 5
Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ${topic}
Ø§Ù„Ù‡Ø¯Ù: [Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ]
Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­: 3

[Ø§Ù„Ø³Ø¤Ø§Ù„ 2]
Ø§Ù„Ù†ÙˆØ¹: ØµØ­ Ø£Ù… Ø®Ø·Ø£
Ø§Ù„Ù†Øµ: [Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„]
Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ØµØ­
Ø§Ù„Ø¯Ø±Ø¬Ø©: 3
Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ${topic}
Ø§Ù„Ù‡Ø¯Ù: [Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ]
Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­: 2

[Ø§Ù„Ø³Ø¤Ø§Ù„ 3]
Ø§Ù„Ù†ÙˆØ¹: Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©
Ø§Ù„Ù†Øµ: [Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„]
Ø§Ù„Ø¯Ø±Ø¬Ø©: 4
Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ${topic}
Ø§Ù„Ù‡Ø¯Ù: [Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ]
Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­: 5

[Ø§Ù„Ø³Ø¤Ø§Ù„ 4]
Ø§Ù„Ù†ÙˆØ¹: Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº
Ø§Ù„Ù†Øµ: [Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ø¹ _____ Ù„Ù„ÙØ±Ø§ØºØ§Øª]
Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©: [Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©]
Ø§Ù„Ø¯Ø±Ø¬Ø©: 3
Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ${topic}
Ø§Ù„Ù‡Ø¯Ù: [Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ]
Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­: 3

Ù…ØªØ·Ù„Ø¨Ø§Øª Ù…Ù‡Ù…Ø©:
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰
- ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…ÙÙ‡ÙˆÙ…Ø©
- Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØµØ­ÙŠØ­Ø© Ø¹Ù„Ù…ÙŠØ§Ù‹ ÙˆÙ…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù…Ø³ØªÙˆÙ‰
- ÙÙŠ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ØŒ Ø§Ø¬Ø¹Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¹Ù‚ÙˆÙ„Ø©
- ÙÙŠ Ø£Ø³Ø¦Ù„Ø© ØµØ­ Ø£Ù… Ø®Ø·Ø£ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
- ÙÙŠ Ø£Ø³Ø¦Ù„Ø© Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§ØºØŒ Ø§Ø³ØªØ®Ø¯Ù… _____ Ù„Ù„ÙØ±Ø§ØºØ§Øª
- Ø­Ø¯Ø¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø¨ÙˆØ¶ÙˆØ­

ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø£Ø¹Ù„Ø§Ù‡ Ø¨Ø¯Ù‚Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø£Ø³Ø¦Ù„Ø©.`;
            
            // Display the generated prompt
            document.getElementById('promptText').textContent = prompt;
            document.getElementById('generatedPrompt').classList.remove('hidden');
            
            showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Øµ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù†Ø³Ø®Ù‡ ÙˆØ§Ø³ØªØ®Ø¯Ù…Ù‡ ÙÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ', 'success');
        }

        function copyPromptToClipboard() {
            const promptText = document.getElementById('promptText').textContent;
            navigator.clipboard.writeText(promptText).then(() => {
                showNotification('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ“‹', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = promptText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
            });
        }

        function openChatGPT() {
            window.open('https://chat.openai.com/', '_blank');
        }

        function openClaude() {
            window.open('https://claude.ai/', '_blank');
        }

        function parseExternalAIResponse() {
            const responseText = document.getElementById('aiResponseText').value.trim();
            
            if (!responseText) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ù„ØµÙ‚ Ø±Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            try {
                // Parse the AI response using the same parsing function
                const parsedQuestions = parseAIResponseText(responseText);
                
                if (parsedQuestions.length === 0) {
                    showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù†Øµ. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­', 'error');
                    return;
                }
                
                // Add questions to the main questions array
                questions.push(...parsedQuestions);
                
                // Update UI
                updateQuestionsList();
                updatePreview();
                
                // Clear the response text area
                document.getElementById('aiResponseText').value = '';
                
                showNotification(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${parsedQuestions.length} Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ! ğŸ‰`, 'success');
                
                // Switch to questions tab to show the results
                switchTab('questions');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø±Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­', 'error');
            }
        }

        // Update preview with enhanced formatting
        function updatePreview() {
            console.log('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©...');
            
            try {
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    console.error('Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const examTitle = document.getElementById('examTitle').value || 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const duration = document.getElementById('duration').value || '90';
                const totalMarks = document.getElementById('totalMarks').value || '100';
                const teacherName = document.getElementById('teacherName').value || 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…';
                const schoolName = document.getElementById('schoolName').value || 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©';
                const examDate = document.getElementById('examDate')?.value || '';
                
                // Get advanced formatting options
                const headerFontFamily = document.getElementById('headerFontFamily')?.value || 'Cairo';
                const headerFontSize = parseInt(document.getElementById('headerFontSize')?.value || '24');
                const questionFontFamily = document.getElementById('questionFontFamily')?.value || 'Cairo';
                const questionFontSize = parseInt(document.getElementById('questionFontSize')?.value || '18');
                const optionFontFamily = document.getElementById('optionFontFamily')?.value || 'Cairo';
                const optionFontSize = parseInt(document.getElementById('optionFontSize')?.value || '16');
                const sectionFontFamily = document.getElementById('sectionFontFamily')?.value || 'Cairo';
                const sectionFontSize = parseInt(document.getElementById('sectionFontSize')?.value || '18');
                
                const headerStyle = document.getElementById('headerStyle')?.value || 'modern';
                const headerBgColor = document.getElementById('headerBgColor')?.value || '#f8fafc';
                const headerBorderColor = document.getElementById('headerBorderColor')?.value || '#e5e7eb';
                
                const showQuestionFrames = document.getElementById('showQuestionFrames')?.checked || false;
                const showMarks = document.getElementById('showMarks')?.checked || true;
                const showInstructions = document.getElementById('showInstructions')?.checked || false;
                const questionBold = document.getElementById('questionBold')?.checked || true;
                
                const questionNumbering = document.getElementById('questionNumbering')?.value || 'arabic';
                const optionSymbols = document.getElementById('optionSymbols')?.value || 'letters';
                const optionStyle = document.getElementById('optionStyle')?.value || 'vertical';
                const optionBoxStyle = document.getElementById('optionBoxStyle')?.value || 'circle';
                const optionBoxSize = document.getElementById('optionBoxSize')?.value || 'medium';
                const answerMarkType = document.getElementById('answerMarkType')?.value || 'arabic-letters';
                
                const shortAnswerSpace = document.getElementById('shortAnswerSpace')?.value || 'medium';
                const essayLines = document.getElementById('essayLines')?.value || '5';
                
                // Get organization options
                const groupByType = document.getElementById('groupByType')?.checked !== false;
                const showSectionHeaders = document.getElementById('showSectionHeaders')?.checked !== false;
                const showSectionInstructions = document.getElementById('showSectionInstructions')?.checked || false;
                
                // Get header options
                const showSubject = document.getElementById('showSubject')?.checked !== false;
                const showGrade = document.getElementById('showGrade')?.checked !== false;
                const showDuration = document.getElementById('showDuration')?.checked !== false;
                const showTotalMarks = document.getElementById('showTotalMarks')?.checked !== false;
                const showTeacher = document.getElementById('showTeacher')?.checked !== false;
                const showSchool = document.getElementById('showSchool')?.checked !== false;
                const showDate = document.getElementById('showDate')?.checked !== false;
                const showLogo = document.getElementById('showLogo')?.checked !== false;
                
                const showStudentName = document.getElementById('showStudentName')?.checked !== false;
                const showStudentId = document.getElementById('showStudentId')?.checked !== false;
                const showStudentClass = document.getElementById('showStudentClass')?.checked || false;
                const showStudentSeat = document.getElementById('showStudentSeat')?.checked || false;

                // Get logo and footer options
                const logoPosition = document.getElementById('logoPosition')?.value || 'center';
                const logoSize = parseInt(document.getElementById('logoSize')?.value || '80');
                const logoShape = document.getElementById('logoShape')?.value || 'normal';
                const showTeacherSignature = document.getElementById('showTeacherSignature')?.checked !== false;
                const showGoodLuck = document.getElementById('showGoodLuck')?.checked !== false;
                
                // Build header info
                const leftItems = [];
                const rightItems = [];
                
                if (showSubject) leftItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>Ø§Ù„Ù…Ø§Ø¯Ø©:</strong> ${subject}</p>`);
                if (showGrade) leftItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>Ø§Ù„ØµÙ:</strong> ${grade}</p>`);
                if (showDuration) leftItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>Ø§Ù„Ù…Ø¯Ø©:</strong> ${duration} Ø¯Ù‚ÙŠÙ‚Ø©</p>`);
                if (showDate && examDate) leftItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${formatDate(examDate)}</p>`);
                
                if (showTeacher) rightItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>Ø§Ù„Ù…Ø¹Ù„Ù…:</strong> ${teacherName}</p>`);
                if (showSchool) rightItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</strong> ${schoolName}</p>`);
                if (showTotalMarks) rightItems.push(`<p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px;"><strong>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©:</strong> ${totalMarks}</p>`);
                
                // Header style classes
                const headerStyleClasses = {
                    'classic': 'border-4 border-double',
                    'modern': 'border-2 rounded-lg shadow-sm',
                    'minimal': 'border-b-2',
                    'formal': 'border-2 border-black'
                };
                
                let previewHTML = '';
                
                // Check if header template should be used
                if (headerTemplateData && showHeaderTemplate) {
                    const headerStyle = getHeaderTemplateStyle();
                    
                    previewHTML += `
                        <!-- Custom Header Template with Advanced Controls -->
                        <div class="exam-header-template" style="margin-bottom: ${headerSettings.marginBottom}px; text-align: ${headerSettings.alignment}; margin-left: 0; margin-right: 0; padding: 0; width: 100%;">
                            <img src="${headerTemplateData}" alt="ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†" 
                                 style="${headerStyle}">
                        </div>
                        
                        <!-- Additional Info Below Template -->
                        ${(leftItems.length > 0 || rightItems.length > 0) ? `
                        <div class="header-info grid grid-cols-2 gap-6 text-gray-700 bg-white p-4 rounded-lg border shadow-sm mb-6">
                            <div class="text-right space-y-2">${leftItems.join('')}</div>
                            <div class="text-left space-y-2">${rightItems.join('')}</div>
                        </div>
                        ` : ''}
                    `;
                } else {
                    // Original header design (only when no template is uploaded or template is hidden)
                    previewHTML += `
                        <!-- Enhanced Header -->
                        <div class="exam-header ${headerStyleClasses[headerStyle] || 'border-2 rounded-lg'}" 
                             style="background-color: ${headerBgColor}; border-color: ${headerBorderColor}; font-family: ${headerFontFamily}; padding: 20px; margin-bottom: 25px;">
                            
                            <!-- Title and Logo Section -->
                            <div class="text-center mb-4">
                                <h1 style="font-family: ${headerFontFamily}; font-size: ${headerFontSize}px; font-weight: bold; color: #1f2937; margin-bottom: 12px; line-height: 1.2;">${examTitle}</h1>
                                ${(showLogo && schoolLogoData) ? `
                                    <div class="logo-container flex ${logoPosition === 'center' ? 'justify-center' : logoPosition === 'right' ? 'justify-end' : 'justify-start'} mb-3">
                                        <img src="${schoolLogoData}" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" 
                                             style="height: ${logoSize}px; width: auto; max-width: ${logoSize * 1.5}px; object-fit: contain; 
                                                    ${logoShape === 'circle' ? 'border-radius: 50%;' : logoShape === 'rounded' ? 'border-radius: 12px;' : ''}">
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${(leftItems.length > 0 || rightItems.length > 0) ? `
                            <div class="header-info grid grid-cols-2 gap-6 text-gray-700 bg-white p-4 rounded-lg border shadow-sm" style="margin: 15px 0;">
                                <div class="text-right space-y-2">${leftItems.join('')}</div>
                                <div class="text-left space-y-2">${rightItems.join('')}</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Student Info (common for both header types)
                if (showStudentName || showStudentId || showStudentClass || showStudentSeat) {
                    previewHTML += `
                        <div class="student-info mb-6 p-3 bg-gray-50 rounded border">
                            <div class="grid grid-cols-2 gap-4">
                                ${showStudentName ? `<div style="font-family: ${headerFontFamily}; font-size: ${Math.max(11, headerFontSize - 10)}px;"><strong>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> <span class="border-b-2 border-gray-400 inline-block w-40 h-5 ml-2"></span></div>` : ''}
                                ${showStudentId ? `<div style="font-family: ${headerFontFamily}; font-size: ${Math.max(11, headerFontSize - 10)}px;"><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ:</strong> <span class="border-b-2 border-gray-400 inline-block w-32 h-5 ml-2"></span></div>` : ''}
                                ${showStudentClass ? `<div style="font-family: ${headerFontFamily}; font-size: ${Math.max(11, headerFontSize - 10)}px;"><strong>Ø§Ù„Ø´Ø¹Ø¨Ø©:</strong> <span class="border-b-2 border-gray-400 inline-block w-24 h-5 ml-2"></span></div>` : ''}
                                ${showStudentSeat ? `<div style="font-family: ${headerFontFamily}; font-size: ${Math.max(11, headerFontSize - 10)}px;"><strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ù‚Ø¹Ø¯:</strong> <span class="border-b-2 border-gray-400 inline-block w-20 h-5 ml-2"></span></div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Instructions
                if (showInstructions) {
                    previewHTML += `
                        <div class="mb-4 p-3 bg-blue-50 rounded border border-blue-200">
                            <h3 class="font-bold text-blue-800 mb-2 text-sm">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:</h3>
                            <ul class="text-xs text-blue-700 space-y-1">
                                <li>â€¢ Ø§Ù‚Ø±Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ù†Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</li>
                                <li>â€¢ Ø£Ø¬Ø¨ Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</li>
                                <li>â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ù„Ù… Ø§Ù„Ø£Ø²Ø±Ù‚ Ø£Ùˆ Ø§Ù„Ø£Ø³ÙˆØ¯ ÙÙ‚Ø·</li>
                                <li>â€¢ Ù…Ø¯Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ${duration} Ø¯Ù‚ÙŠÙ‚Ø©</li>
                            </ul>
                        </div>
                    `;
                }
                
                // Questions with grouping
                if (questions.length > 0) {
                    previewHTML += '<div class="questions-section">';
                    
                    if (groupByType) {
                        const groupedQuestions = groupQuestionsByType(questions);
                        let questionCounter = 1;
                        
                        Object.keys(groupedQuestions).forEach(type => {
                            const typeQuestions = groupedQuestions[type];
                            if (typeQuestions.length > 0) {
                                // Section header with edit capability
                                if (showSectionHeaders) {
                                    const sectionTitle = getSectionTitle(type);
                                    const sectionBgColor = document.getElementById('sectionBgColor')?.value || '#f3f4f6';
                                    const sectionBorderColor = document.getElementById('sectionBorderColor')?.value || '#3b82f6';
                                    const sectionStyle = document.getElementById('sectionStyle')?.value || 'modern';
                                    
                                    const sectionStyleClasses = getSectionStyleClasses(sectionStyle, sectionBgColor, sectionBorderColor);
                                    
                                    previewHTML += `
                                        <div class="section-header editable-section-title cursor-pointer hover:bg-gray-100 transition-colors" 
                                             style="font-family: ${sectionFontFamily}; font-size: ${sectionFontSize}px; ${sectionStyleClasses}" 
                                             onclick="editSectionTitle('${type}')" 
                                             title="Ø§Ù†Ù‚Ø± Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…">
                                            ${sectionTitle}
                                            <i class="fas fa-edit text-xs text-gray-400 mr-2 opacity-0 group-hover:opacity-100"></i>
                                        </div>
                                    `;
                                    
                                    if (showSectionInstructions) {
                                        const instruction = getSectionInstruction(type);
                                        if (instruction) {
                                            previewHTML += `
                                                <div class="mb-3 text-sm text-gray-600 italic cursor-pointer hover:bg-gray-100 p-2 rounded transition-colors" 
                                                     onclick="editSectionInstruction('${type}')" 
                                                     title="Ø§Ù†Ù‚Ø± Ù„ØªØ¹Ø¯ÙŠÙ„ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù‚Ø³Ù…">
                                                    ${instruction}
                                                    <i class="fas fa-edit text-xs text-gray-400 mr-2 opacity-0 hover:opacity-100"></i>
                                                </div>
                                            `;
                                        }
                                    }
                                }
                                
                                // Add section marks summary if enabled
                                if (showMarks) {
                                    const sectionTotal = typeQuestions.reduce((sum, q) => sum + (q.hideMarks ? 0 : (q.marks || 0)), 0);
                                    const sectionCount = typeQuestions.filter(q => !q.hideMarks).length;
                                    if (sectionTotal > 0) {
                                        previewHTML += `
                                            <div class="mb-3 text-sm text-gray-600 bg-blue-50 p-2 rounded border">
                                                <strong>Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±Ø¬Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…: ${sectionTotal} Ø¯Ø±Ø¬Ø© (${sectionCount} Ø³Ø¤Ø§Ù„)</strong>
                                            </div>
                                        `;
                                    }
                                }
                                
                                // Questions in this section
                                typeQuestions.forEach((question, index) => {
                                    previewHTML += renderQuestion(question, questionCounter, {
                                        showQuestionFrames,
                                        showMarks,
                                        questionNumbering,
                                        optionSymbols,
                                        shortAnswerSpace,
                                        essayLines,
                                        questionFontFamily,
                                        questionFontSize,
                                        optionFontFamily,
                                        optionFontSize,
                                        sectionFontFamily,
                                        sectionFontSize,
                                        questionBold,
                                        optionStyle,
                                        optionBoxStyle,
                                        optionBoxSize,
                                        answerMarkType
                                    });
                                    
                                    // Add page break indicator every 6-8 questions (approximate)
                                    if ((questionCounter % 7 === 0) && (questionCounter < questions.length)) {
                                        previewHTML += '<div class="page-break-indicator no-print"></div>';
                                    }
                                    
                                    questionCounter++;
                                });
                            }
                        });
                    } else {
                        questions.forEach((question, index) => {
                            previewHTML += renderQuestion(question, index + 1, {
                                showQuestionFrames,
                                showMarks,
                                questionNumbering,
                                optionSymbols,
                                shortAnswerSpace,
                                essayLines,
                                questionFontFamily,
                                questionFontSize,
                                optionFontFamily,
                                optionFontSize,
                                sectionFontFamily,
                                sectionFontSize,
                                questionBold,
                                optionStyle,
                                optionBoxStyle,
                                optionBoxSize,
                                answerMarkType
                            });
                        });
                    }
                    
                    previewHTML += '</div>';
                    
                    // Add total marks summary
                    if (showMarks) {
                        const totalCalculatedMarks = questions.reduce((sum, q) => sum + (q.hideMarks ? 0 : (q.marks || 0)), 0);
                        const visibleQuestionsCount = questions.filter(q => !q.hideMarks).length;
                        
                        if (totalCalculatedMarks > 0) {
                            previewHTML += `
                                <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="text-center">
                                        <h3 style="font-family: ${headerFontFamily}; font-size: ${Math.max(16, headerFontSize - 4)}px; font-weight: bold; color: #065f46; margin-bottom: 8px;">
                                            Ù…Ù„Ø®Øµ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
                                        </h3>
                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª:</strong> ${totalCalculatedMarks} Ø¯Ø±Ø¬Ø©
                                            </div>
                                            <div>
                                                <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</strong> ${visibleQuestionsCount} Ø³Ø¤Ø§Ù„
                                            </div>
                                        </div>
                                        ${visibleQuestionsCount > 0 ? `
                                            <div class="mt-2 text-xs text-green-700">
                                                Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„: ${(totalCalculatedMarks / visibleQuestionsCount).toFixed(1)} Ø¯Ø±Ø¬Ø©
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // Add footer section
                    if (showTeacherSignature || showGoodLuck) {
                        previewHTML += `
                            <div class="exam-footer mt-8 pt-6 border-t border-gray-300">
                                ${showGoodLuck ? `
                                    <div class="text-center mb-6">
                                        <p style="font-family: ${headerFontFamily}; font-size: ${Math.max(14, headerFontSize - 6)}px; color: #059669; font-weight: bold;">
                                            ğŸŒŸ Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­ ğŸŒŸ
                                        </p>
                                    </div>
                                ` : ''}
                                ${showTeacherSignature ? `
                                    <div class="flex justify-between items-center">
                                        <div class="text-right">
                                            <p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px; color: #374151;">
                                                <strong>Ø§Ù„Ù…Ø¹Ù„Ù…:</strong> ${teacherName}
                                            </p>
                                            <div class="mt-2 border-b-2 border-gray-400 w-32 h-6"></div>
                                            <p class="text-xs text-gray-500 mt-1">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</p>
                                        </div>
                                        <div class="text-left">
                                            <p style="font-family: ${headerFontFamily}; font-size: ${Math.max(12, headerFontSize - 8)}px; color: #374151;">
                                                <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${examDate ? formatDate(examDate) : '___________'}
                                            </p>
                                        </div>
                                    </div>
                                ` : ''}
                                <!-- Developer Credit -->
                                <div class="text-center mt-6 pt-4 border-t border-gray-200">
                                    <p class="text-xs text-gray-400">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†Ø´Ø¦ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ±</p>
                                    <p class="text-xs text-gray-500 mt-1">Ø§Ù„Ù…Ø·ÙˆØ±: Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ù†ØµØ± Ø§Ù„Ù„Ù‡</p>
                                </div>
                            </div>
                        `;
                    } else {
                        // Add developer credit even if no footer is shown
                        previewHTML += `
                            <div class="exam-footer mt-8 pt-6 border-t border-gray-300">
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†Ø´Ø¦ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ±</p>
                                    <p class="text-xs text-gray-500 mt-1">Ø§Ù„Ù…Ø·ÙˆØ±: Ø£. Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ù†ØµØ± Ø§Ù„Ù„Ù‡</p>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    previewHTML += `
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-file-alt text-4xl mb-3 opacity-30"></i>
                            <p class="text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø¹Ø±Ø¶</p>
                            <p class="text-sm">Ø£Ø¶Ù Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</p>
                        </div>
                    `;
                }
                
                examPreview.innerHTML = previewHTML;
                console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©:', error);
            }
        }

        // Group questions by type
        function groupQuestionsByType(questions) {
            const groups = {
                'mcq': [],
                'true-false': [],
                'short': [],
                'essay': [],
                'fill': []
            };
            
            questions.forEach(question => {
                if (groups[question.type]) {
                    groups[question.type].push(question);
                }
            });
            
            return groups;
        }

        // Section titles and instructions with editing capability
        let sectionTitles = {
            'mcq': 'Ø£ÙˆÙ„Ø§Ù‹: Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯',
            'true-false': 'Ø«Ø§Ù†ÙŠØ§Ù‹: Ø£Ø³Ø¦Ù„Ø© ØµØ­ Ø£Ù… Ø®Ø·Ø£',
            'short': 'Ø«Ø§Ù„Ø«Ø§Ù‹: Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù‚ØµÙŠØ±Ø©',
            'fill': 'Ø±Ø§Ø¨Ø¹Ø§Ù‹: Ø£Ø³Ø¦Ù„Ø© Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§Øº',
            'essay': 'Ø®Ø§Ù…Ø³Ø§Ù‹: Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„'
        };

        let sectionInstructions = {
            'mcq': 'Ø¶Ø¹ Ø¯Ø§Ø¦Ø±Ø© Ø­ÙˆÙ„ Ø±Ù…Ø² Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:',
            'true-false': 'Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© (âœ“) Ø£Ù…Ø§Ù… Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ¹Ù„Ø§Ù…Ø© (âœ—) Ø£Ù…Ø§Ù… Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ø·Ø¦Ø©:',
            'short': 'Ø£Ø¬Ø¨ Ø¹Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©:',
            'fill': 'Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨Ù‡Ø§:',
            'essay': 'Ø£Ø¬Ø¨ Ø¹Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¥Ø¬Ø§Ø¨Ø© Ù…ÙØµÙ„Ø©:'
        };

        // Get section titles
        function getSectionTitle(type) {
            return sectionTitles[type] || 'Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙ†ÙˆØ¹Ø©';
        }

        // Edit section title
        function editSectionTitle(type) {
            const currentTitle = sectionTitles[type];
            const newTitle = prompt('Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:', currentTitle);
            if (newTitle !== null && newTitle.trim()) {
                sectionTitles[type] = newTitle.trim();
                updatePreview();
                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }

        // Get section instructions
        function getSectionInstruction(type) {
            return sectionInstructions[type] || '';
        }

        // Edit section instruction
        function editSectionInstruction(type) {
            const currentInstruction = sectionInstructions[type];
            const newInstruction = prompt('Ø£Ø¯Ø®Ù„ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', currentInstruction);
            if (newInstruction !== null) {
                sectionInstructions[type] = newInstruction.trim();
                updatePreview();
                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }

        // Get answer mark based on type (without symbols)
        function getAnswerMark(index, markType) {
            const arabicLetters = ['Ø£', 'Ø¨', 'Ø¬', 'Ø¯', 'Ù‡Ù€', 'Ùˆ'];
            
            switch (markType) {
                case 'numbers':
                    return (index + 1).toString();
                case 'arabic-letters':
                    return arabicLetters[index] || (index + 1).toString();
                case 'english-letters':
                    return String.fromCharCode(65 + index);
                case 'empty':
                    return '';
                default:
                    return arabicLetters[index] || (index + 1).toString();
            }
        }

        // Render individual question with enhanced formatting
        function renderQuestion(question, questionNumber, options) {
            const {
                showQuestionFrames, showMarks, questionNumbering, optionSymbols, shortAnswerSpace, essayLines,
                questionFontFamily, questionFontSize, optionFontFamily, optionFontSize, sectionFontFamily, sectionFontSize,
                questionBold, optionStyle, optionBoxStyle, optionBoxSize, answerMarkType
            } = options;
            
            const frameClass = showQuestionFrames ? 'question-with-frame' : '';
            
            let marksHtml = '';
            if (showMarks && !question.hideMarks) {
                marksHtml = `<span class="float-left text-sm text-gray-600">(${question.marks} Ø¯Ø±Ø¬Ø§Øª)</span>`;
            }
            
            // Format question number
            const formattedNumber = getQuestionNumber(questionNumber, questionNumbering);
            
            // Box size mapping
            const boxSizes = {
                'small': 'w-4 h-4',
                'medium': 'w-6 h-6',
                'large': 'w-8 h-8'
            };
            
            // Box shape styles
            const boxShapes = {
                'circle': 'rounded-full',
                'square': 'rounded-sm',
                'none': 'border-0'
            };
            
            let questionHtml = `
                <div class="question-container mb-6 ${frameClass}">
                    <div class="flex justify-between items-start mb-3">
                        <h4 style="font-family: ${questionFontFamily}; font-size: ${questionFontSize}px; ${questionBold ? 'font-weight: bold;' : ''} color: #1f2937; flex: 1;">
                            ${formattedNumber} ${question.text}
                        </h4>
                        ${marksHtml}
                    </div>
                    <div class="question-content">
            `;
            
            if (question.type === 'mcq') {
                const optionLayoutClass = getOptionLayoutClass(optionStyle);
                
                questionHtml += `<div class="${optionLayoutClass}">`;
                question.options.forEach((option, i) => {
                    const answerMark = getAnswerMark(i, answerMarkType);
                    const boxClass = optionBoxStyle !== 'none' ? 
                        `answer-mark ${optionBoxStyle} ${boxSizes[optionBoxSize]}` : '';
                    
                    questionHtml += `
                        <div class="option-item flex items-center" style="background: transparent; padding: 2px 0; margin-bottom: 6px;">
                            ${optionBoxStyle !== 'none' ? `<span class="${boxClass}">${answerMark}</span>` : ''}
                            <span style="font-family: ${optionFontFamily}; font-size: ${optionFontSize}px;">${answerMark ? answerMark + ' ' : ''}${option}</span>
                        </div>
                    `;
                });
                questionHtml += `</div>`;
                
            } else if (question.type === 'true-false') {
                const layoutClass = optionStyle === 'horizontal' ? 'flex items-center space-x-8 space-x-reverse' : 'space-y-2';
                const boxClass = optionBoxStyle !== 'none' ? 
                    `answer-mark ${optionBoxStyle} ${boxSizes[optionBoxSize]}` : '';
                
                const trueMark = getAnswerMark(0, answerMarkType);
                const falseMark = getAnswerMark(1, answerMarkType);
                
                questionHtml += `
                    <div class="${layoutClass}">
                        <div class="flex items-center" style="background: transparent; padding: 2px 0;">
                            ${optionBoxStyle !== 'none' ? `<span class="${boxClass}">${trueMark}</span>` : ''}
                            <span style="font-family: ${optionFontFamily}; font-size: ${optionFontSize}px;">${trueMark ? trueMark + ' ' : ''}ØµØ­</span>
                        </div>
                        <div class="flex items-center" style="background: transparent; padding: 2px 0;">
                            ${optionBoxStyle !== 'none' ? `<span class="${boxClass}">${falseMark}</span>` : ''}
                            <span style="font-family: ${optionFontFamily}; font-size: ${optionFontSize}px;">${falseMark ? falseMark + ' ' : ''}Ø®Ø·Ø£</span>
                        </div>
                    </div>
                `;
                
            } else if (question.type === 'short') {
                const spaceMap = {'small': 1, 'medium': 2, 'large': 3};
                const lineCount = spaceMap[shortAnswerSpace] || 2;
                
                questionHtml += `<div class="answer-lines">`;
                for (let i = 0; i < lineCount; i++) {
                    questionHtml += `<div class="answer-line" style="height: 35px; border-bottom: 2px solid #9ca3af; margin-bottom: 8px;"></div>`;
                }
                questionHtml += `</div>`;
                
            } else if (question.type === 'essay') {
                const lineCount = parseInt(essayLines) || 5;
                questionHtml += `<div class="answer-lines">`;
                for (let i = 0; i < lineCount; i++) {
                    questionHtml += `<div class="answer-line" style="height: 35px; border-bottom: 2px solid #9ca3af; margin-bottom: 8px;"></div>`;
                }
                questionHtml += `</div>`;
                
            } else if (question.type === 'fill') {
                const textWithBlanks = question.text.replace(/_____/g, '<span class="border-b-2 border-gray-300 inline-block w-24 h-6"></span>');
                questionHtml = questionHtml.replace(question.text, textWithBlanks);
            }
            
            questionHtml += `
                    </div>
                </div>
            `;
            
            return questionHtml;
        }

        // Helper function for option layout
        function getOptionLayoutClass(style) {
            switch (style) {
                case 'horizontal':
                    return 'options-horizontal';
                case 'grid-2':
                    return 'options-grid-2';
                case 'grid-4':
                    return 'options-grid-4';
                case 'vertical':
                default:
                    return 'options-vertical';
            }
        }

        // Helper functions for formatting
        function getQuestionNumber(num, style) {
            switch (style) {
                case 'arabic':
                    return num + '.';
                case 'letters':
                    return String.fromCharCode(64 + num) + ')';
                case 'roman':
                    return toRoman(num) + '.';
                default:
                    return num + '.';
            }
        }

        function getOptionSymbol(index, style) {
            switch (style) {
                case 'letters':
                    return String.fromCharCode(65 + index) + ')';
                case 'numbers':
                    return (index + 1) + ')';
                case 'circles':
                    return 'â—‹';
                case 'empty':
                    return '';
                default:
                    return String.fromCharCode(65 + index) + ')';
            }
        }

        function toRoman(num) {
            const values = [10, 9, 5, 4, 1];
            const symbols = ['X', 'IX', 'V', 'IV', 'I'];
            let result = '';
            
            for (let i = 0; i < values.length; i++) {
                while (num >= values[i]) {
                    result += symbols[i];
                    num -= values[i];
                }
            }
            return result;
        }

        // Download exam as separate page images with enhanced rendering
        async function downloadAsImages() {
            try {
                // Show loading message
                const originalButton = document.querySelector('button[onclick="downloadAsImages()"]');
                const originalText = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...';
                originalButton.disabled = true;
                
                // Get the entire exam preview
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    throw new Error('Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                }
                
                // Check if there's content to capture
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
                }
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...';
                
                // Create dynamic pages based on actual content height
                const pages = await createDynamicPages();
                
                if (pages.length === 0) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ù„Ù‰ ØµÙØ­Ø§Øª');
                }
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±...';
                
                // Generate filename base
                const examTitle = document.getElementById('examTitle').value || 'Ø§Ù…ØªØ­Ø§Ù†';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const timestamp = new Date().toISOString().slice(0, 10);
                const baseFilename = `${examTitle}_${subject}_${grade}_${timestamp}`;
                
                // Process each page with enhanced rendering
                for (let i = 0; i < pages.length; i++) {
                    try {
                        originalButton.innerHTML = `<i class="fas fa-spinner fa-spin ml-1"></i>ØµÙØ­Ø© ${i + 1}/${pages.length}...`;
                        
                        // Create optimized container for this page with proper A4 dimensions
                        const pageContainer = document.createElement('div');
                        pageContainer.style.cssText = `
                            position: absolute;
                            top: -10000px;
                            left: -10000px;
                            width: 794px;
                            min-height: 1123px;
                            background: #ffffff;
                            padding: 60px;
                            font-family: 'Cairo', 'Amiri', 'Tajawal', Arial, sans-serif;
                            direction: rtl;
                            text-align: right;
                            color: #000000;
                            line-height: 1.6;
                            box-sizing: border-box;
                            font-size: 16px;
                            overflow: visible;
                            border: none;
                            box-shadow: none;
                        `;
                        
                        pageContainer.innerHTML = pages[i];
                        document.body.appendChild(pageContainer);
                        
                        // Wait for fonts and rendering
                        await new Promise(resolve => setTimeout(resolve, 1200));
                        
                        // Enhanced html2canvas settings for better Arabic text rendering
                        const canvas = await html2canvas(pageContainer, {
                            scale: 3,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff',
                            width: 794,
                            height: Math.max(1123, pageContainer.scrollHeight + 120),
                            scrollX: 0,
                            scrollY: 0,
                            logging: false,
                            removeContainer: true,
                            imageTimeout: 20000,
                            foreignObjectRendering: true,
                            letterRendering: true,
                            onclone: function(clonedDoc) {
                                // Ensure proper font loading and Arabic text rendering
                                const clonedContainer = clonedDoc.querySelector('div');
                                if (clonedContainer) {
                                    clonedContainer.style.fontFamily = 'Cairo, Amiri, Tajawal, Arial, sans-serif';
                                    clonedContainer.style.fontWeight = 'normal';
                                    clonedContainer.style.textRendering = 'optimizeLegibility';
                                    clonedContainer.style.webkitFontSmoothing = 'antialiased';
                                    clonedContainer.style.mozOsxFontSmoothing = 'grayscale';
                                    
                                    // Fix any potential layout issues
                                    const allElements = clonedContainer.querySelectorAll('*');
                                    allElements.forEach(el => {
                                        if (el.style) {
                                            el.style.webkitTransform = 'none';
                                            el.style.transform = 'none';
                                            el.style.webkitFilter = 'none';
                                            el.style.filter = 'none';
                                        }
                                    });
                                }
                            }
                        });
                        
                        // Remove container
                        document.body.removeChild(pageContainer);
                        
                        if (canvas && canvas.width > 0 && canvas.height > 0) {
                            // Convert to high-quality PNG
                            const imageDataUrl = canvas.toDataURL('image/png', 1.0);
                            
                            // Download the image
                            const filename = `${baseFilename}_ØµÙØ­Ø©_${i + 1}.png`;
                            const link = document.createElement('a');
                            link.download = filename;
                            link.href = imageDataUrl;
                            link.style.display = 'none';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            // Small delay between downloads
                            await new Promise(resolve => setTimeout(resolve, 300));
                        } else {
                            throw new Error(`ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„ØµÙØ­Ø© ${i + 1}`);
                        }
                        
                    } catch (pageError) {
                        console.error(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙØ­Ø© ${i + 1}:`, pageError);
                        showNotification(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙØ­Ø© ${i + 1}: ${pageError.message}`, 'warning');
                        // Continue with next page
                    }
                }
                
                // Reset button
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
                
                showNotification(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${pages.length} ØµÙØ­Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ–¼ï¸âœ¨`, 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±:', error);
                showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±: ${error.message}`, 'error');
                
                // Reset button
                const button = document.querySelector('button[onclick="downloadAsImages()"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-images ml-1"></i>ØªØ­Ù…ÙŠÙ„ ÙƒØµÙˆØ± Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©';
                    button.disabled = false;
                }
            }
        }

        // Simple image download function - FIXED VERSION
        async function downloadAsImages() {
            try {
                // Check if html2canvas is available
                if (typeof html2canvas === 'undefined') {
                    showNotification('Ù…ÙƒØªØ¨Ø© html2canvas ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©', 'error');
                    return;
                }

                // Show loading message
                const originalButton = document.querySelector('button[onclick="downloadAsImages()"]');
                const originalText = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...';
                originalButton.disabled = true;
                
                // Get the entire exam preview
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    throw new Error('Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                }
                
                // Check if there's content to capture
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
                }
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰...';
                
                // Hide page break indicators
                examPreview.classList.add('capturing-images');
                
                // Generate filename base
                const examTitle = document.getElementById('examTitle').value || 'Ø§Ù…ØªØ­Ø§Ù†';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const timestamp = new Date().toISOString().slice(0, 10);
                const baseFilename = `${examTitle}_${subject}_${grade}_${timestamp}`;
                
                // Simple approach: capture the entire content as one image first
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©...';
                
                try {
                    // Create a clean container for capture
                    const captureContainer = document.createElement('div');
                    captureContainer.style.cssText = `
                        position: absolute;
                        top: -9999px;
                        left: -9999px;
                        width: 800px;
                        background: #ffffff;
                        padding: 40px;
                        font-family: 'Cairo', Arial, sans-serif;
                        direction: rtl;
                        text-align: right;
                        color: #000000;
                        line-height: 1.5;
                        box-sizing: border-box;
                    `;
                    
                    // Clone the content without page break indicators
                    const cleanContent = examPreview.cloneNode(true);
                    const pageBreaks = cleanContent.querySelectorAll('.page-break-indicator');
                    pageBreaks.forEach(pb => pb.remove());
                    
                    captureContainer.appendChild(cleanContent);
                    document.body.appendChild(captureContainer);
                    
                    // Wait for rendering
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Capture with html2canvas
                    const canvas = await html2canvas(captureContainer, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        width: captureContainer.scrollWidth,
                        height: captureContainer.scrollHeight
                    });
                    
                    // Remove container
                    document.body.removeChild(captureContainer);
                    
                    if (canvas && canvas.width > 0 && canvas.height > 0) {
                        // Convert to PNG
                        const imageDataUrl = canvas.toDataURL('image/png', 1.0);
                        
                        // Download the image
                        const filename = `${baseFilename}.png`;
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = imageDataUrl;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ–¼ï¸âœ¨', 'success');
                    } else {
                        throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©');
                    }
                    
                } catch (captureError) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©:', captureError);
                    throw captureError;
                }
                
                // Remove capturing class
                examPreview.classList.remove('capturing-images');
                
                // Reset button
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±:', error);
                showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±: ${error.message}`, 'error');
                
                // Remove capturing class
                const examPreview = document.getElementById('examPreview');
                if (examPreview) {
                    examPreview.classList.remove('capturing-images');
                }
                
                // Reset button
                const button = document.querySelector('button[onclick="downloadAsImages()"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-images ml-1"></i>ØµÙˆØ± PNG (html2canvas)';
                    button.disabled = false;
                }
            }
        }

        // Simple print function
        function printExam() {
            try {
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    showNotification('Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                    return;
                }
                
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                    return;
                }
                
                // Hide page break indicators
                examPreview.classList.add('capturing-images');
                
                // Use window.print()
                window.print();
                
                // Remove capturing class after print dialog
                setTimeout(() => {
                    examPreview.classList.remove('capturing-images');
                }, 1000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
            }
        }

        // Alternative PDF generation using html2pdf.js (if available)
        async function saveToAdvancedPDF() {
            try {
                // Check if html2pdf is available
                if (typeof html2pdf === 'undefined') {
                    showNotification('Ù…ÙƒØªØ¨Ø© html2pdf ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ', 'warning');
                    return saveToPDF(); // Fallback to regular function
                }

                // Show loading message
                const originalButton = document.querySelector('button[onclick="saveToAdvancedPDF()"]');
                const originalText = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF Ù…ØªÙ‚Ø¯Ù…...';
                originalButton.disabled = true;
                
                // Get the preview element
                const previewElement = document.getElementById('examPreview');
                if (!previewElement) {
                    throw new Error('Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                }
                
                // Check if there's content to export
                if (!previewElement.innerHTML.trim() || questions.length === 0) {
                    throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
                }
                
                // Add capturing class to hide page break indicators
                previewElement.classList.add('capturing-images');
                
                // Create filename
                const examTitle = document.getElementById('examTitle').value || 'Ø§Ù…ØªØ­Ø§Ù†';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `${examTitle}_${subject}_${grade}_${timestamp}_Ù…ØªÙ‚Ø¯Ù….pdf`;
                
                // Configure html2pdf options
                const options = {
                    margin: [15, 15, 15, 15],
                    filename: filename,
                    image: { type: 'png', quality: 0.9 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    }
                };
                
                // Generate PDF
                await html2pdf().set(options).from(previewElement).save();
                
                // Remove capturing class
                previewElement.classList.remove('capturing-images');
                
                // Reset button
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
                
                showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ PDF Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­! ğŸ“„âœ¨', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF Ø§Ù„Ù…ØªÙ‚Ø¯Ù…:', error);
                showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF Ø§Ù„Ù…ØªÙ‚Ø¯Ù…: ${error.message}`, 'error');
                
                // Remove capturing class in case of error
                const previewElement = document.getElementById('examPreview');
                if (previewElement) {
                    previewElement.classList.remove('capturing-images');
                }
                
                // Reset button
                const button = document.querySelector('button[onclick="saveToAdvancedPDF()"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-file-pdf ml-1"></i>PDF Ù…ØªÙ‚Ø¯Ù… (html2pdf)';
                    button.disabled = false;
                }
            }
        }

        // Alternative image download using dom-to-image (if available)
        async function downloadAsImagesAdvanced() {
            try {
                // Check if dom-to-image is available
                if (typeof domtoimage === 'undefined') {
                    showNotification('Ù…ÙƒØªØ¨Ø© dom-to-image ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ', 'warning');
                    return downloadAsImages(); // Fallback to regular function
                }

                // Show loading message
                const originalButton = document.querySelector('button[onclick="downloadAsImagesAdvanced()"]');
                const originalText = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…...';
                originalButton.disabled = true;
                
                // Get the entire exam preview
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    throw new Error('Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                }
                
                // Check if there's content to capture
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
                }
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…...';
                
                // Hide page break indicators
                examPreview.classList.add('capturing-images');
                
                // Generate filename base
                const examTitle = document.getElementById('examTitle').value || 'Ø§Ù…ØªØ­Ø§Ù†';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const timestamp = new Date().toISOString().slice(0, 10);
                const baseFilename = `${examTitle}_${subject}_${grade}_${timestamp}_Ù…ØªÙ‚Ø¯Ù…`;
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©...';
                
                try {
                    // Create a clean container for capture
                    const captureContainer = document.createElement('div');
                    captureContainer.style.cssText = `
                        position: absolute;
                        top: -9999px;
                        left: -9999px;
                        width: 800px;
                        background: #ffffff;
                        padding: 40px;
                        font-family: 'Cairo', Arial, sans-serif;
                        direction: rtl;
                        text-align: right;
                        color: #000000;
                        line-height: 1.5;
                        box-sizing: border-box;
                    `;
                    
                    // Clone the content without page break indicators
                    const cleanContent = examPreview.cloneNode(true);
                    const pageBreaks = cleanContent.querySelectorAll('.page-break-indicator');
                    pageBreaks.forEach(pb => pb.remove());
                    
                    captureContainer.appendChild(cleanContent);
                    document.body.appendChild(captureContainer);
                    
                    // Wait for rendering
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Use dom-to-image
                    const dataUrl = await domtoimage.toPng(captureContainer, {
                        quality: 1.0,
                        bgcolor: '#ffffff',
                        cacheBust: true,
                        width: captureContainer.scrollWidth,
                        height: captureContainer.scrollHeight
                    });
                    
                    // Remove container
                    document.body.removeChild(captureContainer);
                    
                    if (dataUrl && dataUrl.length > 100) {
                        // Download the image
                        const filename = `${baseFilename}.png`;
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = dataUrl;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ–¼ï¸âœ¨', 'success');
                    } else {
                        throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©');
                    }
                    
                } catch (captureError) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:', captureError);
                    throw captureError;
                }
                
                // Remove capturing class
                examPreview.classList.remove('capturing-images');
                
                // Reset button
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:', error);
                showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©: ${error.message}`, 'error');
                
                // Remove capturing class
                const examPreview = document.getElementById('examPreview');
                if (examPreview) {
                    examPreview.classList.remove('capturing-images');
                }
                
                // Reset button
                const button = document.querySelector('button[onclick="downloadAsImagesAdvanced()"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-images ml-1"></i>ØµÙˆØ± Ù…ØªÙ‚Ø¯Ù…Ø© (dom-to-image)';
                    button.disabled = false;
                }
            }
        }

        // Simple and reliable printing function
        function printExamAdvanced() {
            try {
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    showNotification('Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                    return;
                }
                
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                    return;
                }
                
                // Hide page break indicators for printing
                examPreview.classList.add('capturing-images');
                
                // Use the standard print function with better styling
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</title>
                        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                        <style>
                            * {
                                font-family: 'Cairo', Arial, sans-serif !important;
                                direction: rtl !important;
                                text-align: right !important;
                            }
                            
                            body {
                                margin: 0;
                                padding: 20px;
                                font-size: 14px;
                                line-height: 1.5;
                                color: #000000;
                                background: #ffffff;
                            }
                            
                            .page-break-indicator {
                                display: none !important;
                            }
                            
                            .question-container {
                                page-break-inside: avoid;
                                break-inside: avoid;
                                margin-bottom: 20px;
                            }
                            
                            .exam-header {
                                page-break-after: avoid;
                            }
                            
                            .section-header {
                                page-break-after: avoid;
                                page-break-inside: avoid;
                            }
                            
                            @page {
                                size: A4;
                                margin: 15mm;
                            }
                            
                            @media print {
                                body { print-color-adjust: exact; }
                            }
                        </style>
                    </head>
                    <body>
                        ${examPreview.innerHTML}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                // Wait for content to load then print
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                    
                    // Remove capturing class
                    examPreview.classList.remove('capturing-images');
                    
                    showNotification('ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©! ğŸ–¨ï¸', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', error);
                showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${error.message}`, 'error');
                
                // Remove capturing class
                const examPreview = document.getElementById('examPreview');
                if (examPreview) {
                    examPreview.classList.remove('capturing-images');
                }
            }
        }

        // Save as HTML file
        function saveAsHTML() {
            try {
                const examPreview = document.getElementById('examPreview');
                if (!examPreview) {
                    showNotification('Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                    return;
                }
                
                if (!examPreview.innerHTML.trim() || questions.length === 0) {
                    showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ø­ÙØ¸. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                    return;
                }
                
                // Create complete HTML document
                const htmlContent = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${document.getElementById('examTitle').value || 'Ø§Ù…ØªØ­Ø§Ù†'}</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700&family=Almarai:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Cairo', 'Amiri', 'Tajawal', Arial, sans-serif;
            direction: rtl;
            text-align: right;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
        }
        
        .page-break-indicator {
            display: none !important;
        }
        
        @media print {
            .question-container {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            @page {
                size: A4;
                margin: 15mm;
            }
        }
        
        .exam-header {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            background: #f8fafc;
        }
        
        .question-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #ffffff;
        }
        
        .section-header {
            background: #f3f4f6;
            padding: 12px 20px;
            margin: 20px 0 15px 0;
            border-right: 4px solid #3b82f6;
            font-weight: bold;
            font-size: 18px;
            color: #1f2937;
        }
        
        .answer-line {
            height: 30px;
            border-bottom: 1px solid #9ca3af;
            margin-bottom: 6px;
        }
        
        .answer-mark {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #374151;
            margin-left: 8px;
            text-align: center;
            line-height: 16px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .answer-mark.circle {
            border-radius: 50%;
        }
        
        .answer-mark.square {
            border-radius: 2px;
        }
    </style>
</head>
<body>
    ${examPreview.innerHTML.replace(/class="page-break-indicator[^"]*"/g, 'style="display:none"')}
</body>
</html>`;
                
                // Create filename
                const examTitle = document.getElementById('examTitle').value || 'Ø§Ù…ØªØ­Ø§Ù†';
                const subject = getSubjectText(document.getElementById('subject').value);
                const grade = getGradeText(document.getElementById('grade').value);
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `${examTitle}_${subject}_${grade}_${timestamp}.html`;
                
                // Create and download file
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                
                if (typeof saveAs !== 'undefined') {
                    saveAs(blob, filename);
                } else {
                    // Fallback method
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }
                
                showNotification('ØªÙ… Ø­ÙØ¸ Ù…Ù„Ù HTML Ø¨Ù†Ø¬Ø§Ø­! ğŸ“„', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ HTML:', error);
                showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ HTML: ${error.message}`, 'error');
            }
        }

        // Simple and reliable PDF generation - FIXED VERSION
        async function saveToPDF() {
            try {
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    showNotification('Ù…ÙƒØªØ¨Ø© jsPDF ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©', 'error');
                    return;
                }

                // Show loading message
                const originalButton = document.querySelector('button[onclick="saveToPDF()"]');
                const originalText = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF...';
                originalButton.disabled = true;
                
                // Get the preview element
                const previewElement = document.getElementById('examPreview');
                if (!previewElement) {
                    throw new Error('Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                }
                
                // Check if there's content to export
                if (!previewElement.innerHTML.trim() || questions.length === 0) {
                    throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
                }
                
                // Hide page break indicators
                previewElement.classList.add('capturing-images');
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰...';
                
                // Create a clean container for PDF
                const pdfContainer = document.createElement('div');
                pdfContainer.style.cssText = `
                    position: absolute;
                    top: -9999px;
                    left: -9999px;
                    width: 800px;
                    background: #ffffff;
                    padding: 30px;
                    font-family: 'Cairo', Arial, sans-serif;
                    direction: rtl;
                    text-align: right;
                    color: #000000;
                    line-height: 1.5;
                    box-sizing: border-box;
                `;
                
                // Clone content without page break indicators
                const cleanContent = previewElement.cloneNode(true);
                const pageBreaks = cleanContent.querySelectorAll('.page-break-indicator');
                pageBreaks.forEach(pb => pb.remove());
                
                pdfContainer.appendChild(cleanContent);
                document.body.appendChild(pdfContainer);
                
                // Wait for rendering
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i>Ø¥Ù†Ø´Ø§Ø¡ PDF...';
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Capture with html2canvas
                const canvas = await html2canvas(pdfContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    width: pdfContainer.scrollWidth,
                    height: pdfContainer.scrollHeight
                });
                
                // Remove container
                document.body.removeChild(pdfContainer);
                
                if (canvas && canvas.width > 0 && canvas.height > 0) {
                    const imgData = canvas.toDataURL('image/png', 0.9);
                    
                    // PDF dimensions
                    const pdfWidth = 210; // A4 width in mm
                    const pdfHeight = 297; // A4 height in mm
                    const margin = 15;
                    const contentWidth = pdfWidth - (margin * 2);
                    const contentHeight = pdfHeight - (margin * 2);
                    
                    // Calculate image dimensions
                    const imgWidth = contentWidth;
                    const imgHeight = (canvas.height * contentWidth) / canvas.width;
                    
                    // Add image to PDF, splitting across pages if needed
                    let yPosition = margin;
                    let remainingHeight = imgHeight;
                    let sourceY = 0;
                    let pageCount = 0;
                    
                    while (remainingHeight > 0) {
                        if (pageCount > 0) {
                            pdf.addPage();
                        }
                        
                        const availableHeight = contentHeight;
                        const currentPageHeight = Math.min(remainingHeight, availableHeight);
                        const sourceHeight = (currentPageHeight * canvas.width) / contentWidth;
                        
                        // Create section canvas
                        const sectionCanvas = document.createElement('canvas');
                        const sectionCtx = sectionCanvas.getContext('2d');
                        sectionCanvas.width = canvas.width;
                        sectionCanvas.height = sourceHeight;
                        
                        sectionCtx.drawImage(canvas, 0, sourceY, canvas.width, sourceHeight, 0, 0, canvas.width, sourceHeight);
                        
                        const sectionImgData = sectionCanvas.toDataURL('image/png', 0.9);
                        pdf.addImage(sectionImgData, 'PNG', margin, margin, imgWidth, currentPageHeight);
                        
                        remainingHeight -= currentPageHeight;
                        sourceY += sourceHeight;
                        pageCount++;
                    }
                    
                    // Add page numbers
                    const totalPages = pdf.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(10);
                        pdf.setTextColor(100);
                        pdf.text(`ØµÙØ­Ø© ${i} Ù…Ù† ${totalPages}`, pdfWidth - margin - 30, pdfHeight - 5);
                    }
                    
                    // Create filename
                    const examTitle = document.getElementById('examTitle').value || 'Ø§Ù…ØªØ­Ø§Ù†';
                    const subject = getSubjectText(document.getElementById('subject').value);
                    const grade = getGradeText(document.getElementById('grade').value);
                    const timestamp = new Date().toISOString().slice(0, 10);
                    const filename = `${examTitle}_${subject}_${grade}_${timestamp}.pdf`;
                    
                    // Save PDF
                    pdf.save(filename);
                    
                    showNotification(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ PDF Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ ${totalPages} ØµÙØ­Ø©! ğŸ“„âœ¨`, 'success');
                } else {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù€ PDF');
                }
                
                // Remove capturing class
                previewElement.classList.remove('capturing-images');
                
                // Reset button
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF:', error);
                showNotification(`Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF: ${error.message}`, 'error');
                
                // Remove capturing class
                const previewElement = document.getElementById('examPreview');
                if (previewElement) {
                    previewElement.classList.remove('capturing-images');
                }
                
                // Reset button
                const button = document.querySelector('button[onclick="saveToPDF()"]');
                if (button) {
                    button.innerHTML = '<i class="fas fa-file-pdf ml-1"></i>PDF Ø¹Ø§Ø¯ÙŠ';
                    button.disabled = false;
                }
            }
        }



        // Print function
        function printExam() {
            window.print();
        }

        // Copy to clipboard function
        function copyToClipboard() {
            const examPreview = document.getElementById('examPreview');
            const textContent = examPreview.innerText;
            
            navigator.clipboard.writeText(textContent).then(() => {
                alert('ØªÙ… Ù†Ø³Ø® Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­!');
            }).catch(() => {
                alert('ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰');
            });
        }

        // Toggle all marks visibility
        function toggleAllMarks() {
            const hasVisibleMarks = questions.some(q => !q.hideMarks);
            
            questions.forEach(question => {
                question.hideMarks = hasVisibleMarks;
            });
            
            updateQuestionsList();
            updatePreview();
            
            const status = hasVisibleMarks ? 'Ù…Ø®ÙÙŠØ©' : 'Ø¸Ø§Ù‡Ø±Ø©';
            showNotification(`Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¢Ù† ${status}`, 'info');
        }

        // Calculate total marks
        function calculateTotalMarks() {
            const total = questions.reduce((sum, question) => sum + (question.marks || 0), 0);
            const questionCount = questions.length;
            
            const message = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª: ${total}\nØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${questionCount}\nÙ…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„: ${questionCount > 0 ? (total / questionCount).toFixed(1) : 0}`;
            
            alert(message);
            
            // Update total marks in the form
            document.getElementById('totalMarks').value = total;
            updatePreview();
        }



        // Toggle developer menu
        function toggleDeveloperMenu() {
            const menu = document.getElementById('developerMenu');
            menu.classList.toggle('hidden');
        }

        // Close developer menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('developerMenu');
            const button = event.target.closest('button[onclick="toggleDeveloperMenu()"]');
            
            if (!button && !menu.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // ==================== MANUAL EDITING FUNCTIONS ====================

        // Toggle manual edit mode
        function toggleManualEditMode() {
            isManualEditMode = document.getElementById('enableManualEdit').checked;
            const examPreview = document.getElementById('examPreview');
            const saveBtn = document.getElementById('saveManualBtn');
            
            if (isManualEditMode) {
                examPreview.classList.add('manual-edit-mode');
                enableManualEditing();
                saveBtn.disabled = false;
                showNotification('ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±! Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Øµ Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡ ğŸ“', 'success');
            } else {
                examPreview.classList.remove('manual-edit-mode');
                disableManualEditing();
                saveBtn.disabled = true;
                closeFormatToolbar();
                showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±', 'info');
            }
        }

        // Enable manual editing
        function enableManualEditing() {
            const examPreview = document.getElementById('examPreview');
            
            // Make all text elements editable
            const textElements = examPreview.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div, td, th, li');
            textElements.forEach(element => {
                if (!element.querySelector('input, button, img')) {
                    element.classList.add('editable-element');
                    element.addEventListener('click', handleElementClick);
                    element.addEventListener('blur', handleElementBlur);
                    element.addEventListener('input', handleElementInput);
                }
            });
        }

        // Disable manual editing
        function disableManualEditing() {
            const examPreview = document.getElementById('examPreview');
            const editableElements = examPreview.querySelectorAll('.editable-element');
            
            editableElements.forEach(element => {
                element.classList.remove('editable-element', 'editing');
                element.contentEditable = false;
                element.removeEventListener('click', handleElementClick);
                element.removeEventListener('blur', handleElementBlur);
                element.removeEventListener('input', handleElementInput);
            });
            
            currentEditingElement = null;
        }

        // Handle element click for editing
        function handleElementClick(event) {
            if (!isManualEditMode) return;
            
            event.stopPropagation();
            
            // If another element is being edited, save it first
            if (currentEditingElement && currentEditingElement !== event.target) {
                finishEditing(currentEditingElement);
            }
            
            startEditing(event.target);
        }

        // Start editing an element
        function startEditing(element) {
            currentEditingElement = element;
            originalContent = element.innerHTML;
            
            element.classList.add('editing');
            element.contentEditable = true;
            element.focus();
            
            // Show format toolbar
            showFormatToolbar();
            
            // Select all text
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }

        // Handle element blur
        function handleElementBlur(event) {
            // Don't finish editing immediately, wait for potential toolbar interaction
            setTimeout(() => {
                if (currentEditingElement === event.target && !isToolbarActive()) {
                    finishEditing(event.target);
                }
            }, 200);
        }

        // Handle element input
        function handleElementInput(event) {
            hasUnsavedChanges = true;
            updateSaveButtonState();
        }

        // Finish editing an element
        function finishEditing(element) {
            if (!element) return;
            
            element.classList.remove('editing');
            element.contentEditable = false;
            
            if (element.innerHTML !== originalContent) {
                hasUnsavedChanges = true;
                updateSaveButtonState();
            }
            
            currentEditingElement = null;
            closeFormatToolbar();
        }

        // Check if toolbar is active
        function isToolbarActive() {
            const toolbar = document.getElementById('formatToolbar');
            return toolbar.classList.contains('active') && 
                   (toolbar.matches(':hover') || toolbar.contains(document.activeElement));
        }

        // Update save button state
        function updateSaveButtonState() {
            const saveBtn = document.getElementById('saveManualBtn');
            if (hasUnsavedChanges) {
                saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                saveBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
                saveBtn.innerHTML = '<i class="fas fa-exclamation-triangle ml-1"></i>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
            } else {
                saveBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                saveBtn.innerHTML = '<i class="fas fa-check ml-1"></i>Ù…Ø­ÙÙˆØ¸';
            }
        }

        // Save manual changes
        function saveManualChanges() {
            if (currentEditingElement) {
                finishEditing(currentEditingElement);
            }
            
            hasUnsavedChanges = false;
            updateSaveButtonState();
            showNotification('ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! âœ…', 'success');
        }

        // ==================== FORMAT TOOLBAR FUNCTIONS ====================

        // Show format toolbar
        function showFormatToolbar() {
            const toolbar = document.getElementById('formatToolbar');
            toolbar.classList.add('active');
        }

        // Close format toolbar
        function closeFormatToolbar() {
            const toolbar = document.getElementById('formatToolbar');
            toolbar.classList.remove('active');
        }

        // Format selected text
        function formatSelectedText(command, value = null) {
            if (!currentEditingElement) return;
            
            try {
                document.execCommand('styleWithCSS', false, true);
                
                switch (command) {
                    case 'bold':
                        document.execCommand('bold', false, null);
                        break;
                    case 'italic':
                        document.execCommand('italic', false, null);
                        break;
                    case 'underline':
                        document.execCommand('underline', false, null);
                        break;
                    case 'fontSize':
                        document.execCommand('fontSize', false, '3');
                        const fontElements = currentEditingElement.querySelectorAll('font[size="3"]');
                        fontElements.forEach(el => {
                            el.style.fontSize = value;
                            el.removeAttribute('size');
                        });
                        break;
                    case 'color':
                        document.execCommand('foreColor', false, value);
                        break;
                    case 'backgroundColor':
                        document.execCommand('backColor', false, value);
                        break;
                    case 'alignCenter':
                        currentEditingElement.style.textAlign = 'center';
                        break;
                    case 'alignRight':
                        currentEditingElement.style.textAlign = 'right';
                        break;
                    case 'alignLeft':
                        currentEditingElement.style.textAlign = 'left';
                        break;
                }
                
                hasUnsavedChanges = true;
                updateSaveButtonState();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚', 'error');
            }
        }

        // Apply quick format to selected text
        function applyQuickFormatToSelected(formatType) {
            if (!currentEditingElement) return;
            
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return;
            
            const range = selection.getRangeAt(0);
            const selectedText = range.toString();
            
            if (!selectedText) return;
            
            const span = document.createElement('span');
            span.className = `custom-${formatType}`;
            
            try {
                range.surroundContents(span);
                hasUnsavedChanges = true;
                updateSaveButtonState();
            } catch (error) {
                // Fallback: replace selection
                range.deleteContents();
                span.textContent = selectedText;
                range.insertNode(span);
                hasUnsavedChanges = true;
                updateSaveButtonState();
            }
        }

        // Clear formatting
        function clearFormatting() {
            if (!currentEditingElement) return;
            
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return;
            
            try {
                document.execCommand('removeFormat', false, null);
                hasUnsavedChanges = true;
                updateSaveButtonState();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚:', error);
            }
        }

        // ==================== FORMATTING FUNCTIONS ====================

        // Format text (for toolbar buttons)
        function formatText(command, value = null) {
            if (!isManualEditMode) {
                showNotification('ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            formatSelectedText(command, value);
        }

        // Apply quick format
        function applyQuickFormat(formatType) {
            if (!isManualEditMode) {
                showNotification('ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø£ÙˆÙ„Ø§Ù‹', 'warning');
                return;
            }
            
            if (!currentEditingElement) {
                showNotification('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Øµ Ù„Ù„ØªÙ†Ø³ÙŠÙ‚', 'warning');
                return;
            }
            
            currentEditingElement.className += ` custom-${formatType}`;
            hasUnsavedChanges = true;
            updateSaveButtonState();
            showNotification(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ØªÙ†Ø³ÙŠÙ‚ ${formatType}`, 'success');
        }

        // Apply custom CSS
        function applyCustomCSS() {
            const customCSS = document.getElementById('customCSS').value.trim();
            if (!customCSS) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ CSS', 'warning');
                return;
            }
            
            try {
                // Remove existing custom style
                const existingStyle = document.getElementById('customStyleSheet');
                if (existingStyle) {
                    existingStyle.remove();
                }
                
                // Add new custom style
                const style = document.createElement('style');
                style.id = 'customStyleSheet';
                style.textContent = customCSS;
                document.head.appendChild(style);
                
                showNotification('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ CSS Ø§Ù„Ù…Ø®ØµØµ Ø¨Ù†Ø¬Ø§Ø­! ğŸ¨', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ CSS:', error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ ÙƒÙˆØ¯ CSS. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙŠØºØ©', 'error');
            }
        }

        // Reset custom styles
        function resetCustomStyles() {
            const existingStyle = document.getElementById('customStyleSheet');
            if (existingStyle) {
                existingStyle.remove();
            }
            
            document.getElementById('customCSS').value = '';
            
            // Remove custom classes from elements
            const examPreview = document.getElementById('examPreview');
            const customElements = examPreview.querySelectorAll('[class*="custom-"]');
            customElements.forEach(element => {
                element.className = element.className.replace(/custom-\w+/g, '').trim();
            });
            
            showNotification('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø®ØµØµØ©', 'info');
        }

        // ==================== KEYBOARD SHORTCUTS ====================

        // Add keyboard shortcuts for formatting
        document.addEventListener('keydown', function(event) {
            if (!isManualEditMode || !currentEditingElement) return;
            
            // Ctrl/Cmd + shortcuts
            if (event.ctrlKey || event.metaKey) {
                switch (event.key.toLowerCase()) {
                    case 'b':
                        event.preventDefault();
                        formatSelectedText('bold');
                        break;
                    case 'i':
                        event.preventDefault();
                        formatSelectedText('italic');
                        break;
                    case 'u':
                        event.preventDefault();
                        formatSelectedText('underline');
                        break;
                    case 's':
                        event.preventDefault();
                        saveManualChanges();
                        break;
                    case 'z':
                        if (event.shiftKey) {
                            event.preventDefault();
                            // Redo functionality could be added here
                        } else {
                            event.preventDefault();
                            // Undo functionality could be added here
                        }
                        break;
                }
            }
            
            // Escape key to finish editing
            if (event.key === 'Escape') {
                if (currentEditingElement) {
                    finishEditing(currentEditingElement);
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9712237ff6125ccc',t:'MTc1NTUyNzczNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
